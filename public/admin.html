<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elysia AI - ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }
        .section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1em;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        .tab:hover {
            color: #667eea;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f8f9fa;
            color: #667eea;
            font-weight: 600;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        canvas {
            max-height: 300px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5568d3;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒŸ Elysia AI</h1>
            <p>ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</p>
        </div>

        <div class="stats-grid" id="stats">
            <div class="stat-card">
                <h3>ğŸ“Š ç·ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h3>
                <div class="value" id="totalFeedback">-</div>
            </div>
            <div class="stat-card">
                <h3>ğŸ‘ ãƒã‚¸ãƒ†ã‚£ãƒ–è©•ä¾¡</h3>
                <div class="value" id="positiveFeedback">-</div>
            </div>
            <div class="stat-card">
                <h3>ğŸ‘ æ”¹å–„è¦æœ›</h3>
                <div class="value" id="negativeFeedback">-</div>
            </div>
            <div class="stat-card">
                <h3>ğŸ“š ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹</h3>
                <div class="value" id="knowledgeCount">-</div>
            </div>
        </div>

        <!-- ãƒãƒ£ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="chart-grid">
            <div class="chart-container">
                <canvas id="endpointChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="hourlyChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="responseChart"></canvas>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('feedback')">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</button>
                <button class="tab" onclick="switchTab('knowledge')">ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹</button>
            </div>

            <div id="feedback-tab" class="tab-content active">
                <table id="feedbackTable">
                    <thead>
                        <tr>
                            <th>æ—¥æ™‚</th>
                            <th>è³ªå•</th>
                            <th>å›ç­”</th>
                            <th>è©•ä¾¡</th>
                            <th>ç†ç”±</th>
                        </tr>
                    </thead>
                    <tbody id="feedbackBody">
                        <tr><td colspan="5" class="loading">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>

            <div id="knowledge-tab" class="tab-content">
                <table id="knowledgeTable">
                    <thead>
                        <tr>
                            <th>è³ªå•</th>
                            <th>å›ç­”</th>
                            <th>ã‚½ãƒ¼ã‚¹</th>
                            <th>æ¤œè¨¼æ¸ˆã¿</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="knowledgeBody">
                        <tr><td colspan="5" class="loading">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯çµ±è¨ˆå–å¾—
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/admin/feedback/stats`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const stats = await response.json();
                
                document.getElementById('totalFeedback').textContent = stats.total || 0;
                document.getElementById('positiveFeedback').textContent = stats.upCount || 0;
                document.getElementById('negativeFeedback').textContent = stats.downCount || 0;
            } catch (err) {
                console.error('Stats load error:', err);
            }
        }

        // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ä¸€è¦§å–å¾—
        async function loadFeedback() {
            try {
                const response = await fetch(`${API_BASE}/admin/feedback`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const feedbacks = await response.json();
                
                const tbody = document.getElementById('feedbackBody');
                if (feedbacks.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                    return;
                }
                
                tbody.innerHTML = feedbacks.map(f => `
                    <tr>
                        <td>${new Date(f.createdAt).toLocaleString('ja-JP')}</td>
                        <td>${escapeHtml(f.query.substring(0, 50))}...</td>
                        <td>${escapeHtml(f.answer.substring(0, 50))}...</td>
                        <td><span class="badge badge-${f.rating === 'up' ? 'success' : 'danger'}">${f.rating === 'up' ? 'ğŸ‘ Good' : 'ğŸ‘ Bad'}</span></td>
                        <td>${escapeHtml(f.reason || '-')}</td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('Feedback load error:', err);
                document.getElementById('feedbackBody').innerHTML = '<tr><td colspan="5" class="empty">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>';
            }
        }

        // ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ä¸€è¦§å–å¾—
        async function loadKnowledge() {
            try {
                const response = await fetch(`${API_BASE}/admin/knowledge`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const knowledge = await response.json();
                
                document.getElementById('knowledgeCount').textContent = knowledge.length;
                
                const tbody = document.getElementById('knowledgeBody');
                if (knowledge.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty">ãƒŠãƒ¬ãƒƒã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                    return;
                }
                
                tbody.innerHTML = knowledge.map(k => `
                    <tr>
                        <td>${escapeHtml(k.question.substring(0, 50))}</td>
                        <td>${escapeHtml(k.answer.substring(0, 50))}</td>
                        <td>${k.source || '-'}</td>
                        <td><span class="badge badge-${k.verified ? 'success' : 'danger'}">${k.verified ? 'âœ“ æ¤œè¨¼æ¸ˆã¿' : 'âœ— æœªæ¤œè¨¼'}</span></td>
                        <td>
                            ${!k.verified ? `<button class="btn btn-primary" onclick="verifyKnowledge('${k.id}')">æ¤œè¨¼ã™ã‚‹</button>` : ''}
                            <button class="btn btn-danger" onclick="deleteKnowledge('${k.id}')">å‰Šé™¤</button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('Knowledge load error:', err);
                document.getElementById('knowledgeBody').innerHTML = '<tr><td colspan="5" class="empty">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>';
            }
        }

        // ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã¨é€£æºï¼‰
        function getToken() {
            return localStorage.getItem('adminToken') || 'demo-token';
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // åˆæœŸèª­ã¿è¾¼ã¿
        window.addEventListener('load', async () => {
            loadStats();
            loadFeedback();
            loadKnowledge();
            await loadCharts();
        });

        // ãƒãƒ£ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
        async function loadCharts() {
            try {
                // APIä½¿ç”¨çµ±è¨ˆã‚’å–å¾—
                const analyticsRes = await fetch(`${API_BASE}/admin/analytics`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const analytics = await analyticsRes.json();

                // ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆåˆ¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ï¼ˆæ£’ã‚°ãƒ©ãƒ•ï¼‰
                const endpointCtx = document.getElementById('endpointChart');
                if (endpointCtx) {
                    new Chart(endpointCtx, {
                        type: 'bar',
                        data: {
                            labels: analytics.topEndpoints.map(e => e.endpoint),
                            datasets: [{
                                label: 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°',
                                data: analytics.topEndpoints.map(e => e.count),
                                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                                borderColor: 'rgba(102, 126, 234, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: { display: true, text: 'ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆåˆ¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°' }
                            }
                        }
                    });
                }

                // æ™‚é–“åˆ¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ï¼ˆæŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ï¼‰
                const hourlyCtx = document.getElementById('hourlyChart');
                if (hourlyCtx && analytics.hourlyPattern) {
                    const hours = Object.keys(analytics.hourlyPattern).sort((a, b) => Number(a) - Number(b));
                    new Chart(hourlyCtx, {
                        type: 'line',
                        data: {
                            labels: hours.map(h => `${h}:00`),
                            datasets: [{
                                label: 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°',
                                data: hours.map(h => analytics.hourlyPattern[h]),
                                backgroundColor: 'rgba(118, 75, 162, 0.2)',
                                borderColor: 'rgba(118, 75, 162, 1)',
                                borderWidth: 2,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: { display: true, text: 'æ™‚é–“åˆ¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¨ç§»' }
                            }
                        }
                    });
                }

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ åˆ†å¸ƒï¼ˆå††ã‚°ãƒ©ãƒ•ï¼‰
                const responseCtx = document.getElementById('responseChart');
                if (responseCtx && analytics.responseTimeDistribution) {
                    const dist = analytics.responseTimeDistribution;
                    new Chart(responseCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['< 100ms', '100-500ms', '500ms-1s', '> 1s'],
                            datasets: [{
                                data: [
                                    dist['<100ms'] || 0,
                                    dist['100-500ms'] || 0,
                                    dist['500ms-1s'] || 0,
                                    dist['>1s'] || 0
                                ],
                                backgroundColor: [
                                    'rgba(75, 192, 192, 0.8)',
                                    'rgba(255, 206, 86, 0.8)',
                                    'rgba(255, 159, 64, 0.8)',
                                    'rgba(255, 99, 132, 0.8)'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: { display: true, text: 'ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ åˆ†å¸ƒ' }
                            }
                        }
                    });
                }
            } catch (err) {
                console.error('Charts load error:', err);
            }
        }
    </script>
</body>
</html>
