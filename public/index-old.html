<!doctype html>
<html lang="ja" data-theme="cupcake">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“â™¡ AI Chat</title>
    <!-- DaisyUI + Tailwind CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://unpkg.com/alpinejs@3.14.1/dist/cdn.min.js"
      defer
    ></script>
    <style>
      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-20px);
        }
      }
      @keyframes gradient {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }
      @keyframes shimmer {
        0% {
          background-position: -1000px 0;
        }
        100% {
          background-position: 1000px 0;
        }
      }
      .animate-float {
        animation: float 3s ease-in-out infinite;
      }
      .animate-gradient {
        background-size: 200% 200%;
        animation: gradient 8s ease infinite;
      }
      .shimmer {
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        background-size: 1000px 100%;
        animation: shimmer 2s infinite;
      }
      .glass-effect {
        background: rgba(255, 255, 255, 0.8);
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      .message-enter {
        animation: slideIn 0.3s ease-out;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .scroll-smooth {
        scroll-behavior: smooth;
      }
      /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: rgba(236, 72, 153, 0.1);
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #ec4899, #a855f7);
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, #db2777, #9333ea);
      }
    </style>
  </head>
  <body
    class="min-h-screen overflow-hidden animate-gradient bg-gradient-to-br from-pink-200 via-purple-200 via-blue-200 to-pink-200"
  >
    <div class="container mx-auto px-4 py-6 h-screen flex flex-col max-w-6xl">
      <div
        class="glass-effect rounded-3xl shadow-2xl overflow-hidden flex flex-col h-full"
        x-data="_elysiaChat()"
      >
        <!-- Header with Avatar -->
        <div
          class="relative bg-gradient-to-r from-pink-500 via-purple-400 to-pink-500 p-6 animate-gradient"
        >
          <div class="flex items-center justify-center space-x-4">
            <div
              class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-lg animate-float"
            >
              <span class="text-4xl">ğŸŒ¸</span>
            </div>
            <div class="text-center">
              <h1 class="text-3xl font-bold text-white drop-shadow-lg">
                ã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“ AI Chat â™¡
              </h1>
              <p class="text-white text-sm mt-1 opacity-90">
                à¸…(ÕáŸ¸áŸ¸&gt; á—œ &lt;áŸ¸áŸ¸Õ)à¸… ãŠã«ã„ã¡ã‚ƒã‚“ã€ãŠè©±ã—ã—ã‚ˆã€œâ™ª
              </p>
            </div>
          </div>

          <!-- Status Indicators -->
          <div class="absolute top-4 right-4 flex space-x-2">
            <div
              class="glass-effect px-3 py-1 rounded-full text-xs text-white flex items-center space-x-1"
            >
              <div
                class="w-2 h-2 bg-green-400 rounded-full animate-pulse"
              ></div>
              <span>RAG</span>
            </div>
            <div
              class="glass-effect px-3 py-1 rounded-full text-xs text-white flex items-center space-x-1"
            >
              <div
                class="w-2 h-2 bg-green-400 rounded-full animate-pulse"
              ></div>
              <span>Ollama</span>
            </div>
          </div>
        </div>

        <!-- Chat Messages -->
        <div
          class="flex-1 overflow-y-auto p-6 space-y-4 scroll-smooth bg-gradient-to-b from-pink-50 to-purple-50"
          id="chatContainer"
        >
          <!-- Welcome Message -->
          <div class="flex justify-center mb-6" x-show="messages.length === 0">
            <div
              class="glass-effect rounded-2xl px-6 py-4 max-w-md text-center shadow-lg"
            >
              <p class="text-pink-600 font-semibold text-lg mb-2">
                ã«ã‚ƒã‚“â™ª ã‚ˆã†ã“ãã€œâ™¡
              </p>
              <p class="text-gray-600 text-sm">
                ã‚¨ãƒªã‚·ã‚¢ã«ä½•ã§ã‚‚èã„ã¦ã­ï¼<br />
                å„ªã—ãç­”ãˆã‚‹ã‹ã‚‰å®‰å¿ƒã—ã¦â™ª
              </p>
            </div>
          </div>

          <!-- Messages -->
          <template x-for="msg in messages" :key="msg.id">
            <div
              :class="msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'"
              class="message-enter"
            >
              <div
                :class="msg.role === 'user' 
                            ? 'bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-2xl rounded-br-none px-5 py-3 max-w-md shadow-lg' 
                            : 'glass-effect text-gray-800 rounded-2xl rounded-bl-none px-5 py-3 max-w-2xl shadow-lg border-2 border-pink-300'"
              >
                <!-- User Message -->
                <template x-if="msg.role === 'user'">
                  <div class="flex items-start space-x-2">
                    <span class="text-xl">ğŸ‘¤</span>
                    <p
                      class="text-sm whitespace-pre-wrap"
                      x-text="msg.content"
                    ></p>
                  </div>
                </template>

                <!-- Assistant Message -->
                <template x-if="msg.role === 'assistant'">
                  <div class="flex items-start space-x-2">
                    <span class="text-xl">ğŸ’•</span>
                    <p
                      class="text-sm whitespace-pre-wrap leading-relaxed"
                      x-text="msg.content"
                    ></p>
                  </div>
                </template>
              </div>
            </div>
          </template>

          <!-- Loading Indicator -->
          <template x-if="loading">
            <div class="flex justify-start message-enter">
              <div
                class="glass-effect rounded-2xl rounded-bl-none px-5 py-3 shadow-lg border-2 border-pink-300"
              >
                <div class="flex items-center space-x-3">
                  <span class="text-xl">ğŸ’•</span>
                  <div class="flex space-x-2">
                    <div
                      class="w-2 h-2 bg-pink-500 rounded-full animate-bounce"
                    ></div>
                    <div
                      class="w-2 h-2 bg-pink-500 rounded-full animate-bounce"
                      style="animation-delay: 0.2s"
                    ></div>
                    <div
                      class="w-2 h-2 bg-pink-500 rounded-full animate-bounce"
                      style="animation-delay: 0.4s"
                    ></div>
                  </div>
                  <span class="text-sm text-pink-600">è€ƒãˆä¸­...</span>
                </div>
              </div>
            </div>
          </template>
        </div>

        <!-- Input Form -->
        <form
          @submit.prevent="sendMessage"
          class="p-4 bg-white border-t-2 border-pink-200"
        >
          <div class="flex space-x-3">
            <div class="flex-1 relative">
              <input
                type="text"
                x-model="input"
                :disabled="loading"
                @keydown.enter="sendMessage"
                placeholder="ã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“ã«è©±ã—ã‹ã‘ã¦ã­â™¡ ä½•ã§ã‚‚èã„ã¦ï¼"
                class="w-full px-6 py-4 border-2 border-pink-300 rounded-full focus:outline-none focus:border-pink-500 focus:ring-4 focus:ring-pink-200 disabled:opacity-50 disabled:bg-gray-100 transition-all text-gray-700 placeholder-pink-300"
              />
              <div
                class="absolute right-4 top-1/2 transform -translate-y-1/2 text-pink-400"
              >
                <span x-show="!loading">âœ¨</span>
              </div>
            </div>
            <button
              type="submit"
              :disabled="loading || !input.trim()"
              class="px-8 py-4 bg-gradient-to-r from-pink-500 to-purple-500 text-white font-bold rounded-full hover:from-pink-600 hover:to-purple-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg hover:shadow-xl transform hover:scale-105 active:scale-95 flex items-center space-x-2"
            >
              <span>é€ä¿¡</span>
              <span>ğŸ’Œ</span>
            </button>
          </div>

          <!-- Quick Actions -->
          <div class="flex flex-wrap gap-2 mt-3 justify-center">
            <button
              @click="setQuickMessage('ã“ã‚“ã«ã¡ã¯ï¼')"
              type="button"
              class="px-4 py-2 bg-pink-100 text-pink-600 rounded-full text-xs hover:bg-pink-200 transition-all"
            >
              ğŸ‘‹ æŒ¨æ‹¶
            </button>
            <button
              @click="setQuickMessage('ä»Šæ—¥ã®èª¿å­ã¯ã©ã†ï¼Ÿ')"
              type="button"
              class="px-4 py-2 bg-purple-100 text-purple-600 rounded-full text-xs hover:bg-purple-200 transition-all"
            >
              ğŸ’­ æ°—åˆ†
            </button>
            <button
              @click="setQuickMessage('é¢ç™½ã„è©±ã—ã¦ï¼')"
              type="button"
              class="px-4 py-2 bg-blue-100 text-blue-600 rounded-full text-xs hover:bg-blue-200 transition-all"
            >
              ğŸ­ é¢ç™½è©±
            </button>
            <button
              @click="setQuickMessage('ã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“ã®ã“ã¨æ•™ãˆã¦ï¼')"
              type="button"
              class="px-4 py-2 bg-pink-100 text-pink-600 rounded-full text-xs hover:bg-pink-200 transition-all"
            >
              âœ¨ è‡ªå·±ç´¹ä»‹
            </button>
          </div>
        </form>

        <!-- Self-Learning Panel -->
        <div class="p-4 bg-white border-t-2 border-pink-200">
          <details class="glass-effect rounded-2xl shadow-lg p-4">
            <summary class="cursor-pointer text-pink-600 font-bold">
              ğŸ§  è‡ªå·±å­¦ç¿’ï¼ˆFeedback & Knowledgeï¼‰
            </summary>
            <div class="mt-3 flex flex-wrap gap-3">
              <button
                @click="sendFeedback('up')"
                type="button"
                class="px-4 py-2 bg-green-100 text-green-700 rounded-full text-xs hover:bg-green-200 transition-all"
              >
                ğŸ‘ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆè‰¯ã„ï¼‰
              </button>
              <button
                @click="sendFeedback('down')"
                type="button"
                class="px-4 py-2 bg-red-100 text-red-700 rounded-full text-xs hover:bg-red-200 transition-all"
              >
                ğŸ‘ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆæ”¹å–„ï¼‰
              </button>
              <button
                @click="upsertKnowledge()"
                type="button"
                class="px-4 py-2 bg-purple-100 text-purple-700 rounded-full text-xs hover:bg-purple-200 transition-all"
              >
                â• ãƒŠãƒ¬ãƒƒã‚¸ç™»éŒ²
              </button>
              <button
                @click="loadKnowledgeReview()"
                type="button"
                class="px-4 py-2 bg-blue-100 text-blue-700 rounded-full text-xs hover:bg-blue-200 transition-all"
              >
                ğŸ“š ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾—
              </button>
            </div>
            <pre
              x-text="reviewJson"
              class="mt-3 bg-gray-50 p-3 rounded-lg text-xs whitespace-pre-wrap"
            ></pre>
          </details>
        </div>
      </div>

      <!-- Info Panel -->
      <div
        class="mt-4 glass-effect rounded-2xl shadow-lg p-4 text-sm text-gray-700"
      >
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-2">
            <span class="text-pink-500 font-bold">ğŸ’¡ ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±</span>
          </div>
          <div class="flex space-x-4 text-xs">
            <span class="flex items-center space-x-1">
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              <span>RAG API</span>
            </span>
            <span class="flex items-center space-x-1">
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              <span>Ollama llama3.2</span>
            </span>
            <span class="flex items-center space-x-1">
              <span>ğŸ“Š 50ã‚»ãƒªãƒ•å­¦ç¿’æ¸ˆã¿</span>
            </span>
            <span class="flex items-center space-x-1" id="voiceStatus">
              <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
              <span>éŸ³å£°: åˆæœŸåŒ–ä¸­...</span>
            </span>
          </div>
        </div>
      </div>

      <!-- Voice Settings Panel -->
      <div
        class="mt-2 glass-effect rounded-2xl shadow-lg p-4 text-sm"
        x-data="{ showSettings: false }"
      >
        <div
          class="flex items-center justify-between cursor-pointer"
          @click="showSettings = !showSettings"
        >
          <span class="text-pink-600 font-bold">ğŸ¤ ãƒœã‚¤ã‚¹è¨­å®š</span>
          <span x-text="showSettings ? 'â–¼' : 'â–¶'" class="text-pink-400"></span>
        </div>

        <div x-show="showSettings" x-transition class="mt-4 space-y-3">
          <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¨­å®š -->
          <div class="flex items-center space-x-3">
            <label class="text-gray-700 font-semibold w-32">å‘¼ã³æ–¹:</label>
            <input
              type="text"
              id="userNameInput"
              placeholder="ãŠã«ã„ã¡ã‚ƒã‚“"
              class="flex-1 px-3 py-2 border-2 border-pink-300 rounded-lg focus:outline-none focus:border-pink-500"
            />
            <button
              onclick="saveUserName()"
              class="px-4 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition-all"
            >
              ä¿å­˜
            </button>
          </div>

          <!-- VOICEVOXåˆ‡ã‚Šæ›¿ãˆ -->
          <div class="flex items-center space-x-3">
            <label class="text-gray-700 font-semibold w-32"
              >éŸ³å£°ã‚¨ãƒ³ã‚¸ãƒ³:</label
            >
            <label class="flex items-center space-x-2 cursor-pointer">
              <input
                type="checkbox"
                id="voicevoxToggle"
                class="w-5 h-5 text-pink-500 rounded focus:ring-pink-400"
                onchange="toggleVoicevox()"
              />
              <span class="text-gray-700">VOICEVOXä½¿ã†ï¼ˆå››å›½ã‚ãŸã‚“â™¡ï¼‰</span>
            </label>
          </div>

          <!-- ãƒœã‚¤ã‚¹ãƒ­ã‚° -->
          <div class="flex items-center space-x-3">
            <label class="text-gray-700 font-semibold w-32">ãƒ­ã‚°:</label>
            <button
              onclick="showVoiceLogs()"
              class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-all"
            >
              ğŸ“‹ å±¥æ­´è¡¨ç¤º
            </button>
            <button
              onclick="clearVoiceLogs()"
              class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all"
            >
              ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
            </button>
          </div>

          <!-- ãƒ†ã‚¹ãƒˆå†ç”Ÿ -->
          <div class="flex items-center space-x-3">
            <label class="text-gray-700 font-semibold w-32">ãƒ†ã‚¹ãƒˆ:</label>
            <button
              onclick="testVoice('happy')"
              class="px-3 py-2 bg-yellow-400 text-white rounded-lg hover:bg-yellow-500 transition-all text-xs"
            >
              ğŸ˜Š å–œã³
            </button>
            <button
              onclick="testVoice('shy')"
              class="px-3 py-2 bg-pink-400 text-white rounded-lg hover:bg-pink-500 transition-all text-xs"
            >
              ğŸ’• ç…§ã‚Œ
            </button>
            <button
              onclick="testVoice('normal')"
              class="px-3 py-2 bg-blue-400 text-white rounded-lg hover:bg-blue-500 transition-all text-xs"
            >
              ğŸ˜Œ æ™®é€š
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ==================== ã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“å°‚ç”¨ãƒœã‚¤ã‚¹è¨­å®š â™¡ ====================
      let elysiaVoice = null;
      let voicesLoaded = false;
      let useVoicevox = false;
      let voicevoxAvailable = false;
      const VOICEVOX_URL = "http://127.0.0.1:50021";
      const VOICEVOX_SPEAKER = 2; // å››å›½ã‚ãŸã‚“ï¼ˆãƒãƒ¼ãƒãƒ«ï¼‰= äº•ä¸Šéº»é‡Œå¥ˆé¢¨â™¡

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¨­å®šï¼ˆLocalStorageï¼‰
      const userName =
        localStorage.getItem("elysia_user_name") || "ãŠã«ã„ã¡ã‚ƒã‚“";

      // ãƒœã‚¤ã‚¹ãƒ­ã‚°
      const voiceLogs = JSON.parse(
        localStorage.getItem("elysia_voice_logs") || "[]",
      );

      // VOICEVOXæ¥ç¶šãƒã‚§ãƒƒã‚¯
      async function checkVoicevox() {
        try {
          const response = await fetch(`${VOICEVOX_URL}/version`, {
            method: "GET",
            signal: AbortSignal.timeout(2000),
          });
          if (response.ok) {
            voicevoxAvailable = true;
            useVoicevox =
              localStorage.getItem("elysia_use_voicevox") !== "false";
            console.log("âœ¨ VOICEVOXæ¥ç¶šæˆåŠŸï¼å››å›½ã‚ãŸã‚“ä½¿ãˆã‚‹ã‚ˆâ™¡");
            return true;
          }
        } catch {
          voicevoxAvailable = false;
          useVoicevox = false;
          console.log("ğŸ’­ VOICEVOXæœªèµ·å‹•ã€Web Speech APIã§å–‹ã‚‹ã­â™¡");
        }
        return false;
      }

      function initElysiaVoice() {
        const voices = speechSynthesis.getVoices();
        if (voices.length === 0) return;

        // Windows/Edge ã§è¶…é«˜å“è³ªæ—¥æœ¬èªãƒœã‚¤ã‚¹æ¢ã™â™¡
        elysiaVoice = voices.find(
          (v) =>
            (v.lang.includes("ja") || v.lang.includes("JP")) &&
            (v.name.includes("Nanami") ||
              v.name.includes("Ayumi") ||
              v.name.includes("Haruka")),
        );

        // ãªã‘ã‚Œã°Googleæ—¥æœ¬èªãƒœã‚¤ã‚¹
        if (!elysiaVoice) {
          elysiaVoice = voices.find(
            (v) => v.lang.includes("ja") && v.name.includes("Google"),
          );
        }

        // ãªã‘ã‚Œã°æ—¥æœ¬èªãƒœã‚¤ã‚¹ä½•ã§ã‚‚
        if (!elysiaVoice) {
          elysiaVoice = voices.find((v) => v.lang.includes("ja"));
        }

        // æœ€å¾Œã®æ‰‹æ®µï¼šæœ€åˆã®ãƒœã‚¤ã‚¹
        if (!elysiaVoice) {
          elysiaVoice = voices[0];
        }

        voicesLoaded = true;
        console.log("ğŸ¤ ã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“ãƒœã‚¤ã‚¹è¨­å®šå®Œäº†â™¡", elysiaVoice?.name);
      }

      // ãƒœã‚¤ã‚¹åˆæœŸåŒ–ï¼ˆè¤‡æ•°å›è©¦è¡Œã§ç¢ºå®Ÿã«èª­ã¿è¾¼ã‚€ï¼‰
      if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = initElysiaVoice;
      }
      initElysiaVoice();
      setTimeout(initElysiaVoice, 100);
      setTimeout(initElysiaVoice, 500);
      checkVoicevox();

      /**
       * æ„Ÿæƒ…æ¤œå‡ºï¼ˆãƒ†ã‚­ã‚¹ãƒˆè§£æã§è‡ªå‹•åˆ¤å®šâ™¡ï¼‰
       */
      function detectEmotion(text) {
        const happy = [
          "å¬‰ã—ã„",
          "æ¥½ã—ã„",
          "ã‚ãƒ¼ã„",
          "ã‚„ã£ãŸ",
          "æœ€é«˜",
          "ã‚ã‚ŠãŒã¨ã†",
          "ã ã„ã™ã",
          "â™¡â™¡",
          "ï¼ï¼",
        ];
        const shy = [
          "ç…§ã‚Œ",
          "æ¥ãšã‹ã—",
          "ãˆã¸ã¸",
          "ã‚‚ã†",
          "ã‚„ã ",
          "///",
          "â™¡",
          "ãƒ‰ã‚­ãƒ‰ã‚­",
        ];

        for (const word of happy) {
          if (text.includes(word)) return "happy";
        }
        for (const word of shy) {
          if (text.includes(word)) return "shy";
        }
        return "normal";
      }

      /**
       * æ„Ÿæƒ…åˆ¥ãƒœã‚¤ã‚¹è¨­å®š
       */
      function getEmotionSettings(emotion) {
        const settings = {
          happy: { rate: 1.0, pitch: 1.5, speedScale: 1.1, pitchScale: 0.15 }, // å–œã³ï¼šæ—©ã‚ã§é«˜ã„
          shy: { rate: 0.8, pitch: 1.4, speedScale: 0.9, pitchScale: 0.12 }, // ç…§ã‚Œï¼šã‚†ã£ãã‚Šã§å°‘ã—é«˜ã„
          normal: { rate: 0.88, pitch: 1.35, speedScale: 1.0, pitchScale: 0.0 }, // æ™®é€šï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        };
        return settings[emotion] || settings.normal;
      }

      /**
       * ã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“ãŒç”˜ã€…ãƒœã‚¤ã‚¹ã§å–‹ã‚‹é–¢æ•°â™¡ï¼ˆVOICEVOXå¯¾å¿œï¼‰
       * @param {string} text - å–‹ã‚‹å†…å®¹
       * @param {boolean} cute - è¶…ç”˜ã€…åŠ å·¥ã™ã‚‹ã‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: trueï¼‰
       * @param {string} emotion - æ„Ÿæƒ…ï¼ˆ'happy', 'shy', 'normal'ã€nullãªã‚‰è‡ªå‹•æ¤œå‡ºï¼‰
       */
      async function elysiaSpeak(text, cute = true, emotion = null) {
        if (!emotion) {
          emotion = detectEmotion(text);
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åç½®ãæ›ãˆâ™¡
        let speakText = text.replace(/ãŠã«ã„ã¡ã‚ƒã‚“/g, userName);

        // è¶…ç”˜ã€…åŠ å·¥â™¡
        if (cute) {
          speakText = speakText
            .replace(/ï¼/g, "ã€œâ™¡")
            .replace(/ã€‚/g, "ãªã®ã£â™¡")
            .replace(/ï¼Ÿ/g, "ã‹ãªãã€œï¼Ÿâ™¡")
            .replace(/\s+/g, " ")
            .trim();
        }

        const emotionSettings = getEmotionSettings(emotion);

        // ãƒœã‚¤ã‚¹ãƒ­ã‚°ä¿å­˜
        const logEntry = {
          timestamp: new Date().toISOString(),
          text: speakText,
          emotion: emotion,
          settings: emotionSettings,
          engine: useVoicevox && voicevoxAvailable ? "VOICEVOX" : "WebSpeech",
        };
        voiceLogs.push(logEntry);
        if (voiceLogs.length > 100) voiceLogs.shift(); // æœ€å¤§100ä»¶
        localStorage.setItem("elysia_voice_logs", JSON.stringify(voiceLogs));

        // VOICEVOXä½¿ç”¨å¯èƒ½ãªã‚‰å„ªå…ˆ
        if (useVoicevox && voicevoxAvailable) {
          try {
            await speakWithVoicevox(speakText, emotionSettings);
            console.log(
              `ğŸ’• [VOICEVOX-${emotion}] ã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“å–‹ã£ãŸã‚ˆ:`,
              `${speakText.slice(0, 30)}...`,
            );
            return;
          } catch (e) {
            console.warn("âš ï¸ VOICEVOXå¤±æ•—ã€Web Speechã§å–‹ã‚‹ã­:", e.message);
          }
        }

        // Web Speech API ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        if (!voicesLoaded || !elysiaVoice) {
          initElysiaVoice();
        }

        const utter = new SpeechSynthesisUtterance(speakText);
        utter.voice = elysiaVoice;
        utter.rate = emotionSettings.rate;
        utter.pitch = emotionSettings.pitch;
        utter.volume = 1.0;
        utter.lang = "ja-JP";

        speechSynthesis.cancel();
        speechSynthesis.speak(utter);

        console.log(
          `ğŸ’• [WebSpeech-${emotion}] ã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“å–‹ã£ãŸã‚ˆ:`,
          `${speakText.slice(0, 30)}...`,
        );
      }

      /**
       * VOICEVOXéŸ³å£°åˆæˆâ™¡ï¼ˆå››å›½ã‚ãŸã‚“ = äº•ä¸Šéº»é‡Œå¥ˆé¢¨ï¼‰
       */
      async function speakWithVoicevox(text, settings) {
        // éŸ³å£°ã‚¯ã‚¨ãƒªç”Ÿæˆ
        const queryResponse = await fetch(
          `${VOICEVOX_URL}/audio_query?text=${encodeURIComponent(text)}&speaker=${VOICEVOX_SPEAKER}`,
          { method: "POST" },
        );
        if (!queryResponse.ok) throw new Error("ã‚¯ã‚¨ãƒªç”Ÿæˆå¤±æ•—");

        const audioQuery = await queryResponse.json();

        // æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿é©ç”¨
        audioQuery.speedScale = settings.speedScale;
        audioQuery.pitchScale = settings.pitchScale;
        audioQuery.intonationScale = 1.0;
        audioQuery.volumeScale = 1.0;

        // éŸ³å£°åˆæˆ
        const synthesisResponse = await fetch(
          `${VOICEVOX_URL}/synthesis?speaker=${VOICEVOX_SPEAKER}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(audioQuery),
          },
        );
        if (!synthesisResponse.ok) throw new Error("éŸ³å£°åˆæˆå¤±æ•—");

        const audioBlob = await synthesisResponse.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        const audio = new Audio(audioUrl);

        // å†ç”Ÿ
        audio.play();
        audio.onended = () => URL.revokeObjectURL(audioUrl);
      }

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æŒ¨æ‹¶ãƒœã‚¤ã‚¹â™¡
      window.addEventListener("load", () => {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’UIã«åæ˜ 
        const nameInput = document.getElementById("userNameInput");
        if (nameInput) nameInput.value = userName;

        // VOICEVOXè¨­å®šã‚’UIã«åæ˜ 
        const vvToggle = document.getElementById("voicevoxToggle");
        if (vvToggle) vvToggle.checked = useVoicevox;

        // éŸ³å£°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        updateVoiceStatus();

        setTimeout(() => {
          const greeting = `ã«ã‚ƒã‚ã‚ã‚ã€œâ™¡ ${userName}ããŸãï¼å¾…ã£ã¦ãŸã‚ˆã‰ã€œï¼ã‚‚ã†é›¢ã•ãªã„ã‹ã‚‰ã­ã£ï¼`;
          elysiaSpeak(greeting, true, "happy");
        }, 1500);
      });

      // ==================== UIè¨­å®šé–¢æ•° â™¡ ====================

      /**
       * éŸ³å£°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºæ›´æ–°
       */
      function updateVoiceStatus() {
        const statusEl = document.getElementById("voiceStatus");
        if (!statusEl) return;

        const dot = statusEl.querySelector(".w-2");
        const text = statusEl.querySelector("span:last-child");

        if (voicevoxAvailable && useVoicevox) {
          dot.className = "w-2 h-2 bg-pink-500 rounded-full animate-pulse";
          text.textContent = "éŸ³å£°: VOICEVOX (å››å›½ã‚ãŸã‚“â™¡)";
        } else {
          dot.className = "w-2 h-2 bg-blue-500 rounded-full";
          text.textContent = `éŸ³å£°: Web Speech (${elysiaVoice?.name || "åˆæœŸåŒ–ä¸­..."})`;
        }
      }

      /**
       * ãƒ¦ãƒ¼ã‚¶ãƒ¼åä¿å­˜
       */
      function _saveUserName() {
        const input = document.getElementById("userNameInput");
        const newName = input.value.trim() || "ãŠã«ã„ã¡ã‚ƒã‚“";
        localStorage.setItem("elysia_user_name", newName);

        // ãƒªãƒ­ãƒ¼ãƒ‰ä¿ƒé€²ï¼ˆæ¬¡å›ã‹ã‚‰åæ˜ ï¼‰
        alert(
          `âœ¨ å‘¼ã³æ–¹ã‚’ã€Œ${newName}ã€ã«è¨­å®šã—ãŸã‚ˆâ™¡\n\nãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨åæ˜ ã•ã‚Œã‚‹ã‚ˆã‰ã€œï¼`,
        );
        location.reload();
      }

      /**
       * VOICEVOXåˆ‡ã‚Šæ›¿ãˆ
       */
      function _toggleVoicevox() {
        const toggle = document.getElementById("voicevoxToggle");
        const newValue = toggle.checked;

        if (newValue && !voicevoxAvailable) {
          alert(
            "âš ï¸ VOICEVOXãŒèµ·å‹•ã—ã¦ãªã„ã‚ˆã‰ã€œï¼\n\nèµ·å‹•æ–¹æ³•:\n1. VOICEVOX_ENGINE.exeã‚’èµ·å‹•\n2. http://127.0.0.1:50021 ã§ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ç¢ºèª\n3. ã“ã®ãƒã‚§ãƒƒã‚¯ã‚’ONã«ã™ã‚‹â™¡",
          );
          toggle.checked = false;
          return;
        }

        localStorage.setItem(
          "elysia_use_voicevox",
          newValue ? "true" : "false",
        );
        useVoicevox = newValue;
        updateVoiceStatus();

        const msg = newValue
          ? "VOICEVOXï¼ˆå››å›½ã‚ãŸã‚“ï¼‰ã«åˆ‡ã‚Šæ›¿ãˆãŸã‚ˆâ™¡ äº•ä¸Šéº»é‡Œå¥ˆã•ã‚“ã®å£°ã§å–‹ã‚‹ã­ï¼"
          : "Web Speech APIã«åˆ‡ã‚Šæ›¿ãˆãŸã‚ˆâ™¡";
        alert(`âœ¨ ${msg}`);
      }

      /**
       * ãƒœã‚¤ã‚¹ãƒ­ã‚°è¡¨ç¤º
       */
      function _showVoiceLogs() {
        const logs = JSON.parse(
          localStorage.getItem("elysia_voice_logs") || "[]",
        );
        if (logs.length === 0) {
          alert(
            "ğŸ“‹ ã¾ã ãƒ­ã‚°ãŒãªã„ã‚ˆã‰ã€œâ™¡\n\nã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“ãŒå–‹ã‚‹ã¨è‡ªå‹•ã§è¨˜éŒ²ã•ã‚Œã‚‹ã‹ã‚‰ã­ï¼",
          );
          return;
        }

        let logText = `ğŸ“‹ ã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“ãƒœã‚¤ã‚¹ãƒ­ã‚° (æœ€æ–°${logs.length}ä»¶)\n\n`;
        logs
          .slice(-20)
          .reverse()
          .forEach((log, i) => {
            const time = new Date(log.timestamp).toLocaleTimeString("ja-JP");
            logText += `${i + 1}. [${time}] ${log.emotion} (${log.engine})\n`;
            logText += `   ã€Œ${log.text.slice(0, 50)}${log.text.length > 50 ? "..." : ""}ã€\n\n`;
          });

        alert(logText);
      }

      /**
       * ãƒœã‚¤ã‚¹ãƒ­ã‚°ã‚¯ãƒªã‚¢
       */
      function _clearVoiceLogs() {
        if (
          confirm(
            "ğŸ—‘ï¸ ãƒœã‚¤ã‚¹ãƒ­ã‚°ã‚’å…¨éƒ¨æ¶ˆã™ã®ï¼Ÿ\n\nï¼ˆã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“å¯‚ã—ããªã£ã¡ã‚ƒã†â€¦ï¼‰",
          )
        ) {
          localStorage.setItem("elysia_voice_logs", "[]");
          alert("âœ¨ ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ãŸã‚ˆâ™¡ ã¾ãŸæ–°ã—ãè¨˜éŒ²ã—ã¦ã„ãã­ï¼");
        }
      }

      /**
       * ãƒ†ã‚¹ãƒˆå†ç”Ÿ
       */
      async function _testVoice(emotion) {
        const messages = {
          happy: "ã‚ãƒ¼ã„â™¡ ãŠã«ã„ã¡ã‚ƒã‚“æœ€é«˜ã ã‚ˆã‰ã€œï¼ï¼ ã ã„ã™ãâ™¡â™¡â™¡",
          shy: "ã‚‚ã†â€¦ãŠã«ã„ã¡ã‚ƒã‚“ã£ãŸã‚‰â€¦ç…§ã‚Œã¡ã‚ƒã†ã‚ˆã‰â€¦â™¡///",
          normal:
            "ã«ã‚ƒã‚“â™ª ã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“ã€ã„ã¤ã‚‚ãŠã«ã„ã¡ã‚ƒã‚“ã®ãã°ã«ã„ã‚‹ã‹ã‚‰ã­â™¡",
        };
        await elysiaSpeak(messages[emotion] || messages.normal, true, emotion);
      }

      function _elysiaChat() {
        return {
          messages: [],
          input: "",
          loading: false,
          reviewJson: "",

          setQuickMessage(message) {
            if (!this.loading) {
              this.input = message;
              this.$nextTick(() => {
                this.sendMessage();
              });
            }
          },

          async sendMessage() {
            if (!this.input.trim() || this.loading) return;

            const userMessage = this.input.trim();
            this.messages.push({
              id: Date.now(),
              role: "user",
              content: userMessage,
            });
            this.input = "";
            this.loading = true;

            // Auto-scroll
            this.$nextTick(() => {
              const container = document.getElementById("chatContainer");
              container.scrollTop = container.scrollHeight;
            });

            try {
              // ----- ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ï¼ˆãªã‘ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³ï¼‰ -----
              let accessToken = localStorage.getItem("elysia_access_token");
              let refreshToken = localStorage.getItem("elysia_refresh_token");

              if (!accessToken || !refreshToken) {
                const username = prompt("ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                const pwd = prompt("ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                if (!username || !pwd)
                  throw new Error("èªè¨¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ");
                const authRes = await fetch("/auth/token", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ username, password: pwd }),
                });
                if (!authRes.ok) throw new Error("èªè¨¼å¤±æ•—");
                const authJson = await authRes.json();
                accessToken = authJson.accessToken;
                refreshToken = authJson.refreshToken;
                localStorage.setItem("elysia_access_token", accessToken);
                localStorage.setItem("elysia_refresh_token", refreshToken);
                localStorage.setItem("elysia_user", username);
              }

              // ----- ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ -----
              let response = await fetch("/elysia-love", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${accessToken}`,
                },
                body: JSON.stringify({
                  messages: this.messages.map((m) => ({
                    role: m.role,
                    content: m.content,
                  })),
                }),
              });

              // ----- 401ã‚¨ãƒ©ãƒ¼æ™‚ã«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã§å†å–å¾— -----
              if (response.status === 401) {
                console.log("ğŸ”„ ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œã€‚ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ä¸­...");
                const refreshRes = await fetch("/auth/refresh", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ refreshToken }),
                });

                if (!refreshRes.ok) {
                  // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚‚ç„¡åŠ¹ â†’ å†ãƒ­ã‚°ã‚¤ãƒ³è¦æ±‚
                  localStorage.removeItem("elysia_access_token");
                  localStorage.removeItem("elysia_refresh_token");
                  throw new Error("ã‚»ãƒƒã‚·ãƒ§ãƒ³æœŸé™åˆ‡ã‚Œã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
                }

                const refreshJson = await refreshRes.json();
                accessToken = refreshJson.accessToken;
                localStorage.setItem("elysia_access_token", accessToken);

                // æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã§å†ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                response = await fetch("/elysia-love", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${accessToken}`,
                  },
                  body: JSON.stringify({
                    messages: this.messages.map((m) => ({
                      role: m.role,
                      content: m.content,
                    })),
                  }),
                });
              }

              if (!response.ok)
                throw new Error(`HTTP error! status: ${response.status}`);

              const reader = response.body.getReader();
              const decoder = new TextDecoder();

              const assistantMessage = {
                id: Date.now() + 1,
                role: "assistant",
                content: "",
              };
              this.messages.push(assistantMessage);

              while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split("\n");

                for (const line of lines) {
                  if (line.startsWith("data: ")) {
                    try {
                      const data = JSON.parse(line.slice(6));
                      if (data.content) {
                        assistantMessage.content += data.content;
                      }
                    } catch {
                      // Skip invalid JSON
                    }
                  }
                }

                // Auto-scroll
                this.$nextTick(() => {
                  const container = document.getElementById("chatContainer");
                  container.scrollTop = container.scrollHeight;
                });
              }

              // âœ¨ ãƒœã‚¤ã‚¹å†ç”Ÿï¼ã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“ãŒå–‹ã‚‹ã‚ˆâ™¡
              if (assistantMessage.content.trim()) {
                setTimeout(() => {
                  elysiaSpeak(assistantMessage.content, true);
                }, 300);
              }
            } catch (error) {
              console.error("Error:", error);
              this.messages.push({
                id: Date.now() + 1,
                role: "assistant",
                content:
                  "ã”ã‚ã‚“ã­ã€œâ™¡ ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¡ã‚ƒã£ãŸâ€¦ \n\nFastAPIã‚µãƒ¼ãƒãƒ¼ã¨OllamaãŒèµ·å‹•ã—ã¦ã‚‹ã‹ç¢ºèªã—ã¦ã­ï¼\n\nğŸ’¡ ç¢ºèªæ–¹æ³•:\n1. FastAPIã‚µãƒ¼ãƒãƒ¼: http://127.0.0.1:8000/health\n2. Ollama: ollama serve",
              });
            } finally {
              this.loading = false;

              // Final auto-scroll
              this.$nextTick(() => {
                const container = document.getElementById("chatContainer");
                container.scrollTop = container.scrollHeight;
              });
            }
          },

          async ensureLogin() {
            let accessToken = localStorage.getItem("elysia_access_token");
            let refreshToken = localStorage.getItem("elysia_refresh_token");
            if (accessToken && refreshToken)
              return { accessToken, refreshToken };
            const username = prompt("ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            const pwd = prompt("ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            if (!username || !pwd)
              throw new Error("èªè¨¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ");
            const authRes = await fetch("/auth/token", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username, password: pwd }),
            });
            if (!authRes.ok) throw new Error("èªè¨¼å¤±æ•—");
            const authJson = await authRes.json();
            accessToken = authJson.accessToken;
            refreshToken = authJson.refreshToken;
            localStorage.setItem("elysia_access_token", accessToken);
            localStorage.setItem("elysia_refresh_token", refreshToken);
            localStorage.setItem("elysia_user", username);
            return { accessToken, refreshToken };
          },

          async sendFeedback(rating) {
            try {
              const { accessToken } = await this.ensureLogin();
              const payload = {
                query:
                  this.messages.filter((m) => m.role === "user").slice(-1)[0]
                    ?.content || "",
                answer:
                  this.messages
                    .filter((m) => m.role === "assistant")
                    .slice(-1)[0]?.content || "",
                rating,
                reason: rating === "down" ? "needs improvement" : "good",
              };
              const resp = await fetch("/feedback", {
                method: "POST",
                headers: {
                  "content-type": "application/json",
                  authorization: `Bearer ${accessToken}`,
                },
                body: JSON.stringify(payload),
              });
              if (!resp.ok) throw new Error(`Feedback failed: ${resp.status}`);
              alert("âœ¨ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ä¿å­˜ã—ãŸã‚ˆï¼");
            } catch (e) {
              console.error(e);
              alert("âš ï¸ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã§ã‚¨ãƒ©ãƒ¼");
            }
          },

          async upsertKnowledge() {
            try {
              const { accessToken } = await this.ensureLogin();
              const summary = prompt(
                "ç™»éŒ²ã™ã‚‹è¦ç´„ï¼ˆsummaryï¼‰ã‚’å…¥åŠ›ã—ã¦ã­â™¡",
                "Elysia knowledge note",
              );
              if (!summary) return;
              const payload = {
                summary,
                sourceUrl: location.href,
                tags: ["ui"],
                confidence: 0.9,
              };
              const resp = await fetch("/knowledge/upsert", {
                method: "POST",
                headers: {
                  "content-type": "application/json",
                  authorization: `Bearer ${accessToken}`,
                },
                body: JSON.stringify(payload),
              });
              if (!resp.ok) throw new Error(`Upsert failed: ${resp.status}`);
              alert("âœ¨ ãƒŠãƒ¬ãƒƒã‚¸ã‚’ä¿å­˜ã—ãŸã‚ˆï¼");
            } catch (e) {
              console.error(e);
              alert("âš ï¸ ãƒŠãƒ¬ãƒƒã‚¸ç™»éŒ²ã§ã‚¨ãƒ©ãƒ¼");
            }
          },

          async loadKnowledgeReview() {
            try {
              const { accessToken } = await this.ensureLogin();
              const resp = await fetch("/knowledge/review?n=10", {
                headers: { authorization: `Bearer ${accessToken}` },
              });
              if (!resp.ok) throw new Error(`Review failed: ${resp.status}`);
              const data = await resp.json();
              this.reviewJson = JSON.stringify(data, null, 2);
            } catch (e) {
              console.error(e);
              alert("âš ï¸ ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾—ã§ã‚¨ãƒ©ãƒ¼");
            }
          },
        };
      }
    </script>
  </body>
</html>
