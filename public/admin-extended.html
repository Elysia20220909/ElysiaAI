<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elysia AI - æ‹¡å¼µç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            background: white;
            padding: 10px;
            border-radius: 10px;
        }
        .tab {
            padding: 10px 20px;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .tab.active {
            background: #667eea;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .card h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-item {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-item .value {
            font-size: 2em;
            font-weight: bold;
        }
        .stat-item .label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        table th {
            background: #f5f5f5;
            font-weight: 600;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 5px;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn-danger { background: #f56565; color: white; }
        .btn-warning { background: #ed8936; color: white; }
        .btn:hover { opacity: 0.8; }
        .search-box {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 300px;
            margin-bottom: 15px;
        }
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        .badge-success { background: #c6f6d5; color: #22543d; }
        .badge-danger { background: #fed7d7; color: #742a2a; }
        .badge-warning { background: #feebc8; color: #7c2d12; }
        .badge-info { background: #bee3f8; color: #2c5282; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ Elysia AI æ‹¡å¼µç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <p>ã‚¸ãƒ§ãƒ–ã‚­ãƒ¥ãƒ¼ | Cron | ç›£æŸ»ãƒ­ã‚° | ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('jobs')">ã‚¸ãƒ§ãƒ–ã‚­ãƒ¥ãƒ¼</button>
            <button class="tab" onclick="switchTab('cron')">Cronã‚¿ã‚¹ã‚¯</button>
            <button class="tab" onclick="switchTab('audit')">ç›£æŸ»ãƒ­ã‚°</button>
            <button class="tab" onclick="switchTab('files')">ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†</button>
        </div>

        <!-- ã‚¸ãƒ§ãƒ–ã‚­ãƒ¥ãƒ¼ã‚¿ãƒ– -->
        <div id="jobs-tab" class="tab-content active">
            <div class="card">
                <h3>ğŸ“¦ ã‚¸ãƒ§ãƒ–ã‚­ãƒ¥ãƒ¼çµ±è¨ˆ</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="value" id="jobs-waiting">-</div>
                        <div class="label">å¾…æ©Ÿä¸­</div>
                    </div>
                    <div class="stat-item">
                        <div class="value" id="jobs-active">-</div>
                        <div class="label">å®Ÿè¡Œä¸­</div>
                    </div>
                    <div class="stat-item">
                        <div class="value" id="jobs-completed">-</div>
                        <div class="label">å®Œäº†</div>
                    </div>
                    <div class="stat-item">
                        <div class="value" id="jobs-failed">-</div>
                        <div class="label">å¤±æ•—</div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="refreshJobStats()">ğŸ”„ æ›´æ–°</button>
            </div>

            <div class="card">
                <h3>âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¸ãƒ§ãƒ–è¿½åŠ </h3>
                <input type="email" id="job-email" placeholder="é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="width: 300px; padding: 8px; margin-right: 10px;">
                <input type="text" id="job-subject" placeholder="ä»¶å" style="width: 300px; padding: 8px; margin-right: 10px;">
                <button class="btn btn-success" onclick="addEmailJob()">ğŸ“¨ é€ä¿¡</button>
            </div>

            <div class="card">
                <h3>ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</h3>
                <select id="report-type" style="padding: 8px; margin-right: 10px;">
                    <option value="daily">æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</option>
                    <option value="weekly">é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</option>
                    <option value="monthly">æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</option>
                </select>
                <button class="btn btn-success" onclick="generateReport()">ğŸ“ˆ ç”Ÿæˆ</button>
            </div>
        </div>

        <!-- Cronã‚¿ã‚¹ã‚¯ã‚¿ãƒ– -->
        <div id="cron-tab" class="tab-content">
            <div class="card">
                <h3>â° Cronã‚¿ã‚¹ã‚¯çµ±è¨ˆ</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="value" id="cron-total">-</div>
                        <div class="label">ç·ã‚¿ã‚¹ã‚¯æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="value" id="cron-enabled">-</div>
                        <div class="label">æœ‰åŠ¹</div>
                    </div>
                    <div class="stat-item">
                        <div class="value" id="cron-disabled">-</div>
                        <div class="label">ç„¡åŠ¹</div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="refreshCronStats()">ğŸ”„ æ›´æ–°</button>
            </div>

            <div class="card">
                <h3>ğŸ“‹ ã‚¿ã‚¹ã‚¯ä¸€è¦§</h3>
                <table id="cron-table">
                    <thead>
                        <tr>
                            <th>ã‚¿ã‚¹ã‚¯å</th>
                            <th>Cronå¼</th>
                            <th>çŠ¶æ…‹</th>
                            <th>æ¬¡å›å®Ÿè¡Œ</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- ç›£æŸ»ãƒ­ã‚°ã‚¿ãƒ– -->
        <div id="audit-tab" class="tab-content">
            <div class="card">
                <h3>ğŸ“ ç›£æŸ»ãƒ­ã‚°çµ±è¨ˆ</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="value" id="audit-total">-</div>
                        <div class="label">ç·ãƒ­ã‚°æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="value" id="audit-24h">-</div>
                        <div class="label">24æ™‚é–“</div>
                    </div>
                    <div class="stat-item">
                        <div class="value" id="audit-7d">-</div>
                        <div class="label">7æ—¥é–“</div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="refreshAuditStats()">ğŸ”„ æ›´æ–°</button>
                <button class="btn btn-warning" onclick="exportAuditLogs('json')">ğŸ“¥ JSON</button>
                <button class="btn btn-warning" onclick="exportAuditLogs('csv')">ğŸ“¥ CSV</button>
            </div>

            <div class="card">
                <h3>ğŸ” ãƒ­ã‚°æ¤œç´¢</h3>
                <input type="text" id="audit-search-user" class="search-box" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ID">
                <input type="text" id="audit-search-action" class="search-box" placeholder="ã‚¢ã‚¯ã‚·ãƒ§ãƒ³">
                <input type="text" id="audit-search-resource" class="search-box" placeholder="ãƒªã‚½ãƒ¼ã‚¹">
                <button class="btn btn-primary" onclick="searchAuditLogs()">ğŸ” æ¤œç´¢</button>
            </div>

            <div class="card">
                <h3>ğŸ“‹ æœ€æ–°ãƒ­ã‚°</h3>
                <table id="audit-table">
                    <thead>
                        <tr>
                            <th>æ—¥æ™‚</th>
                            <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
                            <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                            <th>ãƒªã‚½ãƒ¼ã‚¹</th>
                            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                            <th>IPã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚¿ãƒ– -->
        <div id="files-tab" class="tab-content">
            <div class="card">
                <h3>ğŸ“ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸çµ±è¨ˆ</h3>
                <div id="storage-stats"></div>
                <button class="btn btn-primary" onclick="refreshFileStats()">ğŸ”„ æ›´æ–°</button>
            </div>

            <div class="card">
                <h3>ğŸ“¤ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
                <input type="file" id="file-upload" style="margin-right: 10px;">
                <button class="btn btn-success" onclick="uploadFile()">ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
            </div>

            <div class="card">
                <h3>ğŸ“‹ ãƒã‚¤ãƒ•ã‚¡ã‚¤ãƒ«</h3>
                <table id="files-table">
                    <thead>
                        <tr>
                            <th>ãƒ•ã‚¡ã‚¤ãƒ«å</th>
                            <th>ã‚µã‚¤ã‚º</th>
                            <th>ã‚¿ã‚¤ãƒ—</th>
                            <th>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ—¥æ™‚</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let authToken = '';

        // åˆæœŸåŒ–
        window.onload = async () => {
            const token = prompt('JWT ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (!token) {
                alert('ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ã§ã™');
                return;
            }
            authToken = token;
            
            await refreshJobStats();
            await refreshCronStats();
            await refreshAuditStats();
            await refreshFileStats();
        };

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
        }

        // ã‚¸ãƒ§ãƒ–ã‚­ãƒ¥ãƒ¼çµ±è¨ˆ
        async function refreshJobStats() {
            try {
                const res = await fetch(`${API_BASE}/admin/jobs/stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                
                document.getElementById('jobs-waiting').textContent = data.waiting || 0;
                document.getElementById('jobs-active').textContent = data.active || 0;
                document.getElementById('jobs-completed').textContent = data.completed || 0;
                document.getElementById('jobs-failed').textContent = data.failed || 0;
            } catch (err) {
                console.error('Failed to fetch job stats:', err);
            }
        }

        // ãƒ¡ãƒ¼ãƒ«ã‚¸ãƒ§ãƒ–è¿½åŠ 
        async function addEmailJob() {
            const email = document.getElementById('job-email').value;
            const subject = document.getElementById('job-subject').value;
            
            if (!email || !subject) {
                alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ä»¶åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/admin/jobs/email`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to: email,
                        subject: subject,
                        html: '<h1>ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«</h1><p>Elysia AIã‹ã‚‰ã®ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã§ã™ã€‚</p>'
                    })
                });
                
                if (res.ok) {
                    alert('ãƒ¡ãƒ¼ãƒ«ã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
                    await refreshJobStats();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            } catch (err) {
                console.error('Failed to add email job:', err);
            }
        }

        // ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        async function generateReport() {
            const type = document.getElementById('report-type').value;
            const now = new Date();
            const start = new Date(now.getTime() - 24 * 60 * 60 * 1000);

            try {
                const res = await fetch(`${API_BASE}/admin/jobs/report`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reportType: type,
                        startDate: start.toISOString(),
                        endDate: now.toISOString()
                    })
                });
                
                if (res.ok) {
                    alert('ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
                    await refreshJobStats();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            } catch (err) {
                console.error('Failed to generate report:', err);
            }
        }

        // Cronçµ±è¨ˆ
        async function refreshCronStats() {
            try {
                const res = await fetch(`${API_BASE}/admin/cron/stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                
                document.getElementById('cron-total').textContent = data.totalTasks || 0;
                document.getElementById('cron-enabled').textContent = data.enabledTasks || 0;
                document.getElementById('cron-disabled').textContent = data.disabledTasks || 0;

                // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’å–å¾—
                const tasksRes = await fetch(`${API_BASE}/admin/cron/tasks`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const tasksData = await tasksRes.json();
                
                const tbody = document.querySelector('#cron-table tbody');
                tbody.innerHTML = '';
                
                tasksData.tasks.forEach(task => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${task.name}</td>
                        <td><code>${task.cronTime}</code></td>
                        <td><span class="badge badge-${task.enabled ? 'success' : 'danger'}">${task.enabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}</span></td>
                        <td>${task.nextRun ? new Date(task.nextRun).toLocaleString('ja-JP') : '-'}</td>
                        <td><button class="btn btn-primary" onclick="runCronTask('${task.name}')">â–¶ï¸ å®Ÿè¡Œ</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error('Failed to fetch cron stats:', err);
            }
        }

        // Cronã‚¿ã‚¹ã‚¯å®Ÿè¡Œ
        async function runCronTask(name) {
            try {
                const res = await fetch(`${API_BASE}/admin/cron/tasks/${name}/run`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (res.ok) {
                    alert(`ã‚¿ã‚¹ã‚¯ ${name} ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ`);
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            } catch (err) {
                console.error('Failed to run cron task:', err);
            }
        }

        // ç›£æŸ»ãƒ­ã‚°çµ±è¨ˆ
        async function refreshAuditStats() {
            try {
                const res = await fetch(`${API_BASE}/admin/audit/stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                
                document.getElementById('audit-total').textContent = data.totalLogs || 0;
                document.getElementById('audit-24h').textContent = data.last24Hours || 0;
                document.getElementById('audit-7d').textContent = data.last7Days || 0;

                // æœ€æ–°ãƒ­ã‚°ã‚’å–å¾—
                await searchAuditLogs();
            } catch (err) {
                console.error('Failed to fetch audit stats:', err);
            }
        }

        // ç›£æŸ»ãƒ­ã‚°æ¤œç´¢
        async function searchAuditLogs() {
            const userId = document.getElementById('audit-search-user').value;
            const action = document.getElementById('audit-search-action').value;
            const resource = document.getElementById('audit-search-resource').value;
            
            const params = new URLSearchParams();
            if (userId) params.append('userId', userId);
            if (action) params.append('action', action);
            if (resource) params.append('resource', resource);
            params.append('limit', '50');

            try {
                const res = await fetch(`${API_BASE}/admin/audit/logs?${params}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                
                const tbody = document.querySelector('#audit-table tbody');
                tbody.innerHTML = '';
                
                data.logs.forEach(log => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${new Date(log.timestamp).toLocaleString('ja-JP')}</td>
                        <td>${log.userId || '-'}</td>
                        <td><span class="badge badge-info">${log.action}</span></td>
                        <td>${log.resource}</td>
                        <td><span class="badge badge-${log.statusCode < 400 ? 'success' : 'danger'}">${log.statusCode}</span></td>
                        <td>${log.ipAddress}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error('Failed to search audit logs:', err);
            }
        }

        // ç›£æŸ»ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        async function exportAuditLogs(format) {
            try {
                const res = await fetch(`${API_BASE}/admin/audit/export?format=${format}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `audit-logs.${format}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (err) {
                console.error('Failed to export audit logs:', err);
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«çµ±è¨ˆ
        async function refreshFileStats() {
            // å®Ÿè£…äºˆå®š
            document.getElementById('storage-stats').innerHTML = '<p>ãƒ•ã‚¡ã‚¤ãƒ«çµ±è¨ˆã‚’å–å¾—ä¸­...</p>';
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        async function uploadFile() {
            const fileInput = document.getElementById('file-upload');
            if (!fileInput.files.length) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const res = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });
                
                if (res.ok) {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
                    await refreshFileStats();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            } catch (err) {
                console.error('Failed to upload file:', err);
            }
        }
    </script>
</body>
</html>
