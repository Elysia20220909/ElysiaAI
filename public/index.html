<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elysia AI Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.14.1/dist/cdn.min.js" defer></script>
    <style>
        /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú: „É¢„Éê„Ç§„É´„Éï„Ç°„Éº„Çπ„ÉàË®≠Ë®à */
        @media (max-width: 640px) {
            .chat-message { max-width: 85%; }
            .header-title { font-size: 1.125rem; }
        }
        @media (min-width: 641px) and (max-width: 1024px) {
            .chat-message { max-width: 75%; }
        }
        @media (min-width: 1025px) {
            .chat-message { max-width: 65%; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-3 sm:px-4 md:px-6 py-4 sm:py-6 md:py-8 max-w-7xl h-screen flex flex-col" x-data="elysiaChat()">
        
        <!-- Header („É¨„Çπ„Éù„É≥„Ç∑„Éñ: Flexbox + „É°„Éá„Ç£„Ç¢„ÇØ„Ç®„É™) -->
        <header class="bg-white rounded-lg shadow-sm p-3 sm:p-4 mb-3 sm:mb-4">
            <div class="flex items-center justify-between flex-wrap gap-2">
                <div class="flex items-center gap-2 sm:gap-3">
                    <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-purple-500 flex items-center justify-center text-white text-lg sm:text-xl flex-shrink-0">
                        üí¨
                    </div>
                    <div>
                        <h1 class="header-title text-lg sm:text-xl font-bold text-gray-800">Elysia AI Chat</h1>
                        <p class="text-xs sm:text-sm text-gray-500">Powered by Bun</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <span class="px-2 py-1 rounded text-xs bg-green-100 text-green-700">‚óè Online</span>
                </div>
            </div>
        </header>

        <!-- Chat Container („É¨„Çπ„Éù„É≥„Ç∑„Éñ: ÂèØÂ§âÂπÖ + „Çπ„ÇØ„É≠„Éº„É´ÊúÄÈÅ©Âåñ) -->
        <main class="flex-1 bg-white rounded-lg shadow-sm overflow-hidden flex flex-col min-h-0">
            <div class="flex-1 overflow-y-auto p-3 sm:p-4 space-y-2 sm:space-y-3" id="chatContainer">
                
                <!-- Welcome („É¨„Çπ„Éù„É≥„Ç∑„Éñ: „Éë„Éá„Ç£„É≥„Ç∞Ë™øÊï¥) -->
                <div class="text-center py-6 sm:py-8 px-4" x-show="messages.length === 0">
                    <div class="text-3xl sm:text-4xl mb-2">üëã</div>
                    <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-1">Welcome to Elysia AI</h3>
                    <p class="text-xs sm:text-sm text-gray-500">Start a conversation below</p>
                </div>

                <!-- Messages („É¨„Çπ„Éù„É≥„Ç∑„Éñ: ÂãïÁöÑmax-width) -->
                <template x-for="msg in messages" :key="msg.id">
                    <div :class="msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
                        <div :class="msg.role === 'user' ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-800'" class="chat-message rounded-lg px-3 sm:px-4 py-2 break-words">
                            <p class="text-xs sm:text-sm whitespace-pre-wrap" x-text="msg.content"></p>
                        </div>
                    </div>
                </template>

                <!-- Loading („É¨„Çπ„Éù„É≥„Ç∑„Éñ: „Çµ„Ç§„Ç∫Ë™øÊï¥) -->
                <div class="flex justify-start" x-show="loading">
                    <div class="bg-gray-100 rounded-lg px-3 sm:px-4 py-2">
                        <div class="flex items-center gap-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area („É¨„Çπ„Éù„É≥„Ç∑„Éñ: „É¢„Éê„Ç§„É´„ÅßÁ∏¶ÈÖçÁΩÆ„ÇÇÂèØ) -->
            <div class="border-t border-gray-200 p-3 sm:p-4">
                <form @submit.prevent="sendMessage" class="flex flex-col sm:flex-row gap-2">
                    <input 
                        type="text" 
                        x-model="input" 
                        :disabled="loading" 
                        placeholder="Type a message..." 
                        class="flex-1 px-3 sm:px-4 py-2 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed"
                    />
                    <button 
                        type="submit" 
                        :disabled="loading || !input.trim()" 
                        class="px-4 sm:px-6 py-2 bg-purple-500 text-white rounded-lg font-medium text-sm sm:text-base hover:bg-purple-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors whitespace-nowrap"
                    >
                        Send
                    </button>
                </form>
            </div>
        </main>

        <!-- Footer („É¨„Çπ„Éù„É≥„Ç∑„Éñ: „ÉÜ„Ç≠„Çπ„Éà„Çµ„Ç§„Ç∫Ë™øÊï¥) -->
        <footer class="mt-3 sm:mt-4 text-center text-xs sm:text-sm text-gray-500">
            Built with Elysia.js + Bun
        </footer>
    </div>

    <script>
        function elysiaChat() {
            return {
                messages: [], 
                input: '', 
                loading: false,
                setQuickMessage(message) { 
                    if (!this.loading) { 
                        this.input = message; 
                        this.$nextTick(() => this.sendMessage()); 
                    } 
                },
                async sendMessage() {
                    if (!this.input.trim() || this.loading) return;
                    const userMessage = this.input.trim();
                    this.messages.push({ id: Date.now(), role: 'user', content: userMessage });
                    this.input = ''; 
                    this.loading = true; 
                    this.scrollToBottom();
                    
                    try {
                        let accessToken = localStorage.getItem('elysia_access_token');
                        let refreshToken = localStorage.getItem('elysia_refresh_token');
                        
                        if (!accessToken || !refreshToken) {
                            const authRes = await fetch('/auth/token', { 
                                method: 'POST', 
                                headers: { 'Content-Type': 'application/json' }, 
                                body: JSON.stringify({ username: 'elysia', password: 'elysia-dev-password' }) 
                            });
                            if (!authRes.ok) throw new Error('Auth failed');
                            const authJson = await authRes.json();
                            accessToken = authJson.accessToken; 
                            refreshToken = authJson.refreshToken;
                            localStorage.setItem('elysia_access_token', accessToken); 
                            localStorage.setItem('elysia_refresh_token', refreshToken);
                        }
                        
                        let response = await fetch('/elysia-love', { 
                            method: 'POST', 
                            headers: { 
                                'Content-Type': 'application/json', 
                                'Authorization': `Bearer ${accessToken}` 
                            }, 
                            body: JSON.stringify({ 
                                messages: this.messages.map(m => ({ role: m.role, content: m.content })) 
                            }) 
                        });
                        
                        if (response.status === 401) {
                            const refreshRes = await fetch('/auth/refresh', { 
                                method: 'POST', 
                                headers: { 'Content-Type': 'application/json' }, 
                                body: JSON.stringify({ refreshToken }) 
                            });
                            if (!refreshRes.ok) { 
                                localStorage.clear(); 
                                throw new Error('Session expired'); 
                            }
                            const refreshJson = await refreshRes.json(); 
                            accessToken = refreshJson.accessToken;
                            localStorage.setItem('elysia_access_token', accessToken);
                            
                            response = await fetch('/elysia-love', { 
                                method: 'POST', 
                                headers: { 
                                    'Content-Type': 'application/json', 
                                    'Authorization': `Bearer ${accessToken}` 
                                }, 
                                body: JSON.stringify({ 
                                    messages: this.messages.map(m => ({ role: m.role, content: m.content })) 
                                }) 
                            });
                        }
                        
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        
                        const reader = response.body.getReader(); 
                        const decoder = new TextDecoder();
                        const assistantMessage = { id: Date.now() + 1, role: 'assistant', content: '' };
                        this.messages.push(assistantMessage);
                        
                        while (true) {
                            const { done, value } = await reader.read(); 
                            if (done) break;
                            const chunk = decoder.decode(value); 
                            const lines = chunk.split('\n');
                            for (const line of lines) { 
                                if (line.startsWith('data: ')) { 
                                    try { 
                                        const data = JSON.parse(line.slice(6)); 
                                        if (data.content) { 
                                            assistantMessage.content += data.content; 
                                        } 
                                    } catch {} 
                                } 
                            }
                            this.scrollToBottom();
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        this.messages.push({ 
                            id: Date.now() + 1, 
                            role: 'assistant', 
                            content: '‚ö†Ô∏è Error: ' + error.message 
                        });
                    } finally { 
                        this.loading = false; 
                        this.scrollToBottom(); 
                    }
                },
                scrollToBottom() { 
                    this.$nextTick(() => { 
                        const container = document.getElementById('chatContainer'); 
                        if (container) { 
                            container.scrollTop = container.scrollHeight; 
                        } 
                    }); 
                }
            }
        }
    </script>
</body>
</html>
