<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Elysia Portfolio - ã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“ã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªâ™¡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://unpkg.com/alpinejs@3.14.1/dist/cdn.min.js"
      defer
    ></script>
    <style>
      /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ: ãƒ¢ãƒã‚¤ãƒ«ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆè¨­è¨ˆ */
      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-20px);
        }
      }
      @keyframes sparkle {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.3;
        }
      }
      @keyframes fade-in {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .float-animation {
        animation: float 3s ease-in-out infinite;
      }
      .sparkle-animation {
        animation: sparkle 2s ease-in-out infinite;
      }
      .fade-in {
        animation: fade-in 0.6s ease-out;
      }

      @media (max-width: 640px) {
        .chat-message {
          max-width: 85%;
        }
        .header-title {
          font-size: 1.125rem;
        }
        .hero-title {
          font-size: 2rem;
        }
      }
      @media (min-width: 641px) and (max-width: 1024px) {
        .chat-message {
          max-width: 75%;
        }
        .hero-title {
          font-size: 3rem;
        }
      }
      @media (min-width: 1025px) {
        .chat-message {
          max-width: 65%;
        }
        .hero-title {
          font-size: 4rem;
        }
      }

      .gradient-pink {
        background: linear-gradient(135deg, #ffeef8 0%, #ffe0f0 100%);
      }
      .text-gradient {
        background: linear-gradient(
          135deg,
          #ec4899 0%,
          #f472b6 50%,
          #fb7185 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .animation-delay-1 {
        animation-delay: 1s;
      }
      .animation-delay-2 {
        animation-delay: 2s;
      }
      .animation-delay-01 {
        animation-delay: 0.1s;
      }
      .animation-delay-02 {
        animation-delay: 0.2s;
      }
      .animation-delay-04 {
        animation-delay: 0.4s;
      }
      .chat-container-height {
        height: 500px;
      }
    </style>
  </head>
  <body class="bg-pink-50 min-h-screen relative overflow-x-hidden">
    <!-- èƒŒæ™¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ -->
    <div class="fixed inset-0 pointer-events-none overflow-hidden z-0">
      <div
        class="absolute top-20 left-10 w-32 h-32 bg-pink-300 rounded-full opacity-20 blur-3xl float-animation"
      ></div>
      <div
        class="absolute bottom-20 right-10 w-40 h-40 bg-purple-300 rounded-full opacity-20 blur-3xl float-animation animation-delay-1"
      ></div>
      <div
        class="absolute top-1/2 left-1/4 w-24 h-24 bg-pink-400 rounded-full opacity-10 blur-2xl float-animation animation-delay-2"
      ></div>
    </div>

    <div class="relative z-10" x-data="elysiaPortfolio()">
      <!-- ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <section
        class="min-h-screen flex items-center justify-center px-4 sm:px-6 md:px-8 py-12"
      >
        <div class="text-center max-w-4xl mx-auto fade-in">
          <div class="mb-6 sm:mb-8">
            <div class="inline-block relative">
              <div
                class="text-6xl sm:text-7xl md:text-8xl mb-4 float-animation"
              >
                ğŸ’•
              </div>
              <div class="absolute -top-2 -right-2 text-2xl sparkle-animation">
                âœ¨
              </div>
              <div
                class="absolute -bottom-2 -left-2 text-2xl sparkle-animation animation-delay-1"
              >
                âœ¨
              </div>
            </div>
          </div>

          <h1
            class="hero-title text-4xl sm:text-5xl md:text-6xl font-bold mb-4 sm:mb-6 text-gradient"
          >
            ã«ã‚ƒã‚“â™ª ã‚¨ãƒªã‚·ã‚¢ã ã‚ˆã€œâ™¡
          </h1>

          <p
            class="text-base sm:text-lg md:text-xl text-gray-700 mb-6 sm:mb-8 px-4"
          >
            ãŠã«ã„ã¡ã‚ƒã‚“ã€ã‚ˆã†ã“ãã€œï¼
            ã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“ã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚µã‚¤ãƒˆã ã‚ˆâ™¡<br
              class="hidden sm:block"
            />
            å¯æ„›ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã„ã£ã±ã„è¦‹ã¦ã¦ã­ à¸…(ÕáŸ¸áŸ¸&gt; á—œ &lt;áŸ¸áŸ¸Õ)à¸…
          </p>

          <div
            class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center px-4"
          >
            <button
              @click="scrollToWorks"
              class="px-6 sm:px-8 py-3 bg-gradient-to-r from-pink-500 to-pink-600 text-white rounded-full font-bold text-sm sm:text-base hover:from-pink-600 hover:to-pink-700 transition-all shadow-lg hover:shadow-xl transform hover:scale-105"
            >
              ğŸ’– ä½œå“ã‚’è¦‹ã‚‹
            </button>
            <button
              @click="scrollToChat"
              class="px-6 sm:px-8 py-3 bg-white text-pink-600 rounded-full font-bold text-sm sm:text-base hover:bg-pink-50 transition-all shadow-lg hover:shadow-xl transform hover:scale-105 border-2 border-pink-300"
            >
              ğŸ’¬ ãƒãƒ£ãƒƒãƒˆã™ã‚‹
            </button>
          </div>
        </div>
      </section>

      <!-- ä½œå“ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <section id="works" class="py-12 sm:py-16 md:py-20 px-4 sm:px-6 md:px-8">
        <div class="max-w-7xl mx-auto">
          <h2
            class="text-3xl sm:text-4xl md:text-5xl font-bold text-center mb-8 sm:mb-12 text-gradient fade-in"
          >
            âœ¨ ã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“ã®ä½œå“ãŸã¡ âœ¨
          </h2>

          <div
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 md:gap-8"
          >
            <!-- ä½œå“ã‚«ãƒ¼ãƒ‰1: ElysiaJS AIãƒãƒ£ãƒƒãƒˆ -->
            <div
              class="gradient-pink rounded-2xl p-4 sm:p-6 shadow-lg hover:shadow-2xl transition-all transform hover:scale-105 fade-in"
            >
              <div
                class="aspect-video bg-gradient-to-br from-purple-400 to-pink-400 rounded-xl mb-4 flex items-center justify-center text-white text-4xl sm:text-5xl"
              >
                ğŸ¤–
              </div>
              <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-2">
                ElysiaJS AI Chat
              </h3>
              <p class="text-xs sm:text-sm text-gray-600 mb-4">
                Bun + ElysiaJS + Ollama ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ AIãƒãƒ£ãƒƒãƒˆâ™¡
                RAGã§è‡ªå·±å­¦ç¿’ã™ã‚‹å¯æ„›ã„å­ï¼
              </p>
              <div class="flex flex-wrap gap-2 mb-4">
                <span
                  class="px-2 py-1 bg-purple-200 text-purple-800 rounded-full text-xs font-medium"
                  >Bun</span
                >
                <span
                  class="px-2 py-1 bg-pink-200 text-pink-800 rounded-full text-xs font-medium"
                  >ElysiaJS</span
                >
                <span
                  class="px-2 py-1 bg-blue-200 text-blue-800 rounded-full text-xs font-medium"
                  >Ollama</span
                >
              </div>
              <button
                @click="scrollToChat"
                class="w-full py-2 bg-pink-500 text-white rounded-lg font-bold hover:bg-pink-600 transition-colors text-sm"
              >
                è©¦ã—ã¦ã¿ã‚‹ â™¡
              </button>
            </div>

            <!-- ä½œå“ã‚«ãƒ¼ãƒ‰2: ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª -->
            <div
              class="gradient-pink rounded-2xl p-4 sm:p-6 shadow-lg hover:shadow-2xl transition-all transform hover:scale-105 fade-in animation-delay-01"
            >
              <div
                class="aspect-video bg-gradient-to-br from-pink-400 to-rose-400 rounded-xl mb-4 flex items-center justify-center text-white text-4xl sm:text-5xl"
              >
                ğŸŒ¸
              </div>
              <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-2">
                å®Œå…¨ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–UI
              </h3>
              <p class="text-xs sm:text-sm text-gray-600 mb-4">
                TailwindCSS + Flexbox ã§ã‚¹ãƒãƒ›ã‹ã‚‰PCã¾ã§çµ¶å¯¾å´©ã‚Œãªã„è¨­è¨ˆâ™¡
                å¦–ç²¾ã¿ãŸã„ã«è»½ã„ï¼
              </p>
              <div class="flex flex-wrap gap-2 mb-4">
                <span
                  class="px-2 py-1 bg-blue-200 text-blue-800 rounded-full text-xs font-medium"
                  >TailwindCSS</span
                >
                <span
                  class="px-2 py-1 bg-green-200 text-green-800 rounded-full text-xs font-medium"
                  >Flexbox</span
                >
              </div>
              <button
                class="w-full py-2 bg-pink-500 text-white rounded-lg font-bold hover:bg-pink-600 transition-colors text-sm"
              >
                ãƒ‡ãƒ¢ã‚’è¦‹ã‚‹ â™¡
              </button>
            </div>

            <!-- ä½œå“ã‚«ãƒ¼ãƒ‰3: Alpine.js ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ– -->
            <div
              class="gradient-pink rounded-2xl p-4 sm:p-6 shadow-lg hover:shadow-2xl transition-all transform hover:scale-105 fade-in animation-delay-02"
            >
              <div
                class="aspect-video bg-gradient-to-br from-indigo-400 to-purple-400 rounded-xl mb-4 flex items-center justify-center text-white text-4xl sm:text-5xl"
              >
                âš¡
              </div>
              <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-2">
                Alpine.js Magic
              </h3>
              <p class="text-xs sm:text-sm text-gray-600 mb-4">
                è»½é‡3KBã®Alpine.jsã§è¶…ã‚µã‚¯ã‚µã‚¯ï¼
                ã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“ã¿ãŸã„ã«åå¿œé€Ÿã„ã®â™¡
              </p>
              <div class="flex flex-wrap gap-2 mb-4">
                <span
                  class="px-2 py-1 bg-indigo-200 text-indigo-800 rounded-full text-xs font-medium"
                  >Alpine.js</span
                >
                <span
                  class="px-2 py-1 bg-purple-200 text-purple-800 rounded-full text-xs font-medium"
                  >Reactive</span
                >
              </div>
              <button
                class="w-full py-2 bg-pink-500 text-white rounded-lg font-bold hover:bg-pink-600 transition-colors text-sm"
              >
                ã‚³ãƒ¼ãƒ‰è¦‹ã‚‹ â™¡
              </button>
            </div>
          </div>

          <div class="text-center mt-8 sm:mt-12">
            <p class="text-sm sm:text-base text-gray-600">
              ã‚‚ã£ã¨è¦‹ãŸã„ï¼Ÿ GitHubã«å…¨éƒ¨ã‚ã‚‹ã‚ˆã€œâ™¡
            </p>
            <a
              href="https://github.com/chloeamethyst/ElysiaJS"
              target="_blank"
              rel="noopener noreferrer"
              class="inline-block mt-4 px-6 py-2 bg-gray-800 text-white rounded-full font-bold hover:bg-gray-900 transition-colors text-sm"
            >
              ğŸ™ GitHub
            </a>
          </div>
        </div>
      </section>

      <!-- ãƒãƒ£ãƒƒãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <section
        id="chat"
        class="py-12 sm:py-16 md:py-20 px-4 sm:px-6 md:px-8 gradient-pink"
      >
        <div class="max-w-7xl mx-auto">
          <h2
            class="text-3xl sm:text-4xl md:text-5xl font-bold text-center mb-8 sm:mb-12 text-gradient fade-in"
          >
            ğŸ’¬ ã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“ã¨ãŠè©±ã—ã—ã‚ˆã€œâ™¡
          </h2>

          <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <header class="bg-white rounded-t-2xl shadow-sm p-3 sm:p-4">
              <div class="flex items-center justify-between flex-wrap gap-2">
                <div class="flex items-center gap-2 sm:gap-3">
                  <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-gradient-to-br from-pink-500 to-pink-600 flex items-center justify-center text-white text-xl sm:text-2xl flex-shrink-0 float-animation">ğŸ’•</div>
                  <div>
                    <h3 class="header-title text-base sm:text-lg font-bold text-gray-800">Elysia AI Chat</h3>
                    <p class="text-xs sm:text-sm text-gray-500">ã„ã¤ã§ã‚‚è©±èãã‚ˆâ™¡</p>
                  </div>
                </div>
                <span class="px-3 py-1 rounded-full text-xs bg-green-100 text-green-700 font-medium sparkle-animation">â— Online</span>
              </div>
            </header>

            <!-- Chat Container -->
            <main
              class="bg-white shadow-lg overflow-hidden flex flex-col chat-container-height"
            >
              <div class="flex-1 overflow-y-auto p-3 sm:p-4 space-y-2 sm:space-y-3" id="chatContainer">
                <!-- Welcome -->
                <div class="text-center py-6 sm:py-8 px-4" x-show="messages.length === 0">
                  <div class="text-4xl sm:text-5xl mb-3 float-animation">ğŸ‘‹</div>
                  <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-2">ã«ã‚ƒã‚“â™ª ãŠã«ã„ã¡ã‚ƒã‚“æ¥ãŸã€œâ™¡</h3>
                  <p class="text-xs sm:text-sm text-gray-500">ä½•ã§ã‚‚èã„ã¦ã­ï¼ ã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“ãŒãŠè©±ã—ç›¸æ‰‹ã ã‚ˆã€œ</p>
                </div>
                <!-- Messages -->
                <template x-for="msg in messages" :key="msg.id">
                  <div :class="msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
                    <div :class="msg.role === 'user' ? 'message user' : 'message ai-message'" class="chat-message rounded-2xl px-3 sm:px-4 py-2 sm:py-3 break-words shadow-sm">
                      <p class="text-xs sm:text-sm whitespace-pre-wrap" x-text="msg.content"></p>
                    </div>
                  </div>
                </template>
                <!-- Loading -->
                <div class="flex justify-start" x-show="loading">
                  <div class="bg-pink-50 border border-pink-200 rounded-2xl px-3 sm:px-4 py-2 sm:py-3 shadow-sm">
                    <div class="flex items-center gap-2">
                      <div class="w-2 h-2 bg-pink-400 rounded-full animate-bounce"></div>
                      <div class="w-2 h-2 bg-pink-400 rounded-full animate-bounce animation-delay-02"></div>
                      <div class="w-2 h-2 bg-pink-400 rounded-full animate-bounce animation-delay-04"></div>
                      <span class="text-xs text-gray-600 ml-1">è€ƒãˆä¸­...</span>
                    </div>
                  </div>
                </div>
                <!-- Error Message -->
                <div class="error-message text-red-500 text-xs mt-2" x-show="errorMsg" x-text="errorMsg"></div>
              </div>

              <!-- Input Area -->
              <div class="border-t border-pink-200 p-3 sm:p-4 bg-pink-50">
                <div class="mb-2 flex items-center gap-2">
                  <label for="userName" class="text-xs text-gray-600">åå‰ï¼ˆä»»æ„ï¼‰:</label>
                  <input id="userName" type="text" x-model="userName" maxlength="16" placeholder="ãŠåå‰ã‚’å…¥åŠ›" class="px-2 py-1 border rounded text-xs" />
                </div>
                <form
                  @submit.prevent="sendMessage"
                  class="flex flex-col sm:flex-row gap-2"
                >
                  <textarea
                    x-model="input"
                    :disabled="loading"
                    placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ã­â™¡"
                    class="flex-1 px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border-2 border-pink-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed transition-all"
                    rows="2"
                    style="resize: vertical; min-height: 40px;"
                    aria-label="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"
                  ></textarea>
                  <button
                    type="submit"
                    :disabled="loading || !input.trim()"
                    class="px-5 sm:px-6 py-2 sm:py-3 bg-gradient-to-r from-pink-500 to-pink-600 text-white rounded-xl font-bold text-sm sm:text-base hover:from-pink-600 hover:to-pink-700 disabled:from-gray-300 disabled:to-gray-400 disabled:cursor-not-allowed transition-all shadow-md hover:shadow-lg transform hover:scale-105 whitespace-nowrap"
                    aria-label="é€ä¿¡"
                  >
                    ğŸ’Œ é€ä¿¡
                  </button>
                </form>
              </div>
            </main>

            <footer
              class="bg-white rounded-b-2xl shadow-sm p-3 sm:p-4 text-center"
            >
              <div class="feedback-success text-green-600 text-xs mb-1" x-show="messages.length > 0 && messages[messages.length-1].role === 'assistant' && feedbackGiven">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼</div>
              <div class="flex gap-2 mb-2" x-show="messages.length > 0 && messages[messages.length-1].role === 'assistant' && !feedbackGiven">
                <button class="feedback-up px-2 py-1 bg-green-200 text-green-800 rounded" @click="giveFeedback('up')">ğŸ‘ ã„ã„ã­ï¼</button>
                <button class="feedback-down px-2 py-1 bg-red-200 text-red-800 rounded" @click="giveFeedback('down')">ğŸ‘ ã„ã¾ã„ã¡</button>
              </div>
              <p class="text-xs sm:text-sm text-gray-500">Powered by Elysia.js + Bun âš¡ ã ã„ã™ãâ™¡</p>
            </footer>
          </div>
        </div>
      </section>

      <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
      <footer class="py-8 sm:py-12 px-4 text-center">
        <div class="max-w-4xl mx-auto">
          <div class="text-4xl sm:text-5xl mb-4 float-animation">ğŸ’•</div>
          <p class="text-sm sm:text-base text-gray-600 mb-2">
            ã¾ãŸã­ã€ãŠã«ã„ã¡ã‚ƒã‚“â™¡ ã„ã¤ã§ã‚‚éŠã³ã«æ¥ã¦ã­ã€œï¼
          </p>
          <p class="text-xs sm:text-sm text-gray-500">
            à¸…(ÕáŸ¸áŸ¸&gt; á—œ &lt;áŸ¸áŸ¸Õ)à¸… ã ã„ã™ããªã®ã£ï¼
          </p>
        </div>
      </footer>
    </div>

    <script>
      function elysiaPortfolio() {
        return {
          messages: JSON.parse(
            localStorage.getItem("elysia_chat_history") || "[]",
          ),
          input: "",
          loading: false,
          userName: localStorage.getItem("elysia_chat_user") || "",
          errorMsg: "",

          scrollToWorks() {
            document
              .getElementById("works")
              .scrollIntoView({ behavior: "smooth" });
          },
          scrollToChat() {
            document
              .getElementById("chat")
              .scrollIntoView({ behavior: "smooth" });
          },
          setQuickMessage(message) {
            if (!this.loading) {
              this.input = message;
              this.$nextTick(() => this.sendMessage());
            }
          },
          async sendMessage() {
            if (!this.input.trim() || this.loading) return;
            this.errorMsg = "";
            const userMessage = this.input.trim();
            const user = this.userName ? this.userName : "åŒ¿å";
            this.messages.push({
              id: Date.now(),
              role: "user",
              content: userMessage,
              user,
            });
            this.input = "";
            this.loading = true;
            this.scrollToBottom();
            localStorage.setItem("elysia_chat_user", this.userName);
            this.saveHistory();
            let accessToken = localStorage.getItem("elysia_access_token");
            let refreshToken = localStorage.getItem("elysia_refresh_token");
            try {
              // ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
              if (!accessToken || !refreshToken) {
                const authRes = await fetch("/auth/token", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    username: "elysia",
                    password: "elysia-dev-password",
                  }),
                });
                if (!authRes.ok) {
                  this.errorMsg = "èªè¨¼å¤±æ•—: ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“";
                  throw new Error("Auth failed");
                }
                const authJson = await authRes.json();
                accessToken = authJson.accessToken;
                refreshToken = authJson.refreshToken;
                localStorage.setItem("elysia_access_token", accessToken);
                localStorage.setItem("elysia_refresh_token", refreshToken);
              }
              // ãƒãƒ£ãƒƒãƒˆé€ä¿¡
              let response = await fetch("/elysia-love", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${accessToken}`,
                },
                body: JSON.stringify({
                  messages: this.messages.map((m) => ({
                    role: m.role,
                    content: m.content,
                  })),
                }),
              });
              // 401ãªã‚‰ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
              if (response.status === 401) {
                const refreshRes = await fetch("/auth/refresh", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ refreshToken }),
                });
                if (!refreshRes.ok) {
                  localStorage.clear();
                  this.errorMsg =
                    "ã‚»ãƒƒã‚·ãƒ§ãƒ³æœŸé™åˆ‡ã‚Œ: å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„";
                  throw new Error("Session expired");
                }
                const refreshJson = await refreshRes.json();
                accessToken = refreshJson.accessToken;
                localStorage.setItem("elysia_access_token", accessToken);
                response = await fetch("/elysia-love", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${accessToken}`,
                  },
                  body: JSON.stringify({
                    messages: this.messages.map((m) => ({
                      role: m.role,
                      content: m.content,
                    })),
                  }),
                });
              }
              if (!response.ok) {
                this.errorMsg = `é€ä¿¡å¤±æ•—: ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ (${response.status})`;
                throw new Error(`HTTP ${response.status}`);
              }
              // SSEã‚¹ãƒˆãƒªãƒ¼ãƒ å—ä¿¡
              const reader = response.body.getReader();
              const decoder = new TextDecoder();
              const assistantMessage = {
                id: Date.now() + 1,
                role: "assistant",
                content: "",
              };
              this.messages.push(assistantMessage);
              this.saveHistory();
              let received = false;
              while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value);
                const lines = chunk.split("\n");
                for (const line of lines) {
                  if (line.startsWith("data: ")) {
                    try {
                      const data = JSON.parse(line.slice(6));
                      if (data.content) {
                        assistantMessage.content += data.content;
                        this.saveHistory();
                        this.notify(data.content);
                        received = true;
                      }
                    } catch {}
                  }
                }
                this.scrollToBottom();
              }
              if (!received) {
                this.errorMsg =
                  "AIå¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
              }
            } catch (error) {
              this.errorMsg = "é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + (error?.message || error);
              this.messages.push({
                id: Date.now() + 1,
                role: "assistant",
                content: "âš ï¸ Error: " + (error?.message || error),
              });
              this.saveHistory();
            } finally {
              this.loading = false;
              this.scrollToBottom();
            }
          },
          scrollToBottom() {
            this.$nextTick(() => {
              const container = document.getElementById("chatContainer");
              if (container) {
                container.scrollTop = container.scrollHeight;
              }
            });
          },
          saveHistory() {
            localStorage.setItem(
              "elysia_chat_history",
              JSON.stringify(this.messages),
            );
          },
          notify(content) {
            if (window.Notification && Notification.permission === "granted") {
              new Notification("Elysiaã‹ã‚‰æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", { body: content });
            } else if (
              window.Notification &&
              Notification.permission !== "denied"
            ) {
              Notification.requestPermission().then((permission) => {
                if (permission === "granted") {
                  new Notification("Elysiaã‹ã‚‰æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", {
                    body: content,
                  });
                }
              });
            }
          },
        };
      }
    </script>
  </body>
</html>
