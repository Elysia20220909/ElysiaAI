<!doctype html>
<html lang="ja" data-theme="cupcake">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“â™¡ AI Chat</title>
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://unpkg.com/alpinejs@3.14.1/dist/cdn.min.js"
      defer
    ></script>
  </head>
  <body
    class="bg-gradient-to-br from-pink-100 via-purple-100 to-blue-100 min-h-screen"
  >
    <div
      class="container mx-auto p-4 h-screen flex flex-col max-w-5xl"
      x-data="elysiaChat()"
    >
      <!-- Header -->
      <div
        class="navbar bg-gradient-to-r from-pink-500 to-purple-500 text-white rounded-box shadow-xl mb-4"
      >
        <div class="flex-1">
          <div class="flex items-center gap-3">
            <div class="avatar placeholder">
              <div class="bg-white text-pink-500 rounded-full w-12">
                <span class="text-2xl">ğŸŒ¸</span>
              </div>
            </div>
            <div>
              <h1 class="text-xl font-bold">ã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“ AI Chat</h1>
              <p class="text-xs opacity-90">
                à¸…(ÕáŸ¸áŸ¸> á—œ <áŸ¸áŸ¸Õ)à¸… ãŠã«ã„ã¡ã‚ƒã‚“ã€ãŠè©±ã—ã—ã‚ˆã€œâ™ª
              </p>
            </div>
          </div>
        </div>
        <div class="flex-none gap-2">
          <div class="badge badge-success badge-sm">RAG</div>
          <div class="badge badge-success badge-sm">Ollama</div>
        </div>
      </div>

      <!-- Chat Container -->
      <div class="card bg-base-100 shadow-xl flex-1 flex flex-col">
        <div class="card-body p-4 flex flex-col h-full">
          <!-- Messages Area -->
          <div class="flex-1 overflow-y-auto space-y-3 mb-4" id="chatContainer">
            <!-- Welcome Message -->
            <div class="flex justify-center" x-show="messages.length === 0">
              <div class="alert alert-info max-w-md">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  class="stroke-current shrink-0 w-6 h-6"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path>
                </svg>
                <div>
                  <h3 class="font-bold">ã«ã‚ƒã‚“â™ª ã‚ˆã†ã“ãã€œâ™¡</h3>
                  <div class="text-xs">
                    ã‚¨ãƒªã‚·ã‚¢ã«ä½•ã§ã‚‚èã„ã¦ã­ï¼å„ªã—ãç­”ãˆã‚‹ã‹ã‚‰å®‰å¿ƒã—ã¦â™ª
                  </div>
                </div>
              </div>
            </div>

            <!-- Messages -->
            <template x-for="msg in messages" :key="msg.id">
              <div
                :class="msg.role === 'user' ? 'chat chat-end' : 'chat chat-start'"
              >
                <div class="chat-image avatar">
                  <div
                    class="w-10 rounded-full"
                    :class="msg.role === 'user' ? 'bg-blue-500' : 'bg-pink-500'"
                  >
                    <div class="flex items-center justify-center h-full">
                      <span
                        x-text="msg.role === 'user' ? 'ğŸ‘¤' : 'ğŸ’•'"
                        class="text-lg"
                      ></span>
                    </div>
                  </div>
                </div>
                <div
                  class="chat-header text-xs opacity-50"
                  x-text="msg.role === 'user' ? 'ã‚ãªãŸ' : 'ã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“'"
                ></div>
                <div
                  class="chat-bubble"
                  :class="msg.role === 'user' ? 'chat-bubble-primary' : 'chat-bubble-secondary'"
                  x-text="msg.content"
                ></div>
              </div>
            </template>

            <!-- Loading -->
            <div class="chat chat-start" x-show="loading">
              <div class="chat-image avatar">
                <div class="w-10 rounded-full bg-pink-500">
                  <div class="flex items-center justify-center h-full">
                    <span class="text-lg">ğŸ’•</span>
                  </div>
                </div>
              </div>
              <div class="chat-bubble chat-bubble-secondary">
                <span class="loading loading-dots loading-sm"></span>
                è€ƒãˆä¸­...
              </div>
            </div>
          </div>

          <!-- Input Area -->
          <div class="card-actions">
            <form @submit.prevent="sendMessage" class="w-full">
              <div class="join w-full">
                <input
                  type="text"
                  x-model="input"
                  :disabled="loading"
                  placeholder="ã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“ã«è©±ã—ã‹ã‘ã¦ã­â™¡"
                  class="input input-bordered input-primary join-item flex-1"
                />
                <button
                  type="submit"
                  :disabled="loading || !input.trim()"
                  class="btn btn-primary join-item"
                >
                  <span x-show="!loading">é€ä¿¡ ğŸ’Œ</span>
                  <span
                    x-show="loading"
                    class="loading loading-spinner loading-sm"
                  ></span>
                </button>
              </div>
            </form>
          </div>

          <!-- Quick Actions -->
          <div class="flex flex-wrap gap-2 mt-3">
            <button
              @click="setQuickMessage('ã“ã‚“ã«ã¡ã¯ï¼')"
              class="btn btn-sm btn-outline btn-primary"
            >
              ğŸ‘‹ æŒ¨æ‹¶
            </button>
            <button
              @click="setQuickMessage('ä»Šæ—¥ã®èª¿å­ã¯ã©ã†ï¼Ÿ')"
              class="btn btn-sm btn-outline btn-secondary"
            >
              ğŸ’­ æ°—åˆ†
            </button>
            <button
              @click="setQuickMessage('é¢ç™½ã„è©±ã—ã¦ï¼')"
              class="btn btn-sm btn-outline btn-accent"
            >
              ğŸ­ é¢ç™½è©±
            </button>
            <button
              @click="setQuickMessage('ã‚¨ãƒªã‚·ã‚¢ã¡ã‚ƒã‚“ã®ã“ã¨æ•™ãˆã¦ï¼')"
              class="btn btn-sm btn-outline btn-info"
            >
              âœ¨ è‡ªå·±ç´¹ä»‹
            </button>
          </div>
        </div>
      </div>

      <!-- Settings & Self-Learning -->
      <div class="collapse collapse-arrow bg-base-200 mt-4">
        <input type="checkbox" />
        <div class="collapse-title font-medium">
          ğŸ§  è‡ªå·±å­¦ç¿’ï¼ˆFeedback & Knowledgeï¼‰
        </div>
        <div class="collapse-content">
          <div class="flex flex-wrap gap-2 mt-2">
            <button @click="sendFeedback('up')" class="btn btn-sm btn-success">
              ğŸ‘ è‰¯ã„
            </button>
            <button @click="sendFeedback('down')" class="btn btn-sm btn-error">
              ğŸ‘ æ”¹å–„
            </button>
            <button @click="upsertKnowledge()" class="btn btn-sm btn-secondary">
              â• ãƒŠãƒ¬ãƒƒã‚¸ç™»éŒ²
            </button>
            <button @click="loadKnowledgeReview()" class="btn btn-sm btn-info">
              ğŸ“š ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾—
            </button>
          </div>
          <pre
            x-text="reviewJson"
            class="bg-base-300 p-3 rounded mt-3 text-xs overflow-auto max-h-40"
          ></pre>
        </div>
      </div>

      <!-- Footer Info -->
      <div class="stats stats-horizontal shadow mt-4 bg-base-100">
        <div class="stat py-2">
          <div class="stat-title text-xs">ã‚·ã‚¹ãƒ†ãƒ </div>
          <div class="stat-value text-sm">ğŸ€ Elysia</div>
        </div>
        <div class="stat py-2">
          <div class="stat-title text-xs">RAG API</div>
          <div class="stat-value text-sm text-success">âœ“</div>
        </div>
        <div class="stat py-2">
          <div class="stat-title text-xs">Ollama</div>
          <div class="stat-value text-sm text-success">âœ“</div>
        </div>
        <div class="stat py-2">
          <div class="stat-title text-xs">å­¦ç¿’æ¸ˆã¿</div>
          <div class="stat-value text-sm">50+</div>
        </div>
      </div>
    </div>

    <script>
      function elysiaChat() {
        return {
          messages: [],
          input: "",
          loading: false,
          reviewJson: "",

          setQuickMessage(message) {
            if (!this.loading) {
              this.input = message;
              this.$nextTick(() => this.sendMessage());
            }
          },

          async sendMessage() {
            if (!this.input.trim() || this.loading) return;

            const userMessage = this.input.trim();
            this.messages.push({
              id: Date.now(),
              role: "user",
              content: userMessage,
            });
            this.input = "";
            this.loading = true;

            this.$nextTick(() => {
              const container = document.getElementById("chatContainer");
              container.scrollTop = container.scrollHeight;
            });

            try {
              let accessToken = localStorage.getItem("elysia_access_token");
              let refreshToken = localStorage.getItem("elysia_refresh_token");

              if (!accessToken || !refreshToken) {
                const username =
                  prompt("ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼å (default: elysia)") || "elysia";
                const pwd =
                  prompt("ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (default: elysia-dev-password)") ||
                  "elysia-dev-password";
                const authRes = await fetch("/auth/token", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ username, password: pwd }),
                });
                if (!authRes.ok) throw new Error("èªè¨¼å¤±æ•—");
                const authJson = await authRes.json();
                accessToken = authJson.accessToken;
                refreshToken = authJson.refreshToken;
                localStorage.setItem("elysia_access_token", accessToken);
                localStorage.setItem("elysia_refresh_token", refreshToken);
              }

              let response = await fetch("/elysia-love", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${accessToken}`,
                },
                body: JSON.stringify({
                  messages: this.messages.map((m) => ({
                    role: m.role,
                    content: m.content,
                  })),
                }),
              });

              if (response.status === 401) {
                const refreshRes = await fetch("/auth/refresh", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ refreshToken }),
                });
                if (!refreshRes.ok) {
                  localStorage.removeItem("elysia_access_token");
                  localStorage.removeItem("elysia_refresh_token");
                  throw new Error("ã‚»ãƒƒã‚·ãƒ§ãƒ³æœŸé™åˆ‡ã‚Œ");
                }
                const refreshJson = await refreshRes.json();
                accessToken = refreshJson.accessToken;
                localStorage.setItem("elysia_access_token", accessToken);
                response = await fetch("/elysia-love", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${accessToken}`,
                  },
                  body: JSON.stringify({
                    messages: this.messages.map((m) => ({
                      role: m.role,
                      content: m.content,
                    })),
                  }),
                });
              }

              if (!response.ok)
                throw new Error(`HTTP error! status: ${response.status}`);

              const reader = response.body.getReader();
              const decoder = new TextDecoder();

              const assistantMessage = {
                id: Date.now() + 1,
                role: "assistant",
                content: "",
              };
              this.messages.push(assistantMessage);

              while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split("\n");

                for (const line of lines) {
                  if (line.startsWith("data: ")) {
                    try {
                      const data = JSON.parse(line.slice(6));
                      if (data.content) {
                        assistantMessage.content += data.content;
                      }
                    } catch {}
                  }
                }

                this.$nextTick(() => {
                  const container = document.getElementById("chatContainer");
                  container.scrollTop = container.scrollHeight;
                });
              }
            } catch (error) {
              console.error("Error:", error);
              this.messages.push({
                id: Date.now() + 1,
                role: "assistant",
                content:
                  "ã”ã‚ã‚“ã­ã€œâ™¡ ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¡ã‚ƒã£ãŸâ€¦\n\nFastAPIã‚µãƒ¼ãƒãƒ¼ã¨OllamaãŒèµ·å‹•ã—ã¦ã‚‹ã‹ç¢ºèªã—ã¦ã­ï¼",
              });
            } finally {
              this.loading = false;
              this.$nextTick(() => {
                const container = document.getElementById("chatContainer");
                container.scrollTop = container.scrollHeight;
              });
            }
          },

          async ensureLogin() {
            let accessToken = localStorage.getItem("elysia_access_token");
            let refreshToken = localStorage.getItem("elysia_refresh_token");
            if (accessToken && refreshToken)
              return { accessToken, refreshToken };
            const username = prompt("ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼å") || "elysia";
            const pwd = prompt("ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰") || "elysia-dev-password";
            const authRes = await fetch("/auth/token", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username, password: pwd }),
            });
            if (!authRes.ok) throw new Error("èªè¨¼å¤±æ•—");
            const authJson = await authRes.json();
            accessToken = authJson.accessToken;
            refreshToken = authJson.refreshToken;
            localStorage.setItem("elysia_access_token", accessToken);
            localStorage.setItem("elysia_refresh_token", refreshToken);
            return { accessToken, refreshToken };
          },

          async sendFeedback(rating) {
            try {
              const { accessToken } = await this.ensureLogin();
              const payload = {
                query:
                  this.messages.filter((m) => m.role === "user").slice(-1)[0]
                    ?.content || "",
                answer:
                  this.messages
                    .filter((m) => m.role === "assistant")
                    .slice(-1)[0]?.content || "",
                rating,
                reason: rating === "down" ? "needs improvement" : "good",
              };
              const resp = await fetch("/feedback", {
                method: "POST",
                headers: {
                  "content-type": "application/json",
                  authorization: `Bearer ${accessToken}`,
                },
                body: JSON.stringify(payload),
              });
              if (!resp.ok) throw new Error(`Feedback failed: ${resp.status}`);
              alert("âœ¨ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ä¿å­˜ã—ãŸã‚ˆï¼");
            } catch (e) {
              alert("âš ï¸ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã§ã‚¨ãƒ©ãƒ¼: " + e.message);
            }
          },

          async upsertKnowledge() {
            try {
              const { accessToken } = await this.ensureLogin();
              const summary = prompt(
                "ç™»éŒ²ã™ã‚‹è¦ç´„ã‚’å…¥åŠ›ã—ã¦ã­â™¡",
                "Elysia knowledge note",
              );
              if (!summary) return;
              const payload = {
                summary,
                sourceUrl: location.href,
                tags: ["ui"],
                confidence: 0.9,
              };
              const resp = await fetch("/knowledge/upsert", {
                method: "POST",
                headers: {
                  "content-type": "application/json",
                  authorization: `Bearer ${accessToken}`,
                },
                body: JSON.stringify(payload),
              });
              if (!resp.ok) throw new Error(`Upsert failed: ${resp.status}`);
              alert("âœ¨ ãƒŠãƒ¬ãƒƒã‚¸ã‚’ä¿å­˜ã—ãŸã‚ˆï¼");
            } catch (e) {
              alert("âš ï¸ ãƒŠãƒ¬ãƒƒã‚¸ç™»éŒ²ã§ã‚¨ãƒ©ãƒ¼: " + e.message);
            }
          },

          async loadKnowledgeReview() {
            try {
              const { accessToken } = await this.ensureLogin();
              const resp = await fetch("/knowledge/review?n=10", {
                headers: { authorization: `Bearer ${accessToken}` },
              });
              if (!resp.ok) throw new Error(`Review failed: ${resp.status}`);
              const data = await resp.json();
              this.reviewJson = JSON.stringify(data, null, 2);
            } catch (e) {
              alert("âš ï¸ ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾—ã§ã‚¨ãƒ©ãƒ¼: " + e.message);
            }
          },
        };
      }
    </script>
  </body>
</html>
