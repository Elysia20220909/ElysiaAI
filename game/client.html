<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Elysia Network Game</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f5f5fa; }
    #board { border: 2px solid #888; width: 600px; height: 400px; background: #fff; box-shadow: 0 2px 8px #bbb; }
    .node { fill: #4fc3f7; stroke: #1976d2; stroke-width: 2; transition: fill 0.3s; }
    .agent { fill: #ffb74d; stroke: #f57c00; stroke-width: 2; filter: drop-shadow(0 0 6px #fbc02d); transition: fill 0.3s; }
    .winner { color: #d32f2f; font-weight: bold; font-size: 1.2em; animation: winnerFlash 1s infinite alternate; }
    #history { margin-top: 1em; font-size: 15px; background: #e3f2fd; padding: 8px; border-radius: 8px; min-height: 40px; }
    @keyframes winnerFlash { from { color: #d32f2f; } to { color: #fbc02d; } }
    .turn { font-weight: bold; color: #1976d2; margin-left: 1em; }
    .user-select { margin-left: 1em; }
  </style>
</head>
<body>
  <h1>Elysia風ネットワークゲーム</h1>
  <div>
    ユーザーID: <input id="userId" value="user1" style="width:80px">
    <span class="user-select">相手ID: <input id="opponentId" value="user2" style="width:80px"></span>
    <button onclick="startGame()">ゲーム開始</button>
    <button onclick="moveAgent()">エージェント移動</button>
    <span id="turn" class="turn"></span>
    <span id="winner" class="winner"></span>
  </div>
  <svg id="board" width="600" height="400"></svg>
  <div id="history"></div>
  <script>
    let state = null;
    let ws = null;
    function drawBoard() {
      const svg = document.getElementById('board');
      svg.innerHTML = '';
      if (!state) return;
      // ノード描画
      state.nodes.forEach((node, i) => {
        const x = 100 + i * 120, y = 200;
        svg.innerHTML += `<circle class='node' cx='${x}' cy='${y}' r='30'/><text x='${x-10}' y='${y+5}' font-size='16'>${node.id}</text>`;
      });
      // エージェント描画
      state.agents.forEach(agent => {
        const idx = state.nodes.findIndex(n => n.id === agent.position);
        if (idx >= 0) {
          const x = 100 + idx * 120, y = 150;
          svg.innerHTML += `<circle class='agent' cx='${x}' cy='${y}' r='15'/><text x='${x-10}' y='${y+5}' font-size='12'>${agent.id}(${agent.userId})[${agent.score}]</text>`;
        }
      });
      document.getElementById('turn').textContent = `ターン: ${state.turn}`;
      document.getElementById('winner').textContent = state.winner ? `Winner: ${state.winner}` : '';
      document.getElementById('history').innerHTML = state.history ? state.history.map(h=>`<div>${h}</div>`).join('') : '';
    }
    function startGame() {
      const userId = document.getElementById('userId').value;
      const opponentId = document.getElementById('opponentId').value;
      fetch('http://localhost:3001/game/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          nodes: [ {id:'A',connected:['B']}, {id:'B',connected:['A','C']}, {id:'C',connected:['B']} ],
          agents: [ {id:'P1',position:'A',userId:userId,score:0}, {id:'P2',position:'C',userId:opponentId,score:0} ]
        })
      }).then(r=>r.json()).then(s=>{ state=s; drawBoard(); });
      if (!ws) {
        ws = new WebSocket('ws://localhost:3001/game/ws');
        ws.onmessage = e => { state = JSON.parse(e.data); drawBoard(); };
      }
    }
    function moveAgent() {
      if (!state) return;
      const userId = document.getElementById('userId').value;
      const agent = state.agents.find(a => a.userId === userId);
      if (!agent) return;
      // 可能な移動先を選択（例: 最初のconnectedノード）
      const currentNode = state.nodes.find(n => n.id === agent.position);
      const to = currentNode && currentNode.connected[0] ? currentNode.connected[0] : agent.position;
      fetch('http://localhost:3001/game/action', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ agentId: agent.id, to, userId })
      }).then(r=>r.json()).then(s=>{ state=s; drawBoard(); });
      if (ws) ws.send(JSON.stringify({ agentId: agent.id, to, userId }));
    }
  </script>
</body>
</html>
