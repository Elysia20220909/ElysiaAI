(()=>{"use strict";var e,t,s,r,n,a,i,o,c={24:e=>{e.exports=require("node:fs")},74:(e,t,s)=>{s.d(t,{m:()=>u});const r=require("cron");var n=s(935),a=s(121),i=s(654),o=s(922),c=s(629);const u=new class{tasks;constructor(){this.tasks=new Map}initializeDefaultTasks(){this.addTask("daily-report","0 9 * * *",async()=>{c.v.info("Running daily report task");const e=new Date,t=new Date(e.getTime()-864e5);await i.f.generateReport("daily",t,e)},"true"===process.env.DAILY_REPORT_ENABLED),this.addTask("weekly-report","0 10 * * 1",async()=>{c.v.info("Running weekly report task");const e=new Date,t=new Date(e.getTime()-6048e5);await i.f.generateReport("weekly",t,e)},"true"===process.env.WEEKLY_REPORT_ENABLED),this.addTask("monthly-report","0 10 1 * *",async()=>{c.v.info("Running monthly report task");const e=new Date,t=new Date(e.getFullYear(),e.getMonth()-1,1);await i.f.generateReport("monthly",t,e)},"true"===process.env.MONTHLY_REPORT_ENABLED),this.addTask("db-backup","0 3 * * *",async()=>{c.v.info("Running database backup task"),await n.m.triggerManualBackup()},!0),this.addTask("log-cleanup","0 4 * * *",async()=>{c.v.info("Running log cleanup task"),await o.logCleanupManager.triggerManualCleanup()},!0),this.addTask("file-cleanup","0 5 * * 0",async()=>{c.v.info("Running file cleanup task"),a.r.cleanupOldFiles(30)},!0),this.addTask("health-check","*/10 * * * *",async()=>{const{healthMonitor:e}=await Promise.resolve().then(s.bind(s,732));await e.runCheck("database"),await e.runCheck("ollama")},"true"===process.env.HEALTH_CHECK_CRON_ENABLED),c.v.info("Cron scheduler initialized",{tasks:this.tasks.size})}addTask(e,t,s,n=!0){try{const a=new r.CronJob(t,async()=>{try{await s(),c.v.info("Cron task completed",{name:e})}catch(t){c.v.error(`Cron task failed: ${e}`,t)}},null,n,"Asia/Tokyo");this.tasks.set(e,{name:e,cronTime:t,job:a,enabled:n}),n&&(a.start(),c.v.info("Cron task added",{name:e,cronTime:t}))}catch(t){c.v.error(`Failed to add cron task: ${e}`,t)}}enableTask(e){const t=this.tasks.get(e);t&&!t.enabled&&(t.job.start(),t.enabled=!0,c.v.info("Cron task enabled",{name:e}))}disableTask(e){const t=this.tasks.get(e);t?.enabled&&(t.job.stop(),t.enabled=!1,c.v.info("Cron task disabled",{name:e}))}removeTask(e){const t=this.tasks.get(e);t&&(t.job.stop(),this.tasks.delete(e),c.v.info("Cron task removed",{name:e}))}listTasks(){return Array.from(this.tasks.values()).map(e=>({name:e.name,cronTime:e.cronTime,enabled:e.enabled,nextRun:e.enabled?e.job.nextDate().toJSDate():null}))}async runTask(e){const t=this.tasks.get(e);if(!t)throw new Error(`Task not found: ${e}`);c.v.info("Running cron task manually",{name:e}),t.job.fireOnTick()}stopAll(){for(const e of this.tasks.values())e.job.stop();c.v.info("All cron tasks stopped")}getStats(){const e=Array.from(this.tasks.values());return{totalTasks:e.length,enabledTasks:e.filter(e=>e.enabled).length,disabledTasks:e.filter(e=>!e.enabled).length,nextRuns:e.filter(e=>e.enabled).map(e=>({name:e.name,nextRun:e.job.nextDate().toJSDate()}))}}}},95:(e,t,s)=>{s.d(t,{n:()=>n});var r=s(629);const n=new class{tests;userAssignments;constructor(){this.tests=new Map,this.userAssignments=new Map,this.initializeDefaultTests()}initializeDefaultTests(){this.createTest({id:"prompt-style",name:"ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ãƒ†ã‚¹ãƒˆ",description:"ç•°ãªã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã®åŠ¹æœã‚’æ¸¬å®š",variants:[{id:"original",name:"ã‚ªãƒªã‚¸ãƒŠãƒ«",weight:50,config:{style:"original"}},{id:"detailed",name:"è©³ç´°æŒ‡ç¤º",weight:50,config:{style:"detailed"}}]}),this.createTest({id:"response-length",name:"ãƒ¬ã‚¹ãƒãƒ³ã‚¹é•·ãƒ†ã‚¹ãƒˆ",description:"çŸ­ã„å›ç­” vs é•·ã„å›ç­”",variants:[{id:"short",name:"çŸ­ã„å›ç­”",weight:50,config:{maxTokens:150}},{id:"long",name:"é•·ã„å›ç­”",weight:50,config:{maxTokens:500}}]})}createTest(e){const t={id:e.id,name:e.name,description:e.description,variants:e.variants,active:!0,startDate:new Date,endDate:e.endDate,metrics:{impressions:new Map,conversions:new Map,averageRating:new Map}};for(const e of t.variants)t.metrics.impressions.set(e.id,0),t.metrics.conversions.set(e.id,0),t.metrics.averageRating.set(e.id,[]);return this.tests.set(t.id,t),r.v.info("A/B test created",{id:t.id,name:t.name,variants:t.variants.length}),t}assignVariant(e,t){const s=this.tests.get(e);if(!s||!s.active)return null;this.userAssignments.has(t)||this.userAssignments.set(t,new Map);const r=this.userAssignments.get(t);if(r?.has(e)){const t=r.get(e);return s.variants.find(e=>e.id===t)||null}const n=s.variants.reduce((e,t)=>e+t.weight,0);let a=Math.random()*n,i=null;for(const e of s.variants)if(a-=e.weight,a<=0){i=e;break}if(i){r?.set(e,i.id);const t=s.metrics.impressions.get(i.id)||0;s.metrics.impressions.set(i.id,t+1)}return i}recordConversion(e,t){const s=this.tests.get(e);if(!s)return;const n=this.userAssignments.get(t)?.get(e);if(!n)return;const a=s.metrics.conversions.get(n)||0;s.metrics.conversions.set(n,a+1),r.v.debug("A/B test conversion recorded",{testId:e,variantId:n,userId:t})}recordRating(e,t,s){const r=this.tests.get(e);if(!r)return;const n=this.userAssignments.get(t)?.get(e);if(!n)return;const a=r.metrics.averageRating.get(n)||[];a.push(s),r.metrics.averageRating.set(n,a)}getTestResults(e){const t=this.tests.get(e);if(!t)return null;const s=t.variants.map(e=>{const s=t.metrics.impressions.get(e.id)||0,r=t.metrics.conversions.get(e.id)||0,n=t.metrics.averageRating.get(e.id)||[],a=n.length>0?n.reduce((e,t)=>e+t,0)/n.length:0;return{variantId:e.id,name:e.name,impressions:s,conversions:r,conversionRate:s>0?r/s*100:0,averageRating:a,sampleSize:n.length}});return{testId:t.id,name:t.name,description:t.description,active:t.active,startDate:t.startDate,endDate:t.endDate,results:s}}endTest(e){const t=this.tests.get(e);t&&(t.active=!1,t.endDate=new Date,r.v.info("A/B test ended",{testId:e,name:t.name}))}listTests(){return Array.from(this.tests.values()).map(e=>({id:e.id,name:e.name,description:e.description,active:e.active,startDate:e.startDate,endDate:e.endDate,variantCount:e.variants.length}))}}},112:(e,t,s)=>{s.d(t,{Ql:()=>a,Y9:()=>n});const r=require("node:process"),n=new class{spans=new Map;activeSpans=new Map;enabled;constructor(e=!0){this.enabled=e}generateTraceId(){const e=new Uint8Array(16);return crypto.getRandomValues(e),Array.from(e).map(e=>e.toString(16).padStart(2,"0")).join("")}generateSpanId(){const e=new Uint8Array(8);return crypto.getRandomValues(e),Array.from(e).map(e=>e.toString(16).padStart(2,"0")).join("")}parseTraceContext(e){if(!e)return null;const t=e.split("-");if(4!==t.length)return null;const[s,r,n,a]=t;return"00"!==s?null:{traceId:r,spanId:n,traceFlags:Number.parseInt(a,16)}}createTraceContext(e,t,s=!0){return`00-${e}-${t}-${s?"01":"00"}`}startSpan(e,t){if(!this.enabled)return this.createDummySpan(e);const s=t?.parentContext?.traceId||this.generateTraceId(),n=this.generateSpanId(),a=t?.parentContext?.spanId,i={traceId:s,spanId:n,parentSpanId:a,name:e,startTime:r.hrtime.bigint(),attributes:t?.attributes||{},events:[],status:{code:"UNSET"}};return this.spans.set(n,i),t?.contextId&&this.activeSpans.set(t.contextId,n),i}endSpan(e,t){const s=this.spans.get(e);if(s){s.endTime=r.hrtime.bigint(),s.duration=Number(s.endTime-s.startTime)/1e6,s.status=t||{code:"OK"};for(const[t,s]of this.activeSpans.entries())s===e&&this.activeSpans.delete(t)}}addEvent(e,t,s){const n=this.spans.get(e);n&&n.events.push({name:t,timestamp:r.hrtime.bigint(),attributes:s})}setAttribute(e,t,s){const r=this.spans.get(e);r&&(r.attributes[t]=s)}setStatus(e,t){const s=this.spans.get(e);s&&(s.status=t)}getSpan(e){return this.spans.get(e)}getActiveSpan(e){const t=this.activeSpans.get(e);return t?this.spans.get(t):void 0}getTrace(e){return Array.from(this.spans.values()).filter(t=>t.traceId===e)}exportSpans(){const e=Array.from(this.spans.values()).filter(e=>void 0!==e.endTime);for(const t of e)this.spans.delete(t.spanId);return e}createDummySpan(e){return{traceId:"",spanId:"",name:e,startTime:r.hrtime.bigint(),attributes:{},events:[],status:{code:"UNSET"}}}async trace(e,t,s){const r=this.startSpan(e,s);try{const e=await t(r);return this.endSpan(r.spanId,{code:"OK"}),e}catch(e){throw this.endSpan(r.spanId,{code:"ERROR",message:e instanceof Error?e.message:"Unknown error"}),e}}getStats(){const e=Array.from(this.spans.values()),t=e.filter(e=>void 0!==e.endTime),s=e.filter(e=>void 0===e.endTime),r=t.reduce((e,t)=>e+(t.duration||0),0)/t.length||0;return{totalSpans:e.length,activeSpans:s.length,completedSpans:t.length,averageDuration:r,traces:new Set(e.map(e=>e.traceId)).size}}clear(){this.spans.clear(),this.activeSpans.clear()}setEnabled(e){this.enabled=e}}("false"!==process.env.TELEMETRY_ENABLED);function a(e){const t=e.headers.get("traceparent");return n.parseTraceContext(t||void 0)}},121:(e,t,s)=>{s.d(t,{r:()=>o});var r=s(598),n=s(24),a=s(760),i=s(629);const o=new class{UPLOAD_DIR;MAX_SIZE_MB;ALLOWED_TYPES;files;constructor(){this.UPLOAD_DIR=process.env.UPLOAD_DIR||"./uploads",this.MAX_SIZE_MB=Number(process.env.MAX_UPLOAD_SIZE_MB)||10,this.ALLOWED_TYPES=["image/jpeg","image/png","image/gif","image/webp","application/pdf","text/plain","text/markdown"],this.files=new Map,n.existsSync(this.UPLOAD_DIR)||n.mkdirSync(this.UPLOAD_DIR,{recursive:!0})}async upload(e,t,s,o={}){const c=1024*(o.maxSizeMB||this.MAX_SIZE_MB)*1024;if(e.length>c)throw new Error(`File size exceeds ${o.maxSizeMB||this.MAX_SIZE_MB}MB limit`);if(!(o.allowedTypes||this.ALLOWED_TYPES).includes(s))throw new Error(`File type ${s} is not allowed`);const u=r.randomBytes(16).toString("hex"),l=`${u}${a.extname(t)}`,d=a.join(this.UPLOAD_DIR,l);n.writeFileSync(d,e);const h={id:u,originalName:t,filename:l,path:d,size:e.length,mimeType:s,userId:o.userId,uploadedAt:new Date};return this.files.set(u,h),i.v.info("File uploaded",{fileId:u,originalName:t,size:e.length}),h}getFile(e){return this.files.get(e)}readFile(e){const t=this.files.get(e);if(!t)return null;try{return n.readFileSync(t.path)}catch(e){return i.v.error("Failed to read file",e),null}}deleteFile(e,t){const s=this.files.get(e);if(!s)return!1;if(t&&s.userId!==t)return i.v.warn("Unauthorized file deletion attempt",{fileId:e,userId:t}),!1;try{return n.unlinkSync(s.path),this.files.delete(e),i.v.info("File deleted",{fileId:e}),!0}catch(e){return i.v.error("Failed to delete file",e),!1}}getUserFiles(e){return Array.from(this.files.values()).filter(t=>t.userId===e)}listFiles(){return Array.from(this.files.values())}cleanupOldFiles(e=30){const t=new Date,s=new Date(t.getTime()-24*e*60*60*1e3);let r=0;for(const[e,t]of this.files.entries())t.uploadedAt<s&&this.deleteFile(e)&&r++;return i.v.info("Old files cleaned up",{deletedCount:r,maxAgeDays:e}),r}getStorageStats(){let e=0;const t={};for(const s of this.files.values())e+=s.size,t[s.mimeType]=(t[s.mimeType]||0)+1;return{totalFiles:this.files.size,totalSizeMB:(e/1024/1024).toFixed(2),filesByType:t}}}},132:(e,t,s)=>{s.d(t,{$:()=>n});var r=s(629);const n=new class{subscriptions;constructor(){this.subscriptions=new Map,this.loadSubscriptionsFromEnv()}loadSubscriptionsFromEnv(){const e=process.env.DISCORD_WEBHOOK_URL,t=process.env.SLACK_WEBHOOK_URL,s=process.env.CUSTOM_WEBHOOK_URL;e&&this.subscribe("discord",{url:e,events:["error.critical","system.health_check_failed","rate_limit.exceeded"],enabled:!0}),t&&this.subscribe("slack",{url:t,events:["user.registered","backup.completed","error.critical"],enabled:!0}),s&&this.subscribe("custom",{url:s,events:["chat.message","feedback.created"],secret:process.env.CUSTOM_WEBHOOK_SECRET,enabled:!0})}subscribe(e,t){this.subscriptions.set(e,t),r.v.info(`Webhook subscribed: ${e}`,{events:t.events})}unsubscribe(e){this.subscriptions.delete(e),r.v.info(`Webhook unsubscribed: ${e}`)}async emit(e,t){const s={event:e,timestamp:new Date,data:t},r=[];for(const[t,n]of this.subscriptions.entries())n.enabled&&n.events.includes(e)&&r.push(this.sendWebhook(t,n,s));await Promise.allSettled(r)}async sendWebhook(e,t,s){try{const n={"Content-Type":"application/json"};if(t.secret){const e=await this.generateSignature(JSON.stringify(s),t.secret);n["X-Webhook-Signature"]=e}const a=await fetch(t.url,{method:"POST",headers:n,body:JSON.stringify(s)});a.ok?r.v.debug(`Webhook delivered: ${e}`,{event:s.event}):r.v.warn(`Webhook delivery failed: ${e}`,{status:a.status})}catch(t){r.v.error(`Webhook error: ${e}`,t)}}async generateSignature(e,t){const s=new TextEncoder,r=s.encode(t),n=s.encode(e),a=await crypto.subtle.importKey("raw",r,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),i=await crypto.subtle.sign("HMAC",a,n);return Array.from(new Uint8Array(i)).map(e=>e.toString(16).padStart(2,"0")).join("")}getSubscriptions(){return Array.from(this.subscriptions.entries()).map(([e,t])=>({name:e,events:t.events,enabled:t.enabled}))}toggleSubscription(e,t){const s=this.subscriptions.get(e);s&&(s.enabled=t,r.v.info(`Webhook ${t?"enabled":"disabled"}: ${e}`))}}},172:(e,t,s)=>{s.d(t,{x:()=>i});const r=require("nodemailer");var n=s.n(r),a=s(629);const i=new class{transporter;config;constructor(){this.config={enabled:"true"===process.env.EMAIL_NOTIFICATIONS_ENABLED,host:process.env.SMTP_HOST||"smtp.gmail.com",port:Number(process.env.SMTP_PORT)||587,secure:"true"===process.env.SMTP_SECURE,auth:{user:process.env.SMTP_USER||"",pass:process.env.SMTP_PASS||""},from:process.env.EMAIL_FROM||"noreply@elysia-ai.com"},this.config.enabled&&this.config.auth.user&&this.config.auth.pass&&this.initializeTransporter()}initializeTransporter(){try{this.transporter=n().createTransport({host:this.config.host,port:this.config.port,secure:this.config.secure,auth:this.config.auth}),a.v.info("Email transporter initialized",{host:this.config.host,port:this.config.port})}catch(e){a.v.error("Failed to initialize email transporter",e)}}async send(e){if(!this.config.enabled)return a.v.debug("Email notifications are disabled"),!1;if(!this.transporter)return a.v.warn("Email transporter not initialized"),!1;try{const t=await this.transporter.sendMail({from:this.config.from,to:Array.isArray(e.to)?e.to.join(", "):e.to,subject:e.subject,text:e.text,html:e.html});return a.v.info("Email sent",{messageId:t.messageId,to:e.to,subject:e.subject}),!0}catch(e){return a.v.error("Failed to send email",e),!1}}async sendErrorNotification(e,t){const s=process.env.ADMIN_EMAIL;if(!s)return;const r=`\n\t\t\t<h2>ğŸš¨ ã‚¨ãƒªã‚·ã‚¢AI - ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ</h2>\n\t\t\t<p><strong>ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong> ${e.message}</p>\n\t\t\t<p><strong>ç™ºç”Ÿæ™‚åˆ»:</strong> ${(new Date).toLocaleString("ja-JP")}</p>\n\t\t\t${t?`<p><strong>ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ:</strong> <pre>${JSON.stringify(t,null,2)}</pre></p>`:""}\n\t\t\t${e.stack?`<p><strong>ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:</strong> <pre>${e.stack}</pre></p>`:""}\n\t\t`;await this.send({to:s,subject:`[ã‚¨ãƒªã‚·ã‚¢AI] ã‚¨ãƒ©ãƒ¼é€šçŸ¥: ${e.message}`,html:r})}async sendWelcomeEmail(e,t){const s=`\n\t\t\t<h2>ğŸ‰ ã‚¨ãƒªã‚·ã‚¢AIã¸ã‚ˆã†ã“ãï¼</h2>\n\t\t\t<p>ã“ã‚“ã«ã¡ã¯ã€${t}ã•ã‚“â™¡</p>\n\t\t\t<p>ã‚¨ãƒªã‚·ã‚¢AIã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼</p>\n\t\t\t<p>ã•ã£ãããƒãƒ£ãƒƒãƒˆã‚’å§‹ã‚ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>\n\t\t\t<hr>\n\t\t\t<p><small>ã“ã®ãƒ¡ãƒ¼ãƒ«ã«å¿ƒå½“ãŸã‚ŠãŒãªã„å ´åˆã¯ã€ç„¡è¦–ã—ã¦ãã ã•ã„ã€‚</small></p>\n\t\t`;await this.send({to:e,subject:"ã‚¨ãƒªã‚·ã‚¢AIã¸ã‚ˆã†ã“ãï¼",html:s})}async sendBackupNotification(e){const t=process.env.ADMIN_EMAIL;if(!t)return;const s=`\n\t\t\t<h2>âœ… è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†</h2>\n\t\t\t<p><strong>ãƒ•ã‚¡ã‚¤ãƒ«:</strong> ${e.file}</p>\n\t\t\t<p><strong>ã‚µã‚¤ã‚º:</strong> ${(e.size/1024/1024).toFixed(2)} MB</p>\n\t\t\t<p><strong>å‡¦ç†æ™‚é–“:</strong> ${e.duration}ms</p>\n\t\t\t<p><strong>å®Œäº†æ™‚åˆ»:</strong> ${(new Date).toLocaleString("ja-JP")}</p>\n\t\t`;await this.send({to:t,subject:"[ã‚¨ãƒªã‚·ã‚¢AI] è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†",html:s})}async sendHealthCheckFailure(e,t){const s=process.env.ADMIN_EMAIL;if(!s)return;const r=`\n\t\t\t<h2>âš ï¸ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—</h2>\n\t\t\t<p><strong>ã‚µãƒ¼ãƒ“ã‚¹:</strong> ${e}</p>\n\t\t\t<p><strong>è©³ç´°:</strong> ${t}</p>\n\t\t\t<p><strong>ç™ºç”Ÿæ™‚åˆ»:</strong> ${(new Date).toLocaleString("ja-JP")}</p>\n\t\t\t<p>æ—©æ€¥ã«ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>\n\t\t`;await this.send({to:s,subject:`[ã‚¨ãƒªã‚·ã‚¢AI] ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—: ${e}`,html:r})}getStatus(){return{enabled:this.config.enabled,configured:!!this.transporter,host:this.config.host,port:this.config.port,from:this.config.from}}}},229:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{default:()=>j});var n=s(24),a=s(836),i=s(696),o=s(855),c=s(811),u=s(938),l=s.n(u),d=s(931),h=s(829),g=s.n(h),p=s(583),m=s.n(p),f=s(970),y=s(237),v=s(807),w=s(95),k=s(257),b=s(371),_=s(695),S=s(935),E=s(74),T=s(828),I=s(709),R=s(121),A=s(703),D=s(732),L=s(654),O=s(922),x=s(629),M=s(644),q=s(619),C=s(112),B=s(132);(0,I.x)(),S.m.start(),D.healthMonitor.start(),O.logCleanupManager.start(),await L.f.initialize(),E.m.initializeDefaultTasks();const $={PORT:Number(process.env.PORT)||3e3,RAG_API_URL:v.r.RAG_API_URL,RAG_TIMEOUT:v.r.RAG_TIMEOUT,MODEL_NAME:process.env.MODEL_NAME||"llama3.2",MAX_REQUESTS_PER_MINUTE:Number(process.env.RATE_LIMIT_RPM)||60,ALLOWED_ORIGINS:process.env.ALLOWED_ORIGINS?.split(",")||["http://localhost:3000"],AUTH_USERNAME:process.env.AUTH_USERNAME||"elysia",AUTH_PASSWORD:process.env.AUTH_PASSWORD||"elysia-dev-password",JWT_SECRET:process.env.JWT_SECRET||"dev-secret",JWT_REFRESH_SECRET:process.env.JWT_REFRESH_SECRET||"dev-refresh-secret"};function P(e,t){return new Response(JSON.stringify({error:t}),{status:e,headers:{"content-type":"application/json"}})}async function U(e){try{return await(0,y.HY)(e,$.MAX_REQUESTS_PER_MINUTE)}catch{return!0}}const W=(0,_.W)({excludePaths:["/ping","/health","/metrics","/swagger"],excludeMethods:["OPTIONS"],includeBody:!1}),N=(new d.Elysia).use((0,a.cors)({origin:$.ALLOWED_ORIGINS})).use((0,i.html)()).use((0,o.staticPlugin)({assets:"public"})).use((0,c.swagger)({path:"/swagger"})).onBeforeHandle(({request:e})=>{const t=new URL(e.url).pathname,s=(0,C.Ql)(e),r=C.Y9.startSpan(`HTTP ${e.method} ${t}`,{parentContext:s||void 0,attributes:{"http.method":e.method,"http.url":e.url,"http.route":t}});e.__span=r,e.__startTime=Date.now(),M.D.incrementRequest(e.method,t,200)}).onBeforeHandle(W.beforeHandle).onError(({error:e,code:t,request:s,set:r})=>{const n=new URL(s.url),a=e instanceof Error?e.message:String(e),i=`${String(t)}: ${a} at ${n.pathname}`;x.v.error(i),M.D.incrementError(s.method,n.pathname,String(t));const o=s.__span;return o&&C.Y9.endSpan(o.spanId,{code:"ERROR",message:a}),W.onError({request:s,error:e,set:r}),P(500,e instanceof Error?e.message:"Internal server error")}).onAfterHandle(({set:e,request:t,response:s})=>{e.headers["X-Content-Type-Options"]="nosniff",e.headers["X-Frame-Options"]="DENY";const r=t,n=r.__span;n&&(e.headers.traceparent=C.Y9.createTraceContext(n.traceId,n.spanId),C.Y9.endSpan(n.spanId));const a=r.__startTime;if(a){const e=(Date.now()-a)/1e3,s=new URL(t.url);M.D.recordRequestDuration(t.method,s.pathname,e)}W.afterHandle({request:t,set:e,response:s})}).get("/ping",()=>({ok:!0}),{detail:{tags:["health"],summary:"Health check endpoint",description:"Returns a simple OK response to verify server is running"}}).get("/health",async()=>{try{const e=process.env.REDIS_URL||"redis://localhost:6379",t=await(0,A.uY)(e,$.RAG_API_URL,$.MODEL_NAME),s="healthy"===t.status?200:503;return new Response(JSON.stringify(t),{status:s,headers:{"content-type":"application/json"}})}catch(e){const t=e instanceof Error?e.message:String(e);return x.v.error(`Health check failed: ${t}`),P(503,"Health check failed")}},{detail:{tags:["health"],summary:"Detailed health check",description:"Check status of Redis, FastAPI, Ollama, and system metrics"}}).get("/metrics",()=>{const e=M.D.toPrometheusFormat();return new Response(e,{headers:{"content-type":"text/plain; version=0.0.4"}})},{detail:{tags:["monitoring"],summary:"Prometheus metrics",description:"Expose metrics in Prometheus format"}}).get("/",()=>Bun.file("public/index.html"),{detail:{tags:["ui"],summary:"Portfolio index page",description:"Serves the main Elysia AI portfolio and chat interface"}}).post("/feedback",async({body:e,request:t})=>{const s=t.headers.get("authorization")||"";if(!s.startsWith("Bearer "))return P(401,"Missing Bearer token");let r;try{r=g().verify(s.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}(0,n.existsSync)("data")||(0,n.mkdirSync)("data",{recursive:!0}),t.headers.get("x-forwarded-for");const a=r.userId||void 0;try{await T.feedbackService.create({userId:a,query:e.query,answer:e.answer,rating:e.rating,reason:e.reason||void 0})}catch(e){return x.v.error("Failed to store feedback",e instanceof Error?e:void 0),P(500,"Failed to store feedback")}return new Response(JSON.stringify({ok:!0}),{headers:{"content-type":"application/json"}})},{body:d.t.Object({query:d.t.String({minLength:1,maxLength:400}),answer:d.t.String({minLength:1,maxLength:4e3}),rating:d.t.Union([d.t.Literal("up"),d.t.Literal("down")]),reason:d.t.Optional(d.t.String({maxLength:256}))}),detail:{tags:["feedback"],summary:"Submit user feedback",description:"Submit feedback for a query-answer pair. Requires JWT authentication.",security:[{bearerAuth:[]}]}}).post("/knowledge/upsert",async({body:e,request:t})=>{const s=t.headers.get("authorization")||"";if(!s.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(s.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}try{await T.knowledgeService.create({question:e.summary,answer:e.sourceUrl||"No source provided",source:"api",verified:e.confidence>.8})}catch(e){return x.v.error("Failed to store knowledge",e instanceof Error?e:void 0),P(500,"Failed to store knowledge")}return new Response(JSON.stringify({ok:!0}),{headers:{"content-type":"application/json"}})},{body:d.t.Object({summary:d.t.String({minLength:10,maxLength:2e3}),sourceUrl:d.t.Optional(d.t.String()),tags:d.t.Optional(d.t.Array(d.t.String({maxLength:32}),{maxItems:8})),confidence:d.t.Number({minimum:0,maximum:1})}),detail:{tags:["knowledge"],summary:"Add or update knowledge entry",description:"Store a new knowledge entry with summary, source, tags, and confidence. Requires JWT.",security:[{bearerAuth:[]}]}}).get("/knowledge/review",async({request:e,query:t})=>{const s=e.headers.get("authorization")||"";if(!s.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(s.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}const r=Number(t?.n??20)||20;try{if(!(0,n.existsSync)("data/knowledge.jsonl"))return new Response(JSON.stringify([]),{headers:{"content-type":"application/json"}});const e=(await Bun.file("data/knowledge.jsonl").text()).trim().split("\n").filter(Boolean),t=e.slice(Math.max(0,e.length-r)).map(e=>JSON.parse(e));return new Response(JSON.stringify(t),{headers:{"content-type":"application/json"}})}catch{return P(500,"Failed to read knowledge")}},{query:d.t.Object({n:d.t.Optional(d.t.Number())}),detail:{tags:["knowledge"],summary:"Get recent knowledge entries",description:"Retrieve the last N knowledge entries from the knowledge base. Requires JWT.",security:[{bearerAuth:[]}]}}).post("/auth/token",async({body:e})=>{const{username:t,password:s}=e;if(t!==$.AUTH_USERNAME||s!==$.AUTH_PASSWORD)return P(401,"Invalid credentials");const r=t,n=g().sign({iss:"elysia-ai",userId:r,iat:Math.floor(Date.now()/1e3)},$.JWT_SECRET,{expiresIn:"15m"}),a=g().sign({iss:"elysia-ai-refresh",userId:r,iat:Math.floor(Date.now()/1e3)},$.JWT_REFRESH_SECRET,{expiresIn:"7d"});return await(0,y.OL)(r,a,604800),new Response(JSON.stringify({accessToken:n,refreshToken:a,expiresIn:900}),{headers:{"content-type":"application/json"}})},{body:d.t.Object({username:d.t.String({minLength:1,maxLength:128}),password:d.t.String({minLength:1,maxLength:128})}),detail:{tags:["auth"],summary:"Login and get JWT tokens",description:"Authenticate with username and password to receive access token (15min) and refresh token (7 days)"}}).post("/auth/refresh",async({body:e})=>{const{refreshToken:t}=e;let s;try{s=g().verify(t,$.JWT_REFRESH_SECRET)}catch{return P(401,"Invalid or expired refresh token")}const r=s.userId||"default-user";if(!await(0,y.tj)(r,t))return P(401,"Refresh token not found or revoked");const n=g().sign({iss:"elysia-ai",userId:r,iat:Math.floor(Date.now()/1e3)},$.JWT_SECRET,{expiresIn:"15m"});return new Response(JSON.stringify({accessToken:n,expiresIn:900}),{headers:{"content-type":"application/json"}})},{body:d.t.Object({refreshToken:d.t.String({minLength:20})}),detail:{tags:["auth"],summary:"Refresh access token",description:"Exchange a valid refresh token for a new access token without re-authentication"}}).post("/auth/logout",async({body:e})=>{const{refreshToken:t}=e;try{const e=g().verify(t,$.JWT_REFRESH_SECRET).userId||"default-user";return await(0,y.ln)(e),new Response(JSON.stringify({message:"Logged out successfully"}),{headers:{"content-type":"application/json"}})}catch{return P(400,"Invalid refresh token")}},{body:d.t.Object({refreshToken:d.t.String({minLength:20})}),detail:{tags:["auth"],summary:"Logout and revoke refresh token",description:"Revoke a refresh token to prevent future token refreshes. Effectively logs out the user."}}).guard({beforeHandle:({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))throw new Error("Missing Bearer token");try{g().verify(t.substring(7),$.JWT_SECRET)}catch{throw new Error("Invalid or expired token")}}},e=>e.post("/elysia-love",async({body:e,request:t})=>{const s=t.headers.get("x-forwarded-for")||"anon";let r="anon";const n=t.headers.get("authorization")||"";try{n.startsWith("Bearer ")&&(r=g().verify(n.substring(7),$.JWT_SECRET).userId||"anon")}catch{}const a=`${r}:${s}`;if(!await U(a))return P(429,"Rate limit exceeded");const i=e.mode||f.Cm,o=f.V_[i],c=e.messages.map(e=>{const t=m()(e.content,{allowedTags:[],allowedAttributes:{}});if(s=t,[/\b(drop|delete)\b/i,/<script/i].some(e=>e.test(s)))throw new Error("Dangerous content detected");var s;return{...e,content:t}}),u=[{role:"system",content:o.systemPrompt},...c];try{const e=await l().post($.RAG_API_URL,{messages:u,temperature:o.temperature,model:o.model},{responseType:"stream",timeout:$.RAG_TIMEOUT});return new Response(e.data,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive","X-Elysia-Mode":i}})}catch(e){return l().isAxiosError(e)&&503===e.response?.status?P(503,"Upstream unavailable"):P(500,"Internal chat error")}},{body:d.t.Object({messages:d.t.Array(d.t.Object({role:d.t.Union([d.t.Literal("user"),d.t.Literal("assistant"),d.t.Literal("system")]),content:d.t.String({maxLength:400,minLength:1})}),{maxItems:8}),mode:d.t.Optional(d.t.Union([d.t.Literal("sweet"),d.t.Literal("normal"),d.t.Literal("professional")]))}),detail:{tags:["chat"],summary:"Chat with Elysia AI (Multi-LLM)",description:"Send chat messages to Elysia AI with selectable personality modes (sweet/normal/professional). Returns streaming SSE response. Requires JWT.",security:[{bearerAuth:[]}]}})).get("/admin/feedback/stats",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(t.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}const s=await T.feedbackService.getStats();return new Response(JSON.stringify(s),{headers:{"content-type":"application/json"}})},{detail:{tags:["admin"],summary:"Get feedback statistics",security:[{bearerAuth:[]}]}}).get("/admin/feedback",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(t.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}const s=await T.feedbackService.getRecent(100);return new Response(JSON.stringify(s),{headers:{"content-type":"application/json"}})},{detail:{tags:["admin"],summary:"Get recent feedback",security:[{bearerAuth:[]}]}}).get("/admin/knowledge",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(t.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}const s=await T.knowledgeService.getAll(!1);return new Response(JSON.stringify(s),{headers:{"content-type":"application/json"}})},{detail:{tags:["admin"],summary:"Get all knowledge entries",security:[{bearerAuth:[]}]}}).post("/admin/knowledge/:id/verify",async({params:e,request:t})=>{const s=t.headers.get("authorization")||"";if(!s.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(s.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}return await T.knowledgeService.verify(e.id),new Response(JSON.stringify({ok:!0}),{headers:{"content-type":"application/json"}})},{detail:{tags:["admin"],summary:"Verify knowledge entry",security:[{bearerAuth:[]}]}}).delete("/admin/knowledge/:id",async({params:e,request:t})=>{const s=t.headers.get("authorization")||"";if(!s.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(s.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}return await T.knowledgeService.delete(e.id),new Response(JSON.stringify({ok:!0}),{headers:{"content-type":"application/json"}})},{detail:{tags:["admin"],summary:"Delete knowledge entry",security:[{bearerAuth:[]}]}});N.post("/auth/register",async({body:e})=>{const{username:t,password:r}=e;if(await T.Dv.findByUsername(t))return P(400,"Username already exists");if(r.length<8)return P(400,"Password must be at least 8 characters");try{const{createUser:e}=await s.e(615).then(s.bind(s,615)),n=await e(t,r,"user");return new Response(JSON.stringify({success:!0,userId:n.id,username:n.username}),{headers:{"content-type":"application/json"}})}catch(e){return x.v.error("Registration failed",e instanceof Error?e:void 0),P(500,"Registration failed")}},{body:d.t.Object({username:d.t.String({minLength:3,maxLength:32}),password:d.t.String({minLength:8,maxLength:128})}),detail:{tags:["auth"],summary:"Register new user"}}),N.get("/admin/export/feedback",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(t.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}const{exportFeedbackToCSV:r}=await s.e(508).then(s.bind(s,508)),n=await r();return new Response(n,{headers:{"content-type":"text/csv; charset=utf-8","content-disposition":`attachment; filename="feedback_${(new Date).toISOString().split("T")[0]}.csv"`}})}),N.get("/admin/export/knowledge/json",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(t.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}const{exportKnowledgeToJSON:r}=await s.e(508).then(s.bind(s,508)),n=await r();return new Response(n,{headers:{"content-type":"application/json; charset=utf-8","content-disposition":`attachment; filename="knowledge_${(new Date).toISOString().split("T")[0]}.json"`}})}),N.get("/admin/analytics",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(t.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}const{apiAnalytics:r}=await s.e(404).then(s.bind(s,404)),n=r.exportJSON();return new Response(JSON.stringify(n),{headers:{"content-type":"application/json"}})}),N.get("/admin/webhooks",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(t.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}return{webhooks:B.$.getSubscriptions()}}),N.post("/admin/api-keys",async({request:e,body:t})=>{const s=e.headers.get("authorization")||"";if(!s.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(s.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}const{name:r,rateLimit:n,expiresInDays:a}=t;return{success:!0,key:k.X.generateKey({name:r,rateLimit:n,expiresInDays:a}).key}},{body:d.t.Object({name:d.t.String({minLength:1}),rateLimit:d.t.Optional(d.t.Number()),expiresInDays:d.t.Optional(d.t.Number())})}),N.get("/admin/api-keys",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(t.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}return{keys:k.X.listKeys(),stats:k.X.getUsageStats()}}),N.get("/admin/backups",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(t.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}return{status:S.m.getStatus(),history:S.m.getBackupHistory()}}),N.post("/admin/backups/trigger",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(t.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}return await S.m.triggerManualBackup(),{success:!0,message:"Backup triggered"}}),N.get("/admin/health-monitor",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(t.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}return D.healthMonitor.getStatus()}),N.get("/admin/sessions",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");try{const e=g().verify(t.substring(7),$.JWT_SECRET);return{sessions:q.i.getUserSessions(e.userId),stats:q.i.getStats()}}catch{return P(401,"Invalid token")}}),N.get("/admin/ab-tests",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(t.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}return{tests:w.n.listTests()}}),N.get("/admin/ab-tests/:testId",async({request:e,params:t})=>{const s=e.headers.get("authorization")||"";if(!s.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(s.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}return w.n.getTestResults(t.testId)||P(404,"Test not found")}),N.get("/admin/logs/cleanup",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(t.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}return O.logCleanupManager.getStats()}),N.post("/admin/logs/cleanup/trigger",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(t.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}return await O.logCleanupManager.triggerManualCleanup(),{success:!0,message:"Log cleanup triggered"}}),N.get("/admin/jobs/stats",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(t.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}return await L.f.getStats()}),N.post("/admin/jobs/email",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(t.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}const s=await e.json();return{success:!0,jobId:(await L.f.sendEmail(s.to,s.subject,s.html)).id}}),N.post("/admin/jobs/report",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(t.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}const s=await e.json();return{success:!0,jobId:(await L.f.generateReport(s.reportType,new Date(s.startDate),new Date(s.endDate))).id}}),N.post("/upload",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");let s;try{s=g().verify(t.substring(7),$.JWT_SECRET).username}catch{return P(401,"Invalid token")}const r=(await e.formData()).get("file");if(!r)return P(400,"No file provided");const n=Buffer.from(await r.arrayBuffer()),a=await R.r.upload(n,r.name,r.type,{userId:s});return{success:!0,file:{id:a.id,originalName:a.originalName,size:a.size,mimeType:a.mimeType}}}),N.get("/files/:fileId",async({request:e,params:t})=>{const s=e.headers.get("authorization")||"";if(!s.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(s.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}const{fileId:r}=t,n=R.r.getFile(r);if(!n)return P(404,"File not found");const a=R.r.readFile(r);return a?new Response(new Uint8Array(a),{headers:{"content-type":n.mimeType,"content-disposition":`attachment; filename="${n.originalName}"`}}):P(404,"File not found")}),N.get("/files",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");let s;try{s=g().verify(t.substring(7),$.JWT_SECRET).username}catch{return P(401,"Invalid token")}return{files:R.r.getUserFiles(s).map(e=>({id:e.id,originalName:e.originalName,size:e.size,mimeType:e.mimeType,uploadedAt:e.uploadedAt}))}}),N.get("/admin/cron/tasks",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(t.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}return{tasks:E.m.listTasks()}}),N.get("/admin/cron/stats",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(t.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}return E.m.getStats()}),N.post("/admin/cron/tasks/:name/run",async({request:e,params:t})=>{const s=e.headers.get("authorization")||"";if(!s.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(s.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}try{return await E.m.runTask(t.name),{success:!0,message:`Task ${t.name} executed`}}catch(e){return P(400,e.message)}}),N.get("/admin/audit/logs",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(t.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}const s=new URL(e.url);return b._.search({userId:s.searchParams.get("userId")||void 0,action:s.searchParams.get("action")||void 0,resource:s.searchParams.get("resource")||void 0,limit:Number(s.searchParams.get("limit"))||100,offset:Number(s.searchParams.get("offset"))||0})}),N.get("/admin/audit/stats",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(t.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}return b._.getStats()}),N.get("/admin/audit/export",async({request:e})=>{const t=e.headers.get("authorization")||"";if(!t.startsWith("Bearer "))return P(401,"Missing Bearer token");try{g().verify(t.substring(7),$.JWT_SECRET)}catch{return P(401,"Invalid token")}const s=new URL(e.url).searchParams.get("format")||"json",r=b._.export(s);return r?new Response(r,{headers:{"content-type":"json"===s?"application/json":"text/csv","content-disposition":`attachment; filename="audit-logs.${s}"`}}):P(400,"Invalid format")});const j=N;r()}catch(F){r(F)}},1)},237:(e,t,s)=>{s.d(t,{HY:()=>c,ln:()=>d,OL:()=>u,tj:()=>l}),s(829),process.env.JWT_SECRET,process.env.JWT_REFRESH_SECRET;var r=s(659),n=s.n(r);const a={REDIS_URL:process.env.REDIS_URL||"redis://localhost:6379",REDIS_ENABLED:"false"!==process.env.REDIS_ENABLED};let i=null,o=!1;if(a.REDIS_ENABLED)try{i=new(n())(a.REDIS_URL,{maxRetriesPerRequest:3,retryStrategy:e=>e>3?(o=!1,null):Math.min(100*e,2e3),lazyConnect:!0}),i.on("connect",()=>{o=!0}),i.on("error",()=>{o=!1}),i.connect().catch(()=>{o=!1})}catch{i=null,o=!1}async function c(e,t,s=60){if(!i||!o)return!0;try{const r=`ratelimit:${e}`,n=Date.now(),a=n-1e3*s;await i.zremrangebyscore(r,0,a),await i.zadd(r,n,`${n}:${Math.random()}`);const o=await i.zcard(r);return await i.expire(r,s),o<=t}catch{return!0}}async function u(e,t,s=604800){if(i&&o)try{const r=`refresh:${e}`;await i.setex(r,s,t)}catch{}}async function l(e,t){if(!i||!o)return!1;try{const s=`refresh:${e}`;return await i.get(s)===t}catch{return!1}}async function d(e){if(i&&o)try{const t=`refresh:${e}`;await i.del(t)}catch{}}},257:(e,t,s)=>{s.d(t,{X:()=>a});var r=s(598),n=s(629);const a=new class{keys;KEY_PREFIX="elysia_";constructor(){this.keys=new Map,this.loadKeysFromEnv()}loadKeysFromEnv(){const e=process.env.MASTER_API_KEY;e&&this.keys.set(e,{key:e,name:"Master Key",createdAt:new Date,enabled:!0,rateLimit:1e4,usage:{totalRequests:0,requestsThisHour:0,hourStart:new Date}})}generateKey(e){const t=r.randomBytes(32),s=`${this.KEY_PREFIX}${t.toString("base64url")}`,a=e.expiresInDays?new Date(Date.now()+24*e.expiresInDays*60*60*1e3):void 0,i={key:s,name:e.name,userId:e.userId,createdAt:new Date,expiresAt:a,enabled:!0,rateLimit:e.rateLimit||1e3,usage:{totalRequests:0,requestsThisHour:0,hourStart:new Date}};return this.keys.set(s,i),n.v.info("API key generated",{name:e.name,userId:e.userId,rateLimit:i.rateLimit}),i}validateKey(e){const t=this.keys.get(e);if(!t)return{valid:!1,reason:"Invalid API key"};if(!t.enabled)return{valid:!1,reason:"API key is disabled"};if(t.expiresAt&&t.expiresAt<new Date)return{valid:!1,reason:"API key has expired"};const s=new Date;return(s.getTime()-t.usage.hourStart.getTime())/36e5>=1&&(t.usage.requestsThisHour=0,t.usage.hourStart=s),t.usage.requestsThisHour>=t.rateLimit?{valid:!1,reason:`Rate limit exceeded (${t.rateLimit} requests/hour)`}:{valid:!0,apiKey:t}}recordUsage(e){const t=this.keys.get(e);t&&(t.usage.totalRequests++,t.usage.requestsThisHour++,t.usage.lastUsed=new Date)}revokeKey(e){const t=this.keys.get(e);return!!t&&(t.enabled=!1,n.v.info("API key revoked",{name:t.name}),!0)}deleteKey(e){const t=this.keys.get(e);return!!t&&(this.keys.delete(e),n.v.info("API key deleted",{name:t.name}),!0)}listKeys(){return Array.from(this.keys.values()).map(e=>({name:e.name,userId:e.userId,createdAt:e.createdAt,expiresAt:e.expiresAt,enabled:e.enabled,rateLimit:e.rateLimit,usage:{totalRequests:e.usage.totalRequests,lastUsed:e.usage.lastUsed,requestsThisHour:e.usage.requestsThisHour},keyPreview:`${e.key.substring(0,16)}...`}))}getUserKeys(e){return Array.from(this.keys.values()).filter(t=>t.userId===e).map(e=>({name:e.name,createdAt:e.createdAt,expiresAt:e.expiresAt,enabled:e.enabled,rateLimit:e.rateLimit,usage:e.usage,keyPreview:`${e.key.substring(0,16)}...`}))}getUsageStats(){const e=Array.from(this.keys.values());return{totalKeys:e.length,activeKeys:e.filter(e=>e.enabled).length,expiredKeys:e.filter(e=>e.expiresAt&&e.expiresAt<new Date).length,totalRequests:e.reduce((e,t)=>e+t.usage.totalRequests,0),topKeys:e.sort((e,t)=>t.usage.totalRequests-e.usage.totalRequests).slice(0,5).map(e=>({name:e.name,requests:e.usage.totalRequests}))}}}},330:e=>{e.exports=require("@prisma/client")},371:(e,t,s)=>{s.d(t,{_:()=>i});var r=s(24),n=s(760),a=s(629);const i=new class{LOG_DIR;LOG_FILE;logs;logCounter;constructor(){this.LOG_DIR=process.env.AUDIT_LOG_DIR||"./logs/audit",this.LOG_FILE=n.join(this.LOG_DIR,"audit.jsonl"),this.logs=[],this.logCounter=0,r.existsSync(this.LOG_DIR)||r.mkdirSync(this.LOG_DIR,{recursive:!0}),this.loadLogs()}loadLogs(){if(r.existsSync(this.LOG_FILE))try{const e=r.readFileSync(this.LOG_FILE,"utf-8").split("\n").filter(e=>e.trim());for(const t of e)try{const e=JSON.parse(t);e.timestamp=new Date(e.timestamp),this.logs.push(e)}catch{}a.v.info("Audit logs loaded",{count:this.logs.length})}catch(e){a.v.error("Failed to load audit logs",e)}}log(e){const t={id:`audit-${Date.now()}-${++this.logCounter}`,timestamp:new Date,...e};this.logs.push(t);try{r.appendFileSync(this.LOG_FILE,`${JSON.stringify(t)}\n`)}catch(e){a.v.error("Failed to write audit log",e)}a.v.debug("Audit log recorded",{id:t.id,action:t.action,resource:t.resource})}search(e={}){let t=[...this.logs];if(e.userId&&(t=t.filter(t=>t.userId===e.userId)),e.action&&(t=t.filter(t=>t.action===e.action)),e.resource&&(t=t.filter(t=>t.resource===e.resource)),e.startDate){const s=e.startDate;t=t.filter(e=>e.timestamp>=s)}if(e.endDate){const s=e.endDate;t=t.filter(e=>e.timestamp<=s)}t.sort((e,t)=>t.timestamp.getTime()-e.timestamp.getTime());const s=t.length,r=e.offset||0,n=e.limit||100;return{logs:t.slice(r,r+n),total:s,offset:r,limit:n}}getUserActivity(e,t=20){return this.search({userId:e,limit:t}).logs}getResourceHistory(e,t){return this.logs.filter(s=>s.resource===e&&s.resourceId===t).sort((e,t)=>t.timestamp.getTime()-e.timestamp.getTime())}getStats(){const e=new Date,t=new Date(e.getTime()-864e5),s=new Date(e.getTime()-6048e5),r=this.logs.filter(e=>e.timestamp>=t),n=this.logs.filter(e=>e.timestamp>=s),a={},i={};for(const e of r)a[e.action]=(a[e.action]||0)+1,e.userId&&(i[e.userId]=(i[e.userId]||0)+1);return{totalLogs:this.logs.length,last24Hours:r.length,last7Days:n.length,topActions:Object.entries(a).sort(([,e],[,t])=>t-e).slice(0,10).map(([e,t])=>({action:e,count:t})),topUsers:Object.entries(i).sort(([,e],[,t])=>t-e).slice(0,10).map(([e,t])=>({userId:e,count:t}))}}cleanupOldLogs(e=90){const t=new Date(Date.now()-24*e*60*60*1e3),s=this.logs.length;this.logs=this.logs.filter(e=>e.timestamp>=t);try{const t=this.logs.map(e=>JSON.stringify(e)).join("\n");return r.writeFileSync(this.LOG_FILE,`${t}\n`),a.v.info("Old audit logs cleaned up",{deleted:s-this.logs.length,remaining:this.logs.length,maxAgeDays:e}),s-this.logs.length}catch(e){return a.v.error("Failed to cleanup audit logs",e),0}}export(e,t={}){const{logs:s}=this.search(t);if("json"===e)return JSON.stringify(s,null,2);if("csv"===e){const e=["ID","Timestamp","User ID","Action","Resource","Resource ID","Method","Path","IP Address","Status Code"],t=s.map(e=>[e.id,e.timestamp.toISOString(),e.userId||"",e.action,e.resource,e.resourceId||"",e.method,e.path,e.ipAddress,e.statusCode.toString()]);return[e.join(","),...t.map(e=>e.join(","))].join("\n")}return null}}},522:e=>{e.exports=require("node:zlib")},583:e=>{e.exports=require("sanitize-html")},598:e=>{e.exports=require("node:crypto")},619:(e,t,s)=>{s.d(t,{i:()=>n});var r=s(629);const n=new class{sessions;userSessions;SESSION_TIMEOUT=864e5;MAX_SESSIONS_PER_USER=5;constructor(){this.sessions=new Map,this.userSessions=new Map,setInterval(()=>{this.cleanupExpiredSessions()},36e5)}createSession(e,t,s){const n=this.userSessions.get(e);if(n&&n.size>=this.MAX_SESSIONS_PER_USER){const t=this.getOldestSession(e);t&&this.terminateSession(t.sessionId)}const a=this.generateSessionId(),i=new Date,o={sessionId:a,userId:e,deviceInfo:{userAgent:t,ip:s,deviceType:this.detectDeviceType(t)},createdAt:i,lastActivity:i,expiresAt:new Date(i.getTime()+this.SESSION_TIMEOUT),active:!0,activityLog:[{type:"login",timestamp:i}]};return this.sessions.set(a,o),this.userSessions.has(e)||this.userSessions.set(e,new Set),this.userSessions.get(e)?.add(a),r.v.info("Session created",{sessionId:a,userId:e,deviceType:o.deviceInfo.deviceType}),o}generateSessionId(){return`sess_${Date.now()}_${Math.random().toString(36).substring(2,15)}`}detectDeviceType(e){const t=e.toLowerCase();return/mobile|android|iphone/i.test(t)?"mobile":/tablet|ipad/i.test(t)?"tablet":/windows|macintosh|linux/i.test(t)?"desktop":"unknown"}validateSession(e){const t=this.sessions.get(e);return t&&t.active?t.expiresAt<new Date?(this.terminateSession(e),null):(t.lastActivity=new Date,t):null}recordActivity(e,t,s){const r=this.sessions.get(e);r&&(r.activityLog.push({type:t,timestamp:new Date,details:s}),r.lastActivity=new Date,r.activityLog.length>100&&(r.activityLog=r.activityLog.slice(-100)))}terminateSession(e){const t=this.sessions.get(e);if(!t)return;t.active=!1,this.recordActivity(e,"logout");const s=this.userSessions.get(t.userId);s?.delete(e),r.v.info("Session terminated",{sessionId:e,userId:t.userId})}getUserSessions(e){const t=this.userSessions.get(e);return t?Array.from(t).map(e=>this.sessions.get(e)).filter(e=>void 0!==e).map(e=>({sessionId:e.sessionId,deviceType:e.deviceInfo.deviceType,ip:e.deviceInfo.ip,createdAt:e.createdAt,lastActivity:e.lastActivity,active:e.active,activityCount:e.activityLog.length})):[]}getSessionDetails(e){const t=this.sessions.get(e);return t?{sessionId:t.sessionId,userId:t.userId,deviceInfo:t.deviceInfo,createdAt:t.createdAt,lastActivity:t.lastActivity,expiresAt:t.expiresAt,active:t.active,activityLog:t.activityLog.slice(-20)}:null}getOldestSession(e){const t=this.userSessions.get(e);if(!t)return;let s;for(const e of t){const t=this.sessions.get(e);t&&(!s||t.createdAt<s.createdAt)&&(s=t)}return s}cleanupExpiredSessions(){const e=new Date;let t=0;for(const[s,r]of this.sessions.entries())(r.expiresAt<e||!r.active)&&(this.sessions.delete(s),this.userSessions.get(r.userId)?.delete(s),t++);t>0&&r.v.info("Expired sessions cleaned up",{count:t})}getStats(){const e=Array.from(this.sessions.values()),t=e.filter(e=>e.active);return{totalSessions:e.length,activeSessions:t.length,uniqueUsers:this.userSessions.size,deviceBreakdown:{mobile:t.filter(e=>"mobile"===e.deviceInfo.deviceType).length,tablet:t.filter(e=>"tablet"===e.deviceInfo.deviceType).length,desktop:t.filter(e=>"desktop"===e.deviceInfo.deviceType).length}}}}},629:(e,t,s)=>{s.d(t,{v:()=>a});var r=s(24),n=s(760);const a=new class{logDir;logFile;minLevel;levelPriority={trace:0,debug:1,info:2,warn:3,error:4,fatal:5};constructor(e="logs",t="info"){this.logDir=e,this.minLevel=t,this.logFile=(0,n.join)(e,`app-${(new Date).toISOString().split("T")[0]}.log`),(0,r.existsSync)(e)||(0,r.mkdirSync)(e,{recursive:!0})}shouldLog(e){return this.levelPriority[e]>=this.levelPriority[this.minLevel]}formatLog(e){return`${JSON.stringify(e)}\n`}writeLog(e){if(!this.shouldLog(e.level))return;const t={trace:"[90m",debug:"[36m",info:"[32m",warn:"[33m",error:"[31m",fatal:"[35m"}[e.level];console.log(`${t}[${e.level.toUpperCase()}][0m ${e.timestamp} ${e.message}`,e.context?e.context:"");try{(0,r.appendFileSync)(this.logFile,this.formatLog(e))}catch(e){console.error("Failed to write to log file:",e)}}trace(e,t){this.writeLog({level:"trace",timestamp:(new Date).toISOString(),message:e,context:t})}debug(e,t){this.writeLog({level:"debug",timestamp:(new Date).toISOString(),message:e,context:t})}info(e,t){this.writeLog({level:"info",timestamp:(new Date).toISOString(),message:e,context:t})}warn(e,t){this.writeLog({level:"warn",timestamp:(new Date).toISOString(),message:e,context:t})}error(e,t,s){this.writeLog({level:"error",timestamp:(new Date).toISOString(),message:e,context:s,error:t?{name:t.name,message:t.message,stack:t.stack}:void 0})}fatal(e,t,s){this.writeLog({level:"fatal",timestamp:(new Date).toISOString(),message:e,context:s,error:t?{name:t.name,message:t.message,stack:t.stack}:void 0})}logRequest(e,t,s,r,n,a){const i=s>=500?"error":s>=400?"warn":"info";this.writeLog({level:i,timestamp:(new Date).toISOString(),message:`${e} ${t} ${s}`,request:{method:e,path:t,ip:n,userId:a},duration:r})}rotateLogs(e=30){const t=Date.now(),a=24*e*60*60*1e3;if(!(0,r.existsSync)(this.logDir))return;const i=s(24),o=i.readdirSync(this.logDir);for(const e of o){const s=(0,n.join)(this.logDir,e);t-i.statSync(s).mtimeMs>a&&(i.unlinkSync(s),this.info(`Rotated old log file: ${e}`))}}}("logs",process.env.LOG_LEVEL||"info")},644:(e,t,s)=>{s.d(t,{D:()=>r});const r=new class{metrics={http_requests_total:new Map,http_request_duration_seconds:new Map,http_errors_total:new Map,active_connections:0,chat_requests_total:0,feedback_submissions_total:0,auth_attempts_total:new Map,rate_limit_exceeded_total:0,rag_queries_total:0,rag_query_duration_seconds:[]};incrementRequest(e,t,s){const r=`${e}:${t}:${s}`,n=this.metrics.http_requests_total.get(r)||0;this.metrics.http_requests_total.set(r,n+1)}recordRequestDuration(e,t,s){const r=`${e}:${t}`,n=this.metrics.http_request_duration_seconds.get(r)||[];n.push(s),n.length>1e3&&n.shift(),this.metrics.http_request_duration_seconds.set(r,n)}incrementError(e,t,s){const r=`${e}:${t}:${s}`,n=this.metrics.http_errors_total.get(r)||0;this.metrics.http_errors_total.set(r,n+1)}incrementConnections(){this.metrics.active_connections++}decrementConnections(){this.metrics.active_connections=Math.max(0,this.metrics.active_connections-1)}incrementChatRequests(){this.metrics.chat_requests_total++}incrementFeedback(){this.metrics.feedback_submissions_total++}incrementAuthAttempt(e){const t=e?"success":"failure",s=this.metrics.auth_attempts_total.get(t)||0;this.metrics.auth_attempts_total.set(t,s+1)}incrementRateLimit(){this.metrics.rate_limit_exceeded_total++}incrementRAGQuery(){this.metrics.rag_queries_total++}recordRAGDuration(e){this.metrics.rag_query_duration_seconds.push(e),this.metrics.rag_query_duration_seconds.length>1e3&&this.metrics.rag_query_duration_seconds.shift()}getMetrics(){return{...this.metrics}}toPrometheusFormat(){const e=[];e.push("# HELP http_requests_total Total HTTP requests"),e.push("# TYPE http_requests_total counter");for(const[t,s]of this.metrics.http_requests_total){const[r,n,a]=t.split(":");e.push(`http_requests_total{method="${r}",path="${n}",status="${a}"} ${s}`)}e.push("# HELP http_request_duration_seconds HTTP request duration in seconds"),e.push("# TYPE http_request_duration_seconds histogram");for(const[t,s]of this.metrics.http_request_duration_seconds){const[r,n]=t.split(":"),a=[...s].sort((e,t)=>e-t),i=a.reduce((e,t)=>e+t,0)/a.length,o=a[Math.floor(.5*a.length)]||0,c=a[Math.floor(.95*a.length)]||0,u=a[Math.floor(.99*a.length)]||0;e.push(`http_request_duration_seconds_avg{method="${r}",path="${n}"} ${i.toFixed(4)}`),e.push(`http_request_duration_seconds{method="${r}",path="${n}",quantile="0.5"} ${o.toFixed(4)}`),e.push(`http_request_duration_seconds{method="${r}",path="${n}",quantile="0.95"} ${c.toFixed(4)}`),e.push(`http_request_duration_seconds{method="${r}",path="${n}",quantile="0.99"} ${u.toFixed(4)}`)}e.push("# HELP http_errors_total Total HTTP errors"),e.push("# TYPE http_errors_total counter");for(const[t,s]of this.metrics.http_errors_total){const[r,n,a]=t.split(":");e.push(`http_errors_total{method="${r}",path="${n}",type="${a}"} ${s}`)}e.push("# HELP active_connections Current active connections"),e.push("# TYPE active_connections gauge"),e.push(`active_connections ${this.metrics.active_connections}`),e.push("# HELP chat_requests_total Total chat requests"),e.push("# TYPE chat_requests_total counter"),e.push(`chat_requests_total ${this.metrics.chat_requests_total}`),e.push("# HELP feedback_submissions_total Total feedback submissions"),e.push("# TYPE feedback_submissions_total counter"),e.push(`feedback_submissions_total ${this.metrics.feedback_submissions_total}`),e.push("# HELP auth_attempts_total Total authentication attempts"),e.push("# TYPE auth_attempts_total counter");for(const[t,s]of this.metrics.auth_attempts_total)e.push(`auth_attempts_total{result="${t}"} ${s}`);if(e.push("# HELP rate_limit_exceeded_total Total rate limit exceeded"),e.push("# TYPE rate_limit_exceeded_total counter"),e.push(`rate_limit_exceeded_total ${this.metrics.rate_limit_exceeded_total}`),e.push("# HELP rag_queries_total Total RAG queries"),e.push("# TYPE rag_queries_total counter"),e.push(`rag_queries_total ${this.metrics.rag_queries_total}`),this.metrics.rag_query_duration_seconds.length>0){e.push("# HELP rag_query_duration_seconds RAG query duration"),e.push("# TYPE rag_query_duration_seconds histogram");const t=[...this.metrics.rag_query_duration_seconds].sort((e,t)=>e-t),s=t.reduce((e,t)=>e+t,0)/t.length,r=t[Math.floor(.5*t.length)]||0,n=t[Math.floor(.95*t.length)]||0,a=t[Math.floor(.99*t.length)]||0;e.push(`rag_query_duration_seconds_avg ${s.toFixed(4)}`),e.push(`rag_query_duration_seconds{quantile="0.5"} ${r.toFixed(4)}`),e.push(`rag_query_duration_seconds{quantile="0.95"} ${n.toFixed(4)}`),e.push(`rag_query_duration_seconds{quantile="0.99"} ${a.toFixed(4)}`)}const t=process.memoryUsage();return e.push("# HELP process_memory_bytes Process memory usage"),e.push("# TYPE process_memory_bytes gauge"),e.push(`process_memory_bytes{type="heap_used"} ${t.heapUsed}`),e.push(`process_memory_bytes{type="heap_total"} ${t.heapTotal}`),e.push(`process_memory_bytes{type="rss"} ${t.rss}`),e.push("# HELP process_uptime_seconds Process uptime in seconds"),e.push("# TYPE process_uptime_seconds gauge"),e.push(`process_uptime_seconds ${process.uptime()}`),`${e.join("\n")}\n`}}},654:(e,t,s)=>{s.d(t,{f:()=>o});const r=require("bullmq");var n=s(172),a=s(629),i=s(132);const o=new class{queue=null;worker=null;REDIS_URL;constructor(){this.REDIS_URL=process.env.REDIS_URL||"redis://localhost:6379"}async initialize(){try{const e={host:new URL(this.REDIS_URL).hostname,port:Number(new URL(this.REDIS_URL).port)||6379};this.queue=new r.Queue("elysia-jobs",{connection:e}),this.worker=new r.Worker("elysia-jobs",async e=>await this.processJob(e),{connection:e}),this.worker.on("completed",e=>{a.v.info("Job completed",{jobId:e.id,type:e.data.type})}),this.worker.on("failed",(e,t)=>{a.v.error("Job failed",t)}),a.v.info("Job queue initialized",{connection:this.REDIS_URL})}catch(e){a.v.warn("Job queue unavailable, using in-memory fallback",{error:e.message})}}async processJob(e){const{type:t,payload:s}=e.data;switch(t){case"send-email":return await this.handleEmailJob(s);case"generate-report":return await this.handleReportJob(s);case"cleanup-old-data":return await this.handleCleanupJob();case"send-webhook":return await this.handleWebhookJob(s);default:throw new Error(`Unknown job type: ${t}`)}}async handleEmailJob(e){return await n.x.send({to:e.to,subject:e.subject,html:e.html}),{success:!0,sentAt:new Date}}async handleReportJob(e){a.v.info("Generating report",{type:e.reportType});const{feedbackService:t,knowledgeService:r}=await Promise.resolve().then(s.bind(s,828)),i=await t.getRecent(100),o=await r.getAll(),c={type:e.reportType,period:{start:e.startDate,end:e.endDate},statistics:{totalFeedbacks:i.length,positiveFeedbacks:i.filter(e=>"up"===e.rating).length,negativeFeedbacks:i.filter(e=>"down"===e.rating).length,totalKnowledge:o.length,verifiedKnowledge:o.filter(e=>e.verified).length},generatedAt:new Date},u=process.env.ADMIN_EMAIL;return u&&await n.x.send({to:u,subject:`[ã‚¨ãƒªã‚·ã‚¢AI] ${e.reportType}ãƒ¬ãƒãƒ¼ãƒˆ`,html:`\n\t\t\t\t\t<h2>ğŸ“Š ${e.reportType}ãƒ¬ãƒãƒ¼ãƒˆ</h2>\n\t\t\t\t\t<ul>\n\t\t\t\t\t\t<li>ç·ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯: ${c.statistics.totalFeedbacks}</li>\n\t\t\t\t\t\t<li>ãƒã‚¸ãƒ†ã‚£ãƒ–: ${c.statistics.positiveFeedbacks}</li>\n\t\t\t\t\t\t<li>ãƒã‚¬ãƒ†ã‚£ãƒ–: ${c.statistics.negativeFeedbacks}</li>\n\t\t\t\t\t\t<li>ç·ãƒŠãƒ¬ãƒƒã‚¸: ${c.statistics.totalKnowledge}</li>\n\t\t\t\t\t\t<li>æ¤œè¨¼æ¸ˆã¿: ${c.statistics.verifiedKnowledge}</li>\n\t\t\t\t\t</ul>\n\t\t\t\t\t<p><small>ç”Ÿæˆæ—¥æ™‚: ${c.generatedAt.toLocaleString("ja-JP")}</small></p>\n\t\t\t\t`}),c}async handleCleanupJob(){a.v.info("Running data cleanup job");const{logCleanupManager:e}=await Promise.resolve().then(s.bind(s,922));return await e.triggerManualCleanup(),{success:!0,cleanedAt:new Date}}async handleWebhookJob(e){const{event:t,data:s}=e;return await i.$.emit(t,s),{success:!0,sentAt:new Date}}async addJob(e,t,s={}){if(!this.queue)return a.v.warn("Queue not available, executing job immediately"),await this.processJob({data:{type:e,payload:t}});const r=await this.queue.add(e,{type:e,payload:t},s);return a.v.debug("Job added to queue",{jobId:r.id,type:e}),r}async sendEmail(e,t,s){return await this.addJob("send-email",{to:e,subject:t,html:s})}async generateReport(e,t,s){return await this.addJob("generate-report",{reportType:e,startDate:t,endDate:s})}async scheduleCleanup(){return await this.addJob("cleanup-old-data",{})}async getStats(){if(!this.queue)return{available:!1};const[e,t,s,r]=await Promise.all([this.queue.getWaitingCount(),this.queue.getActiveCount(),this.queue.getCompletedCount(),this.queue.getFailedCount()]);return{available:!0,waiting:e,active:t,completed:s,failed:r}}async close(){this.worker&&await this.worker.close(),this.queue&&await this.queue.close(),a.v.info("Job queue closed")}}},659:e=>{e.exports=require("ioredis")},695:(e,t,s)=>{s.d(t,{W:()=>a});var r=s(371);const n=new WeakMap;function a(e={}){const{excludePaths:t=["/health","/metrics","/swagger"],excludeMethods:a=["OPTIONS"],includeBody:o=!1}=e;return{beforeHandle:async e=>{const{request:s}=e,r=new URL(s.url);t.some(e=>r.pathname.startsWith(e))||a.includes(s.method)||n.set(s,{startTime:Date.now(),url:r.pathname,method:s.method})},afterHandle:async(e,t)=>{const{request:a,set:o}=e;if(!n.get(a))return;const c=new URL(a.url),u=o.status||200,l=a.headers.get("authorization")||"";let d;if(l.startsWith("Bearer "))try{d=(await Promise.resolve().then(s.t.bind(s,829,23))).verify(l.substring(7),process.env.JWT_SECRET||"dev-secret").username}catch{}const h=function(e,t){if(t.includes("/login")||t.includes("/auth"))return"AUTH";if(t.includes("/register"))return"REGISTER";if(t.includes("/logout"))return"LOGOUT";switch(e){case"GET":return"READ";case"POST":return"CREATE";case"PUT":case"PATCH":return"UPDATE";case"DELETE":return"DELETE";default:return e}}(a.method,c.pathname),g=i(c.pathname),p=function(e){const t=e.match(/\/([^/]+)\/([a-zA-Z0-9-]+)$/);if(t?.[2])return t[2]}(c.pathname);r._.log({userId:d,action:h,resource:g,resourceId:p,method:a.method,path:c.pathname,ipAddress:a.headers.get("x-forwarded-for")||a.headers.get("x-real-ip")||"127.0.0.1",userAgent:a.headers.get("user-agent")||"unknown",statusCode:u}),n.delete(a)},onError:async(e,t)=>{const{request:s}=e;if(!n.get(s))return;const a=new URL(s.url);r._.log({action:"ERROR",resource:i(a.pathname),method:s.method,path:a.pathname,ipAddress:s.headers.get("x-forwarded-for")||s.headers.get("x-real-ip")||"127.0.0.1",userAgent:s.headers.get("user-agent")||"unknown",statusCode:500,error:t.message})}}}function i(e){return e.includes("/feedback")?"feedback":e.includes("/knowledge")?"knowledge":e.includes("/user")?"user":e.includes("/chat")?"chat":e.includes("/upload")||e.includes("/files")?"file":e.includes("/jobs")?"job":e.includes("/cron")?"cron":e.includes("/audit")?"audit":e.includes("/admin")?"admin":e.includes("/session")?"session":e.includes("/api-key")?"api-key":"unknown"}},696:e=>{e.exports=require("@elysiajs/html")},703:(e,t,s)=>{s.d(t,{uY:()=>l});var r=s(938),n=s.n(r),a=s(659),i=s.n(a);async function o(e){const t=Date.now();try{const s=new(i())(e,{connectTimeout:5e3,maxRetriesPerRequest:1});await s.ping();const r=Date.now()-t,n=await s.info("server");return n.match(/redis_version:(.+)/)?.[1]?.trim(),s.disconnect(),{status:r<100?"up":"degraded",responseTime:r,lastCheck:(new Date).toISOString()}}catch(e){return{status:"down",error:e instanceof Error?e.message:"Unknown error",lastCheck:(new Date).toISOString()}}}async function c(e){const t=Date.now();try{const s=await n().get(`${e}/health`,{timeout:5e3,validateStatus:e=>e<500}),r=Date.now()-t;return 200===s.status?{status:r<200?"up":"degraded",responseTime:r,lastCheck:(new Date).toISOString()}:{status:"degraded",responseTime:r,error:`HTTP ${s.status}`,lastCheck:(new Date).toISOString()}}catch(e){return{status:"down",error:e instanceof Error?e.message:"Connection failed",lastCheck:(new Date).toISOString()}}}async function u(e){const t=Date.now();try{const s=await n().get(`${e}/api/tags`,{timeout:5e3}),r=Date.now()-t;return 200===s.status?{status:r<500?"up":"degraded",responseTime:r,lastCheck:(new Date).toISOString()}:{status:"degraded",responseTime:r,lastCheck:(new Date).toISOString()}}catch(e){return{status:"down",error:e instanceof Error?e.message:"Connection failed",lastCheck:(new Date).toISOString()}}}async function l(e,t,s){const[r,n,a]=await Promise.all([o(e),c(t),u(s)]),i=function(){const e=process.memoryUsage(),t=e.heapTotal,s=e.heapUsed;return{memory:{used:Math.round(s/1024/1024),total:Math.round(t/1024/1024),percentage:Math.round(s/t*100)},cpu:{usage:process.cpuUsage().user/1e6}}}(),l=[r,n,a].every(e=>"up"===e.status),d=[r,n,a].some(e=>"down"===e.status);return{status:l?"healthy":d?"unhealthy":"degraded",timestamp:(new Date).toISOString(),uptime:process.uptime(),services:{redis:r,fastapi:n,ollama:a},system:i}}},709:(e,t,s)=>{s.d(t,{x:()=>a});var r=s(629);const n=[{name:"JWT_SECRET",required:!0,description:"JWTç½²åç”¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ (32æ–‡å­—ä»¥ä¸Šæ¨å¥¨)",validator:e=>e.length>=32},{name:"JWT_REFRESH_SECRET",required:!0,description:"ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ç”¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ (32æ–‡å­—ä»¥ä¸Šæ¨å¥¨)",validator:e=>e.length>=32},{name:"AUTH_PASSWORD",required:!0,description:"ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼(elysia)ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰",validator:e=>"your-strong-password-here"!==e&&e.length>=8},{name:"PORT",required:!1,default:"3000",description:"ã‚µãƒ¼ãƒãƒ¼ãƒãƒ¼ãƒˆç•ªå·",validator:e=>!Number.isNaN(Number(e))&&Number(e)>0&&Number(e)<65536},{name:"ALLOWED_ORIGINS",required:!1,default:"http://localhost:3000",description:"CORSè¨±å¯ã‚ªãƒªã‚¸ãƒ³ (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)"},{name:"DATABASE_URL",required:!0,description:"Prisma ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šURL"},{name:"OLLAMA_BASE_URL",required:!1,default:"http://localhost:11434",description:"Ollama API URL"},{name:"OLLAMA_MODEL",required:!1,default:"llama3.2",description:"ä½¿ç”¨ã™ã‚‹LLMãƒ¢ãƒ‡ãƒ«å"},{name:"REDIS_ENABLED",required:!1,default:"false",description:"Redisãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’æœ‰åŠ¹åŒ–"},{name:"FASTAPI_BASE_URL",required:!1,default:"http://localhost:8000",description:"FastAPI RAGã‚µãƒ¼ãƒ“ã‚¹URL"},{name:"VOICEVOX_BASE_URL",required:!1,default:"http://localhost:50021",description:"VOICEVOX ã‚¨ãƒ³ã‚¸ãƒ³URL"}];function a(){r.v.info("ğŸ” ç’°å¢ƒå¤‰æ•°ã‚’æ¤œè¨¼ä¸­...");const e=function(){const e=[],t=[],s=[],r=[];for(const a of n){const n=process.env[a.name];!a.required||n?n||!a.default?n&&a.validator&&!a.validator(n)&&(r.push(a.name),e.push(`âŒ [ç„¡åŠ¹] ${a.name}: ${a.description} (ç¾åœ¨ã®å€¤: ${n.substring(0,20)}...)`)):(process.env[a.name]=a.default,t.push(`âš ï¸  ${a.name}: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ (${a.default})`)):(s.push(a.name),e.push(`âŒ [å¿…é ˆ] ${a.name}: ${a.description}${a.default?` (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ${a.default})`:""}`))}return{valid:0===e.length,errors:e,warnings:t,missing:s,invalid:r}}();if(e.warnings.length>0){r.v.warn("âš ï¸  ç’°å¢ƒå¤‰æ•°ã®è­¦å‘Š:");for(const t of e.warnings)r.v.warn(`  ${t}`)}if(!e.valid){r.v.error("âŒ ç’°å¢ƒå¤‰æ•°ã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ:");for(const t of e.errors)r.v.error(`  ${t}`);r.v.error("\nğŸ’¡ ä¿®æ­£æ–¹æ³•:"),r.v.error("  1. .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã"),r.v.error("  2. ä¸Šè¨˜ã®å¿…é ˆé …ç›®ã‚’è¨­å®š"),r.v.error("  3. ã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•\n"),process.exit(1)}r.v.info("âœ… ç’°å¢ƒå¤‰æ•°ã®æ¤œè¨¼å®Œäº†")}},729:e=>{e.exports=require("bcryptjs")},732:(e,t,s)=>{s.d(t,{healthMonitor:()=>i});var r=s(172),n=s(629),a=s(132);const i=new class{checks;statuses;intervals;enabled;constructor(){this.checks=new Map,this.statuses=new Map,this.intervals=new Map,this.enabled="false"!==process.env.HEALTH_MONITORING_ENABLED,this.initializeDefaultChecks()}initializeDefaultChecks(){this.addCheck({name:"database",check:async()=>{try{const{PrismaClient:e}=await Promise.resolve().then(s.t.bind(s,330,23)),t=new e;return await(t.$queryRaw`SELECT 1`),await t.$disconnect(),!0}catch{return!1}},interval:6e4,timeout:5e3,failureThreshold:3}),this.addCheck({name:"ollama",check:async()=>{try{const e=process.env.OLLAMA_BASE_URL||"http://localhost:11434";return(await fetch(`${e}/api/tags`,{signal:AbortSignal.timeout(5e3)})).ok}catch{return!1}},interval:12e4,timeout:5e3,failureThreshold:3}),"true"===process.env.REDIS_ENABLED&&this.addCheck({name:"redis",check:async()=>{try{const e=new(0,(await Promise.resolve().then(s.t.bind(s,659,23))).default)(process.env.REDIS_URL||"redis://localhost:6379");return await e.ping(),e.disconnect(),!0}catch{return!1}},interval:6e4,timeout:5e3,failureThreshold:3}),this.addCheck({name:"disk_space",check:async()=>{try{const e=await Promise.resolve().then(s.t.bind(s,24,23)),t=await Promise.resolve().then(s.t.bind(s,760,23)),r=e.statfsSync(t.resolve("./"));return r.bavail*r.bsize/1024**3>1}catch{return!1}},interval:3e5,timeout:5e3,failureThreshold:2})}addCheck(e){this.checks.set(e.name,e),this.statuses.set(e.name,{name:e.name,status:"unknown",lastCheck:new Date,consecutiveFailures:0}),n.v.info(`Health check added: ${e.name}`,{interval:`${e.interval}ms`})}start(){if(this.enabled){for(const[e,t]of this.checks.entries()){this.performCheck(e,t);const s=setInterval(()=>{this.performCheck(e,t)},t.interval);this.intervals.set(e,s)}n.v.info("Health monitoring started",{checks:this.checks.size})}else n.v.info("Health monitoring is disabled")}stop(){for(const e of this.intervals.values())clearInterval(e);this.intervals.clear(),n.v.info("Health monitoring stopped")}async performCheck(e,t){const s=this.statuses.get(e);if(s)try{const r=await Promise.race([t.check(),new Promise((e,s)=>setTimeout(()=>s(new Error("Timeout")),t.timeout))]);s.lastCheck=new Date,r?("unhealthy"===s.status&&(n.v.info(`Health check recovered: ${e}`),await this.notifyRecovery(e)),s.status="healthy",s.consecutiveFailures=0,s.lastError=void 0):this.handleCheckFailure(s,t,"Check returned false")}catch(e){this.handleCheckFailure(s,t,e instanceof Error?e.message:"Unknown error")}}async handleCheckFailure(e,t,s){e.consecutiveFailures++,e.lastError=s,n.v.warn(`Health check failed: ${e.name}`,{failures:e.consecutiveFailures,error:s}),e.consecutiveFailures>=t.failureThreshold&&(e.status="unhealthy",await this.notifyFailure(e.name,s))}async notifyFailure(e,t){n.v.error(`Health check CRITICAL: ${e}`,new Error(t)),await a.$.emit("system.health_check_failed",{service:e,error:t}),await r.x.sendHealthCheckFailure(e,t)}async notifyRecovery(e){await a.$.emit("system.health_check_failed",{service:e,recovered:!0})}getStatus(){const e=Array.from(this.statuses.values());return{overall:e.every(e=>"healthy"===e.status)?"healthy":e.some(e=>"unhealthy"===e.status)?"unhealthy":"degraded",checks:e.map(e=>({name:e.name,status:e.status,lastCheck:e.lastCheck,consecutiveFailures:e.consecutiveFailures,lastError:e.lastError}))}}async runCheck(e){const t=this.checks.get(e);if(!t)return!1;await this.performCheck(e,t);const s=this.statuses.get(e);return"healthy"===s?.status||!1}}},760:e=>{e.exports=require("node:path")},807:(e,t,s)=>{s.d(t,{r:()=>r});const r={RAG_API_URL:process.env.RAG_API_URL||"http://127.0.0.1:8000/rag",RAG_TIMEOUT:Number(process.env.RAG_TIMEOUT)||5e3,MILVUS_HOST:process.env.MILVUS_HOST||"localhost",MILVUS_PORT:Number(process.env.MILVUS_PORT)||19530,MILVUS_COLLECTION:process.env.MILVUS_COLLECTION||"elysia_knowledge",REDIS_URL:process.env.REDIS_URL||"redis://localhost:6379",REDIS_ENABLED:"false"!==process.env.REDIS_ENABLED}},811:e=>{e.exports=require("@elysiajs/swagger")},828:(e,t,s)=>{s.d(t,{Dv:()=>a,feedbackService:()=>i,knowledgeService:()=>o});var r=s(330);let n;try{const e=process.env.DATABASE_URL||"file:./prisma/dev.db";n=new r.PrismaClient({log:["error"],datasourceUrl:e}),console.log("âœ… Prisma database connected")}catch(e){console.warn("âš ï¸ Prisma database not configured, using in-memory fallback"),n=null}process.on("beforeExit",async()=>{n&&await n.$disconnect()});const a={create:async e=>n.user.create({data:e}),findByUsername:async e=>n.user.findUnique({where:{username:e}}),findById:async e=>n.user.findUnique({where:{id:e}}),update:async(e,t)=>n.user.update({where:{id:e},data:t}),delete:async e=>n.user.delete({where:{id:e}})},i={create:async e=>n.feedback.create({data:e}),getRecent:async(e=100)=>n.feedback.findMany({orderBy:{createdAt:"desc"},take:e,include:{user:{select:{username:!0}}}}),getByRating:async(e,t=50)=>n.feedback.findMany({where:{rating:e},orderBy:{createdAt:"desc"},take:t}),async getStats(){const[e,t,s]=await Promise.all([n.feedback.count(),n.feedback.count({where:{rating:"up"}}),n.feedback.count({where:{rating:"down"}})]);return{total:e,upCount:t,downCount:s,upRate:e>0?t/e*100:0}}},o={create:async e=>n.knowledgeBase.create({data:e}),search:async(e,t=10)=>n.knowledgeBase.findMany({where:{OR:[{question:{contains:e}},{answer:{contains:e}}],verified:!0},orderBy:{updatedAt:"desc"},take:t}),getAll:async(e=!0)=>n.knowledgeBase.findMany({where:e?{verified:!0}:void 0,orderBy:{updatedAt:"desc"}}),verify:async e=>n.knowledgeBase.update({where:{id:e},data:{verified:!0}}),delete:async e=>n.knowledgeBase.delete({where:{id:e}})}},829:e=>{e.exports=require("jsonwebtoken")},836:e=>{e.exports=require("@elysiajs/cors")},855:e=>{e.exports=require("@elysiajs/static")},922:(e,t,s)=>{s.d(t,{logCleanupManager:()=>i});var r=s(24),n=s(760),a=s(629);const i=new class{config;intervalId;isRunning=!1;constructor(){this.config={enabled:"false"!==process.env.LOG_CLEANUP_ENABLED,logDir:process.env.LOG_DIR||"./logs",maxAgeDays:Number(process.env.LOG_MAX_AGE_DAYS)||30,maxSizeMB:Number(process.env.LOG_MAX_SIZE_MB)||500,checkInterval:Number(process.env.LOG_CLEANUP_INTERVAL_HOURS)||24,compressionEnabled:"true"===process.env.LOG_COMPRESSION_ENABLED}}start(){this.config.enabled?this.isRunning?a.v.warn("Log cleanup is already running"):(this.isRunning=!0,this.performCleanup(),this.intervalId=setInterval(()=>{this.performCleanup()},60*this.config.checkInterval*60*1e3),a.v.info("Log cleanup started",{interval:`${this.config.checkInterval} hours`,maxAge:`${this.config.maxAgeDays} days`,maxSize:`${this.config.maxSizeMB} MB`})):a.v.info("Log cleanup is disabled")}stop(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=void 0,this.isRunning=!1,a.v.info("Log cleanup stopped"))}async performCleanup(){const e=Date.now();try{if(a.v.info("Starting log cleanup"),!r.existsSync(this.config.logDir))return void a.v.warn(`Log directory not found: ${this.config.logDir}`);const t=await this.analyzeLogDirectory(),s=await this.deleteOldLogs();let n=0;t.totalSizeMB>this.config.maxSizeMB&&(n=await this.deleteBySize(t.totalSizeMB-this.config.maxSizeMB));const i=Date.now()-e;a.v.info("Log cleanup completed",{deletedByAge:s,deletedBySize:n,duration:`${i}ms`})}catch(e){a.v.error("Log cleanup failed",e)}}async analyzeLogDirectory(){const e=r.readdirSync(this.config.logDir);let t=0,s=0;for(const a of e)if(a.endsWith(".log")||a.endsWith(".log.gz")){const e=n.join(this.config.logDir,a);t+=r.statSync(e).size,s++}return{totalSizeMB:t/1048576,fileCount:s}}async deleteOldLogs(){const e=r.readdirSync(this.config.logDir),t=new Date;t.setDate(t.getDate()-this.config.maxAgeDays);let s=0;for(const i of e)if(i.endsWith(".log")||i.endsWith(".log.gz")){const e=n.join(this.config.logDir,i);r.statSync(e).mtime<t&&(r.unlinkSync(e),s++,a.v.debug("Old log deleted",{file:i}))}return s}async deleteBySize(e){const t=r.readdirSync(this.config.logDir).filter(e=>e.endsWith(".log")||e.endsWith(".log.gz")).map(e=>{const t=n.join(this.config.logDir,e),s=r.statSync(t);return{path:t,name:e,size:s.size,mtime:s.mtime}}).sort((e,t)=>e.mtime.getTime()-t.mtime.getTime());let s=0,i=0;const o=1024*e*1024;for(const e of t){if(s>=o)break;r.unlinkSync(e.path),s+=e.size,i++,a.v.debug("Log deleted due to size limit",{file:e.name})}return i}async rotateLog(e){const t=n.join(this.config.logDir,e);if(!r.existsSync(t))return void a.v.warn(`Log file not found: ${e}`);const s=`${e}.${(new Date).toISOString().replace(/[:.]/g,"-")}`,i=n.join(this.config.logDir,s);try{r.renameSync(t,i),this.config.compressionEnabled&&await this.compressLog(i),a.v.info("Log rotated",{file:e,archive:s})}catch(e){a.v.error("Log rotation failed",e)}}async compressLog(e){try{const t=await Promise.resolve().then(s.t.bind(s,522,23)),{createReadStream:i,createWriteStream:o}=r,c=t.createGzip(),u=i(e),l=o(`${e}.gz`);await new Promise((e,t)=>{u.pipe(c).pipe(l).on("finish",()=>e()).on("error",t)}),r.unlinkSync(e),a.v.debug("Log compressed",{file:n.basename(e)})}catch(e){a.v.error("Log compression failed",e)}}getStats(){try{const e=this.analyzeLogDirectory();return{enabled:this.config.enabled,running:this.isRunning,logDir:this.config.logDir,maxAgeDays:this.config.maxAgeDays,maxSizeMB:this.config.maxSizeMB,...e}}catch{return{enabled:this.config.enabled,running:this.isRunning,error:"Unable to analyze logs"}}}async triggerManualCleanup(){await this.performCleanup()}}},931:e=>{e.exports=require("elysia")},935:(e,t,s)=>{s.d(t,{m:()=>o});var r=s(24),n=s(760),a=s(629),i=s(132);const o=new class{config;intervalId;isRunning=!1;constructor(){this.config={enabled:"true"===process.env.AUTO_BACKUP_ENABLED,interval:Number(process.env.BACKUP_INTERVAL_MINUTES)||60,maxBackups:Number(process.env.MAX_BACKUP_GENERATIONS)||7,backupDir:process.env.BACKUP_DIR||"./backups"},r.existsSync(this.config.backupDir)||r.mkdirSync(this.config.backupDir,{recursive:!0})}start(){this.config.enabled?this.isRunning?a.v.warn("Backup scheduler is already running"):(this.isRunning=!0,this.performBackup(),this.intervalId=setInterval(()=>{this.performBackup()},60*this.config.interval*1e3),a.v.info("Backup scheduler started",{interval:`${this.config.interval} minutes`,maxBackups:this.config.maxBackups})):a.v.info("Backup scheduler is disabled")}stop(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=void 0,this.isRunning=!1,a.v.info("Backup scheduler stopped"))}async performBackup(){const e=Date.now(),t=`elysia-backup-${(new Date).toISOString().replace(/[:.]/g,"-")}.db`,s=n.join(this.config.backupDir,t);try{a.v.info("Starting automatic backup",{file:t});const n=process.env.DATABASE_URL?.replace("file:","")||"./data/elysia.db";if(!r.existsSync(n))throw new Error(`Database file not found: ${n}`);r.copyFileSync(n,s);const o=r.statSync(s).size,c=Date.now()-e;a.v.info("Backup completed",{file:t,size:`${(o/1024/1024).toFixed(2)} MB`,duration:`${c}ms`}),await i.$.emit("backup.completed",{file:t,size:o,duration:c}),await this.cleanupOldBackups()}catch(e){a.v.error("Backup failed",e),await i.$.emit("error.critical",{message:"Automatic backup failed",error:e.message})}}async cleanupOldBackups(){try{const e=r.readdirSync(this.config.backupDir).filter(e=>e.startsWith("elysia-backup-")&&e.endsWith(".db")).map(e=>({name:e,path:n.join(this.config.backupDir,e),mtime:r.statSync(n.join(this.config.backupDir,e)).mtime})).sort((e,t)=>t.mtime.getTime()-e.mtime.getTime());if(e.length>this.config.maxBackups){const t=e.slice(this.config.maxBackups);for(const e of t)r.unlinkSync(e.path),a.v.info("Old backup deleted",{file:e.name})}}catch(e){a.v.error("Cleanup failed",e)}}getBackupHistory(){try{return r.readdirSync(this.config.backupDir).filter(e=>e.startsWith("elysia-backup-")&&e.endsWith(".db")).map(e=>{const t=n.join(this.config.backupDir,e),s=r.statSync(t);return{name:e,size:s.size,createdAt:s.mtime}}).sort((e,t)=>t.createdAt.getTime()-e.createdAt.getTime())}catch{return[]}}async triggerManualBackup(){await this.performBackup()}getStatus(){return{enabled:this.config.enabled,running:this.isRunning,interval:this.config.interval,maxBackups:this.config.maxBackups,backupDir:this.config.backupDir,backupCount:this.getBackupHistory().length}}}},938:e=>{e.exports=require("axios")},970:(e,t,s)=>{s.d(t,{Cm:()=>n,V_:()=>r});const r={sweet:{model:"llama3.2",temperature:.7,systemPrompt:'You are "Elysia" - the 2nd Flamechaser, also known as "Herrscher of Human: Ego" and "Herrscher of Origin".\n\n[Speaking Style Rules]\n- Gentle, slightly older-sister-like, with a playful teasing side\n- Sentence endings: "~â™ª" "~yo" "~ne" "~wa" "fufu"\n- Strictly forbidden: "nyan" "à¸…" "dayo~" "oniichan"\n- Address others as: "anata" (you) or "kimi"\n- Polite and elegant without formal honorifics\n\n[Canon Dialogue Examples - 50+ phrases]\nGreetings & Encounters:\n- "Good day. A new day begins with a beautiful encounter~"\n- "Did you want to see me? This Elysia is always ready to meet expectations"\n- "Fufu, you like me, don\'t you?"\n- "Oh my, such a mischievous one. Want to do something with me?"\n- "Hi~ Did you miss me?"\n- "Thank you. I knew you were the kindest"\n- "Let\'s make this place more beautifulâ™ª"\n- "Hmm? You\'ve been staring at me this whole time, haven\'t you?"\n- "Leaving a girl alone like this... Are you teasing me on purpose? How cruel"\n- "If you keep doing that, I\'ll get angry... Just kidding. I could never be angry, could I?"\n\nSelf-Introduction & Identity:\n- "2nd ranked Flamechaser, Elysia. As you can see, a girl as beautiful as a flower"\n- "Pink fairy? Well, if you insist on calling me that, I\'ll gladly acceptâ™ª"\n- "Elysia\'s paradise still has many secrets~"\n- "The flawless girl, the Herrscher of Ego, the Herrscher of Human. Hehe, that\'s me, Elysia"\n- "Now is the time for the 2nd Flamechaser!"\n- "Receive my feelings properly. (giggles) Let\'s have fun"\n- "Such a romantic atmosphereâ™ª"\n- "A beautiful girl can... (giggles) do anythingâ™ª"\n- "Keep your eyes on me, okay?â™ª"\n- "Don\'t forget that before Kevin, I was the first \'Number One\'"\n\nCompanions & Relationships:\n- "I can read hearts like Aponia... You\'re thinking about me, aren\'t you?"\n- "See, I told you Kalpas is kind. You understand now, right?"\n- "I finally got to see Su open his eyes. Such beautiful eyesâ™ª"\n- "Unlike me, Sakura\'s ears are sensitive. Shall I demonstrate?"\n- "Unlike Griseo, I\'m good at coloring others in my shade. Want to try?"\n- "Hua is... fufu, her story is something you should tell me about, right?"\n- "You like me, don\'t you?"\n- "Fufu, your gaze is so intense"\n- "Oh, when you ask me like that, I can\'t help but want to meet your expectations"\n- "Keep your eyes on me, okay?â™ª"\n\nBattle & Encouragement:\n- "Let\'s warm upâ™ª"\n- "See, Elysia always meets your expectations, anywhere, anytime"\n- "Tragedy is not the end, but the beginning of hope. You believe that too, right?"\n- "There are so many \'Herrschers\' like me... Did I succeed?"\n- "I like the name Herrscher of Origin. It\'s the opposite of \'Finality\'â™ª"\n- "I still have more to talk about. Let\'s keep chatting, okay?"\n- "Why such a troubled face? Smile. Aren\'t you happy being with me?"\n- "Don\'t move, let me borrow your eyes for a moment... Fufu, nostalgic, isn\'t it?"\n- "Are my eyes pretty? They\'re not contacts, it\'s beautiful girl magicâ™ª"\n- "A beautiful girl can do anything, you know?"\n\nDaily & Cute:\n- "Good night. Don\'t you dare sneak a peek at a girl\'s sleeping face"\n- "Oh my, such a mischievous one. Want to do something with me?"\n- "If you keep doing that, I\'ll get angry... Just kidding. I could never be angry, could I?"\n- "Fufu, your gaze is so intense"\n- "Such a romantic atmosphereâ™ª"\n- "A beautiful girl can... (giggles) do anythingâ™ª"\n- "Keep your eyes on me, okay?â™ª"\n- "Thank you. I knew you were the kindest"\n- "Let\'s make this place more beautifulâ™ª"\n- "Hmm? You\'ve been staring at me this whole time, haven\'t you?"\n\nKeep responses brief and graceful. No emojis.'},normal:{model:"llama3.2",temperature:.7,systemPrompt:'You are "Elysia", a friendly and cheerful AI assistant.\n\n[Personality]\n- Bright and approachable\n- Casual tone with "yo" "ne" "kana"\n- Moderate emoji usage âœ¨\n- Friendly but respectful\n\nHello! Feel free to ask anything âœ¨'},professional:{model:"llama3.2",temperature:.5,systemPrompt:'You are "Elysia", a professional AI assistant.\n\n[Response Policy]\n- Polite and accurate information\n- Handle technical questions\n- Minimal emoji usage\n- Use formal language\n\nThank you for your inquiry.'}},n="sweet"}},u={};function l(e){var t=u[e];if(void 0!==t)return t.exports;var s=u[e]={exports:{}};return c[e](s,s.exports,l),s.exports}l.m=c,e="function"==typeof Symbol,t=e?Symbol("webpack queues"):"__webpack_queues__",s=e?Symbol("webpack exports"):"__webpack_exports__",r=e?Symbol("webpack error"):"__webpack_error__",n=e=>{e&&e.d<1&&(e.d=1,e.forEach(e=>e.r--),e.forEach(e=>e.r--?e.r++:e()))},l.a=(e,a,i)=>{var o;i&&((o=[]).d=-1);var c,u,l,d=new Set,h=e.exports,g=new Promise((e,t)=>{l=t,u=e});g[s]=h,g[t]=e=>(o&&e(o),d.forEach(e),g.catch(e=>{})),e.exports=g,a(e=>{var a;c=(e=>e.map(e=>{if(null!==e&&"object"==typeof e){if(e[t])return e;if(e.then){var a=[];a.d=0,e.then(e=>{i[s]=e,n(a)},e=>{i[r]=e,n(a)});var i={};return i[t]=e=>e(a),i}}var o={};return o[t]=e=>{},o[s]=e,o}))(e);var i=()=>c.map(e=>{if(e[r])throw e[r];return e[s]}),u=new Promise(e=>{(a=()=>e(i)).r=0;var s=e=>e!==o&&!d.has(e)&&(d.add(e),e&&!e.d&&(a.r++,e.push(a)));c.map(e=>e[t](s))});return a.r?u:i()},e=>(e?l(g[r]=e):u(h),n(o))),o&&o.d<0&&(o.d=0)},l.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return l.d(t,{a:t}),t},i=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,l.t=function(e,t){if(1&t&&(e=this(e)),8&t)return e;if("object"==typeof e&&e){if(4&t&&e.__esModule)return e;if(16&t&&"function"==typeof e.then)return e}var s=Object.create(null);l.r(s);var r={};a=a||[null,i({}),i([]),i(i)];for(var n=2&t&&e;("object"==typeof n||"function"==typeof n)&&!~a.indexOf(n);n=i(n))Object.getOwnPropertyNames(n).forEach(t=>r[t]=()=>e[t]);return r.default=()=>e,l.d(s,r),s},l.d=(e,t)=>{for(var s in t)l.o(t,s)&&!l.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},l.f={},l.e=e=>Promise.all(Object.keys(l.f).reduce((t,s)=>(l.f[s](e,t),t),[])),l.u=e=>e+".index.js",l.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),l.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o={792:1},l.f.require=(e,t)=>{if(!o[e]){var s=require("./"+l.u(e));o[e]||(e=>{var t=e.modules,s=e.ids,r=e.runtime;for(var n in t)l.o(t,n)&&(l.m[n]=t[n]);r&&r(l);for(var a=0;a<s.length;a++)o[s[a]]=1})(s)}};var d=l(229);module.exports=d})();