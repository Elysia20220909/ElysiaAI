#!/bin/bash

# Elysia AI - Vulnerability Scanning & Assessment
# „Çª„Ç≠„É•„É™„ÉÜ„Ç£ËÑÜÂº±ÊÄß„Çπ„Ç≠„É£„É≥„Å®Ë©ï‰æ°

set -e

echo "=========================================="
echo "üîç Vulnerability Scanning Setup"
echo "=========================================="

if [[ $EUID -ne 0 ]]; then
   echo "This script must be run as root"
   exit 1
fi

echo ""
echo "=========================================="
echo "[1/5] Installing Vulnerability Scanners..."
echo "=========================================="

# „ÉÑ„Éº„É´„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´
SCANNERS=("clamav" "clamav-daemon" "chkrootkit" "rkhunter" "nikto" "nmap")

for scanner in "${SCANNERS[@]}"; do
    if ! command -v ${scanner%%-*} &> /dev/null; then
        echo "Installing $scanner..."
        apt-get install -y $scanner > /dev/null 2>&1
    fi
done

echo "‚úì Vulnerability scanners installed"

echo ""
echo "=========================================="
echo "[2/5] Configuring ClamAV Antivirus..."
echo "=========================================="

# ClamAV „Ç∑„Ç∞„Éç„ÉÅ„É£Êõ¥Êñ∞
freshclam || true

# ClamAV „Çπ„Ç≠„É£„É≥„Çπ„ÇØ„É™„Éó„Éà
CLAMAV_SCRIPT="/opt/scan-clamav.sh"

cat > "$CLAMAV_SCRIPT" << 'CLAMAV_SCRIPT_EOF'
#!/bin/bash

# ClamAV Antivirus Scan Script

SCAN_DIR="/opt/elysia-ai"
SCAN_REPORT="/var/log/elysia/scan-clamav-$(date +%Y%m%d-%H%M%S).log"
mkdir -p "$(dirname "$SCAN_REPORT")"

echo "=========================================="
echo "ü¶† ClamAV Antivirus Scan"
echo "Started: $(date)"
echo "=========================================="

# „Ç¶„Ç§„É´„Çπ„Çπ„Ç≠„É£„É≥ÂÆüË°å
clamscan -r -i "$SCAN_DIR" --log="$SCAN_REPORT"

# ÁµêÊûúÁ¢∫Ë™ç
if grep -q "Infected files: 0" "$SCAN_REPORT"; then
    echo "‚úì No viruses detected"
else
    echo "‚ö†Ô∏è  Infected files detected!"
    grep "Infected files:" "$SCAN_REPORT"
fi

echo ""
echo "Report: $SCAN_REPORT"

CLAMAV_SCRIPT_EOF

chmod +x "$CLAMAV_SCRIPT"
echo "‚úì ClamAV scan script: $CLAMAV_SCRIPT"

echo ""
echo "=========================================="
echo "[3/5] Setting Up Rootkit Detection..."
echo "=========================================="

# Chkrootkit „Çπ„ÇØ„É™„Éó„Éà
CHKROOTKIT_SCRIPT="/opt/scan-rootkits.sh"

cat > "$CHKROOTKIT_SCRIPT" << 'CHKROOTKIT_SCRIPT_EOF'
#!/bin/bash

# Rootkit Detection Script

SCAN_REPORT="/var/log/elysia/scan-rootkit-$(date +%Y%m%d-%H%M%S).log"
mkdir -p "$(dirname "$SCAN_REPORT")"

echo "=========================================="
echo "üîê Rootkit Detection Scan"
echo "Started: $(date)"
echo "=========================================="

# Chkrootkit „Çπ„Ç≠„É£„É≥
chkrootkit > "$SCAN_REPORT" 2>&1

# RKHunter „Çπ„Ç≠„É£„É≥
rkhunter --update > /dev/null 2>&1 || true
rkhunter --check --skip-warnings --reportwaits=0 >> "$SCAN_REPORT" 2>&1

# ÁµêÊûúÁ¢∫Ë™ç
if grep -q "INFECTED" "$SCAN_REPORT"; then
    echo "‚ö†Ô∏è  Potential rootkit detected!"
else
    echo "‚úì No rootkits detected"
fi

echo ""
echo "Report: $SCAN_REPORT"

CHKROOTKIT_SCRIPT_EOF

chmod +x "$CHKROOTKIT_SCRIPT"
echo "‚úì Rootkit detection script: $CHKROOTKIT_SCRIPT"

echo ""
echo "=========================================="
echo "[4/5] Configuring Package Vulnerability Scanning..."
echo "=========================================="

# npm/Node.js „Éë„ÉÉ„Ç±„Éº„Ç∏ËÑÜÂº±ÊÄß„Çπ„Ç≠„É£„É≥
if command -v npm &> /dev/null; then
    echo "Installing npm audit..."
    npm install -g npm-audit-resolver > /dev/null 2>&1
fi

# OS„Éë„ÉÉ„Ç±„Éº„Ç∏ËÑÜÂº±ÊÄß„Çπ„Ç≠„É£„É≥
if ! command -v debsecan &> /dev/null; then
    apt-get install -y debian-goodies > /dev/null 2>&1 || true
fi

# ËÑÜÂº±ÊÄß„Çπ„Ç≠„É£„É≥„Çπ„ÇØ„É™„Éó„Éà
VULN_SCRIPT="/opt/scan-vulnerabilities.sh"

cat > "$VULN_SCRIPT" << 'VULN_SCRIPT_EOF'
#!/bin/bash

# Vulnerability Assessment Script

SCAN_REPORT="/var/log/elysia/vulnerability-scan-$(date +%Y%m%d-%H%M%S).log"
mkdir -p "$(dirname "$SCAN_REPORT")"

{
    echo "=========================================="
    echo "üîç Vulnerability Assessment Report"
    echo "Generated: $(date)"
    echo "=========================================="
    echo ""

    # ============================================
    # 1. OS Package Vulnerabilities
    # ============================================
    echo "1. OS PACKAGE VULNERABILITIES"
    echo "=========================================="

    apt list --upgradable 2>/dev/null | grep -i security | wc -l | {
        read count
        echo "Security updates available: $count"
    }

    echo ""

    # ============================================
    # 2. Node.js Package Vulnerabilities
    # ============================================
    if [ -f "/opt/elysia-ai/package.json" ]; then
        echo "2. NODE.JS PACKAGE VULNERABILITIES"
        echo "=========================================="

        cd /opt/elysia-ai
        npm audit 2>/dev/null || echo "npm audit not available"

        echo ""
    fi

    # ============================================
    # 3. Network Security
    # ============================================
    echo "3. NETWORK SECURITY SCAN"
    echo "=========================================="

    echo "Open ports:"
    ss -tlnp 2>/dev/null | grep LISTEN || netstat -tlnp 2>/dev/null | grep LISTEN

    echo ""

    # ============================================
    # 4. File Permissions
    # ============================================
    echo "4. FILE PERMISSION AUDIT"
    echo "=========================================="

    echo "World-writable files in /opt/elysia-ai:"
    find /opt/elysia-ai -type f -perm -002 2>/dev/null | head -10 || echo "None found"

    echo ""
    echo "SUID/SGID files:"
    find /opt/elysia-ai -type f \( -perm -4000 -o -perm -2000 \) 2>/dev/null | head -10 || echo "None found"

    echo ""

    # ============================================
    # 5. SSL Certificate Validation
    # ============================================
    echo "5. SSL CERTIFICATE STATUS"
    echo "=========================================="

    if [ -d "/etc/letsencrypt/live" ]; then
        for cert in /etc/letsencrypt/live/*/cert.pem; do
            if [ -f "$cert" ]; then
                echo "Certificate: $cert"
                openssl x509 -enddate -noout -in "$cert"
            fi
        done
    else
        echo "No SSL certificates found"
    fi

    echo ""
    echo "=========================================="
    echo "‚úì Vulnerability scan completed"
    echo "=========================================="

} | tee "$SCAN_REPORT"

echo ""
echo "Full report: $SCAN_REPORT"

VULN_SCRIPT_EOF

chmod +x "$VULN_SCRIPT"
echo "‚úì Vulnerability scan script: $VULN_SCRIPT"

echo ""
echo "=========================================="
echo "[5/5] Scheduling Automated Scans..."
echo "=========================================="

# ÂÆöÊúü„Çπ„Ç≠„É£„É≥„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É™„É≥„Ç∞
CLAMAV_CRON="0 3 * * * $CLAMAV_SCRIPT >> /var/log/elysia/cron-scan.log 2>&1"
ROOTKIT_CRON="0 4 * * 0 $CHKROOTKIT_SCRIPT >> /var/log/elysia/cron-scan.log 2>&1"
VULN_CRON="0 5 * * * $VULN_SCRIPT >> /var/log/elysia/cron-scan.log 2>&1"

# Cron jobs ËøΩÂä†
for cron_job in "$CLAMAV_CRON" "$ROOTKIT_CRON" "$VULN_CRON"; do
    if ! crontab -l 2>/dev/null | grep -q "$(echo $cron_job | cut -d' ' -f6)"; then
        (crontab -l 2>/dev/null; echo "$cron_job") | crontab -
    fi
done

echo "‚úì Automated scans scheduled:"
echo "  - ClamAV scan: Daily at 3:00 AM"
echo "  - Rootkit scan: Weekly (Sunday 4:00 AM)"
echo "  - Vulnerability scan: Daily at 5:00 AM"

echo ""
echo "=========================================="
echo "‚úì Vulnerability Scanning Setup Complete!"
echo "=========================================="

echo ""
echo "üîç Scanning Tools Installed:"
echo "  - ClamAV (Antivirus)"
echo "  - Chkrootkit (Rootkit detection)"
echo "  - RKHunter (Rootkit hunter)"
echo "  - npm audit (Node.js packages)"
echo "  - Nikto (Web vulnerability scanner)"
echo "  - Nmap (Network scanner)"

echo ""
echo "üìä Scan Scripts:"
echo "  ClamAV: $CLAMAV_SCRIPT"
echo "  Rootkit: $CHKROOTKIT_SCRIPT"
echo "  Vulnerability: $VULN_SCRIPT"

echo ""
echo "üîß Useful Commands:"
echo "  Manual ClamAV scan: $CLAMAV_SCRIPT"
echo "  Manual rootkit scan: $CHKROOTKIT_SCRIPT"
echo "  Manual vulnerability scan: $VULN_SCRIPT"
echo "  View scan logs: tail -f /var/log/elysia/scan-*.log"
echo "  Update ClamAV: freshclam"
echo "  Update RKHunter: rkhunter --update"

echo ""
echo "üìã Scan Schedule:"
echo "  ClamAV: 3:00 AM daily"
echo "  Rootkit: 4:00 AM every Sunday"
echo "  Vulnerabilities: 5:00 AM daily"

echo ""
echo "‚ö†Ô∏è  Important:"
echo "  1. Keep virus definitions updated: freshclam --daemon"
echo "  2. Review scan reports regularly"
echo "  3. Act on detected vulnerabilities immediately"
echo "  4. Keep all tools and definitions current"
echo "  5. Test recovery procedures for detected issues"
